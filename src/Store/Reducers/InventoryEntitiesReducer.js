import { selectRows } from './reducersHelper';
import * as ActionTypes from '../ActionTypes';
import { DEFAULT_PAGE_SIZE } from '../../Helpers/constants';

export const initialState = {
    columns: [],
    rows: [],
    entities: [],
    loaded: false,
    tagsLoaded: false,
    allTagsLoaded: false,
    invConfig: {},
    sortBy: {
        key: 'updated',
        direction: 'desc'
    },
    page: 1,
    perPage: DEFAULT_PAGE_SIZE,
    selectedRows: [],
    selectedRowsCount: 0
};

function modifyInventory(columns, state, action) {
    if (!state.selectedRows) {
        state.selectedRows = [];
    }

    if (!state.sortBy) {
        state.sortBy = {
            key: 'updated',
            direction: 'desc'
        };
    }

    if (state.loaded) {
        return {
            ...state,
            columns,
            rows: state.rows.map(row => ({
                ...row,
                selected: state.selectedRows.some(selectedRow => selectedRow.id === row.id) || false
            })),
            meta: action.payload.meta
        };
    }

    return state;
}

export const inventoryEntitiesReducer = (columns) => (state = initialState, action) => {
    let newState = { ...state };

    switch (action.type) {
        case ActionTypes.LOAD_ENTITIES + '_FULFILLED':
            return modifyInventory(columns, newState, action);
        case ActionTypes.SELECT_ENTITY:
            return selectRows(newState, action, action.selecting);
        case ActionTypes.EXPAND_ROW:
            return {
                ...newState,
                rows: newState.rows.map(row => ({
                    ...row,
                    isOpen: row.id === action.payload.id ? action.payload.isOpen : row.isOpen
                }))
            };
        case ActionTypes.CLEAR_INVENTORY_STORE:
            return initialState;
        default:
            return newState;
    }
};
