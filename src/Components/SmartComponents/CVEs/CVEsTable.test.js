import CVEsTable from './CVEsTable';
import { VULNERABILITIES_HEADER } from '../../../Helpers/constants';
import { CVETableContext } from './CVEs';
import { createCveListByAccount } from '../../../Helpers/VulnerabilityHelper';
import { handleSortColumn } from '../../../Helpers/MiscHelper';
import TestWrapper from '../../../Utilities/TestWrapper';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import '@testing-library/jest-dom';

jest.mock('../../../Helpers/MiscHelper', () => ({
    ...(jest.requireActual('../../../Helpers/MiscHelper')),
    handleSortColumn: jest.fn()
}));

const mockContext = {
    cves: createCveListByAccount({ payload: {
        isLoading: false,
        meta: {
            test: 'test'
        },
        data: [
            {
                type: 'cve',
                id: 'CVE-2019-6454',
                attributes: {
                    business_risk: "Not Defined",
                    business_risk_id: 0,
                    business_risk_text: null,
                    cve_status_id: 2,
                    cve_status_text: "testhello",
                    cvss2_score: null,
                    cvss3_score: "6.500",
                    description: "A new domain bypass",
                    impact: "Moderate",
                    public_date: "2020-06-09T17:00:00+00:00",
                    reporter: 1,
                    rule: null,
                    status: "On-Hold",
                    status_id: 2,
                    status_text: "testhello",
                    synopsis: "CVE-2020-0543",
                    systems_affected: 1,
                    rule: 'testRule'
                }
            }
        ]
    } }, VULNERABILITIES_HEADER, {}),
    params: {},
    selectedCves: [{ id: 'CVE-2019-6454' }],
    expandedRows: ['CVE-2019-6454'],
    isAllExpanded: false,
    methods: {
        apply: jest.fn(),
        downloadReport: jest.fn(),
        selectCves: jest.fn(),
        showBusinessRiskModal: jest.fn(),
        showStatusModal: jest.fn(),
        openCves: jest.fn()
    }
};

const props = {
    header: VULNERABILITIES_HEADER,
    canEditStatusOrBusinessRisk: true
}

describe('CVEs: ', () => {
    it('Should display SkeletonTable during load', () => {
        const testContext = { ...mockContext, cves: { isLoading: true, meta: { test: 'test' }, data: [] } };
        render(
            <TestWrapper>
                <CVETableContext.Provider value={testContext}>
                    <CVEsTable {...props} />
                </CVETableContext.Provider>
            </TestWrapper>
        );
        expect(screen.getByRole('grid', { name: 'Loading' })).toBeVisible();
    });

    it('Should handle empty data list and display EmptyCVEList page', () => {
        const testContext = { ...mockContext, cves: { isLoading: false, meta: { test: 'test' }, data: [] } };
        render(
            <TestWrapper>
                <CVETableContext.Provider value={testContext}>
                    <CVEsTable {...props} />
                </CVETableContext.Provider>
            </TestWrapper>
        );
        expect(screen.getByRole('heading', { name: 'No matching CVEs found' })).toBeVisible();
    });

    it('Should handle empty sort result and display FilterNotFoundForCVE page', () => {
        const testContext = { ...mockContext, cves: { isLoading: false, meta: { filter: 'test' }, data: [] } };
        render(
            <TestWrapper>
                <CVETableContext.Provider value={testContext}>
                    <CVEsTable {...props} />
                </CVETableContext.Provider>
            </TestWrapper>
        );

        expect(screen.getByRole('heading', { name: 'No matching CVEs found' })).toBeVisible();
    });

    it('Should handle empty list when entity prop is set and display EmptyCVEListForSystem page', () => {
        const testContext = { ...mockContext, cves: { isLoading: false, meta: {}, data: [] } };
        render(
            <TestWrapper>
                <CVETableContext.Provider value={testContext}>
                    <CVEsTable {...props} entity={{ test: 'test' }}/>
                </CVETableContext.Provider>
            </TestWrapper>
        );

        expect(screen.getByRole('heading', { name: 'No matching CVEs found' })).toBeVisible();
    });

    it('Should call selectCves ', () => {
        render(
            <TestWrapper>
                <CVETableContext.Provider value={mockContext}>
                    <CVEsTable {...props} />
                </CVETableContext.Provider>
            </TestWrapper>
        );
        userEvent.click(screen.getByRole('checkbox', {
            name: /select row 0/i
        }));

        expect(mockContext.methods.selectCves).toHaveBeenCalledWith(false, 'CVE-2019-6454');
    });

    it('Should call openCves ', () => {
        render(
            <TestWrapper>
                <CVETableContext.Provider value={mockContext}>
                    <CVEsTable {...props} />
                </CVETableContext.Provider>
            </TestWrapper>
        );

        userEvent.click(screen.getByRole('button', {
            name: /details/i
        }));
        expect(mockContext.methods.openCves).toHaveBeenCalledWith(0);
    });

    it('Should call handleSortColumn ', () => {
        render(
            <TestWrapper>
                <CVETableContext.Provider value={mockContext}>
                    <CVEsTable {...props} />
                </CVETableContext.Provider>
            </TestWrapper>
        );
        userEvent.click(screen.getByRole('button', {
            name: /cve id/i
        }));

        expect(handleSortColumn).toHaveBeenCalledWith(
            2,
            "asc",
            [{ key: 'collapse' }, { key: 'checkbox' }, ...VULNERABILITIES_HEADER],
            mockContext.cves.meta.sort,
            expect.any(Function)
        );
    });
})
