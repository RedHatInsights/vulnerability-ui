import qs from 'query-string';
import propTypes from 'prop-types';
import './SystemsExposedTable.scss';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';
import { withRouter } from 'react-router-dom';
import * as reactRouterDom from 'react-router-dom';
import * as reactCore from '@patternfly/react-core';
import * as reactIcons from '@patternfly/react-icons';
import * as pfReactTable from '@patternfly/react-table';
import { useDispatch, useSelector } from 'react-redux';
import React, { useEffect, useState, useMemo } from 'react';
import CvePairStatusModal from '../Modals/CvePairStatusModal';
import ReducerRegistry from '../../../Utilities/ReducerRegistry';
import { middlewareListener } from '../../../Utilities/ReducerRegistry';
import selectAllCheckbox from '../../../Helpers/selectAllCheckboxHelper';
import { Text, TextContent, TextVariants } from '@patternfly/react-core';
import { systemExposedTableRowActions, createExposedSystemsTable } from '../../../Helpers/CVEHelper';
import { inventoryEntitiesReducer } from '../../../Store/Reducers/InventoryEntitiesReducer';
import DownloadReport from '../../../Helpers/DownloadReport';
import Remediation from '../Remediation/Remediation';
import searchFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SearchFilter';
import securityRuleFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SecurityRuleFilter';
import statusFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/StatusFilter';
import { exportConfig, buildActiveFilters, removeFilters } from '../../../Helpers/TableToolbarHelper';
import {
    selectMultipleEntities,
    fetchAffectedSystemsByCVE,
    fetchCveDetails,
    expandRow,
    changeExposedSystemsParameters
} from '../../../Store/Actions/Actions';
import { SYSTEMS_EXPOSED_HEADER } from '../../../Helpers/constants';
const SystemsExposedTable = (props) => {
    const [InventoryTable, setInventoryTable] = useState(()=> () => <div>Loading...</div>);
    const [StatusModal, setStatusModal] = useState(() => () => null);
    const [selectedHosts, setSelectedHosts] = useState(undefined);
    const inventory = React.createRef();
    const dispatch = useDispatch();

    const affectedSystems = useSelector(({ CVEStore }) => CVEStore.affectedSystemsByCVE);

    const onRefresh = (config) => {
        dispatch(changeExposedSystemsParameters(config));
    };

    const handleSelect = (isChecked, payload) => {
        const selectedHosts = payload ? payload : [];
        setSelectedHosts(selectedHosts);
    };

    const onSelect = (payload) => {
        const newSelected = payload.data.selected ? [payload.data.id, ...(selectedHosts || [])]
            : selectedHosts && selectedHosts.filter(item => item !== payload.data.id);

        handleSelect(false, newSelected);
    };

    // eslint-disable-next-line no-unused-vars
    const [selectListener] = useState(middlewareListener.addNew({
        on: 'SELECT_ENTITY',
        callback: payload => onSelect(payload)
    }));

    const isLoading = useSelector(
        ({ CVEStore }) => CVEStore.affectedSystemsByCVE.isLoading
    );

    const parameters = useSelector(
        ({ CVEStore }) => CVEStore.parameters
    );

    const metadata = useSelector(
        ({ CVEStore }) => CVEStore.affectedSystemsByCVE.payload.meta
    );

    const items = useMemo(() => createExposedSystemsTable({ ...affectedSystems, ...props.cve }), [affectedSystems]);

    useEffect(() => {
        if (inventory.current) {
            dispatch(fetchAffectedSystemsByCVE(props.cve, { ...parameters }));
        }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [parameters, dispatch, props.cve]);

    useEffect(()=>{
        if (selectedHosts) {
            dispatch(selectMultipleEntities(selectedHosts));
        }
    }, [selectedHosts, dispatch]);

    const loadInventory = async () => {
        const { inventoryConnector, mergeWithEntities, mergeWithDetail } = await insights.loadInventory({
            react: React,
            reactRouterDom,
            reactCore,
            reactIcons,
            pfReactTable
        });
        ReducerRegistry.register({
            ...mergeWithEntities(inventoryEntitiesReducer(SYSTEMS_EXPOSED_HEADER)),
            ...mergeWithDetail()
        });

        const { InventoryTable } = inventoryConnector(ReducerRegistry.getStore());
        setInventoryTable(() => InventoryTable);
    };

    useEffect(() => {
        loadInventory();
    }, []);

    // #TODO: can be better. Similar function exists in 2 other places.
    const createUrlParams = allParams => {
        const params = { ...allParams };
        const allowedParams = ['filter', 'page', 'page_size', 'status_id', 'security_rule'];
        Object.keys(allParams).forEach(
            key =>
                (params[key] === undefined || params[key] === '' || !allowedParams.includes(key) || params[key] === false) &&
                delete params[key]
        );
        const queryString = qs.stringify(params);
        props.history.push('?' + queryString);
    };

    const downloadReport = format => {
        let params = [props.cve, { ...parameters }];
        DownloadReport.exec(fetchAffectedSystemsByCVE, params, format, 'systems-exposed');
    };

    const showStatusModal = (cves, inventories) => {
        setStatusModal(
            () => () =>
                <CvePairStatusModal
                    cves={cves}
                    updateRef={() => {
                        onRefresh({ ...parameters });
                        fetchCveDetails(props.cve);
                    }}
                    inventories={ inventories }
                    type={'systemsExposed'}
                />

        );
    };

    const handleRefresh = (config) => {
        if (metadata && metadata.total_items <= config.per_page && inventory.current) {
            inventory.current.onRefreshData({ page: config.page, per_page: config.per_page });
        }

        const { filter, security_rule: securityRule, status_id: statusId } = qs.parse(props.location.search);
        config = {
            page: config.page,
            page_size: config.per_page,
            filter: config.filter === '' ? undefined : (config.filter || filter),
            status_id: config.status_id === '' ? undefined : (config.status_id || statusId),
            security_rule: config.security_rule  === '' ? undefined : (config.security_rule || securityRule)
        };

        onRefresh(config);
        createUrlParams(config);

    };

    const kebabOptions = [
        (!isLoading && (<Remediation systemId={props.cve} selectedCves={selectedHosts} />) || ''),
        {
            label: props.intl.formatMessage(messages.editStatus),
            onClick: () => showStatusModal(
                [props.cveStatusDetails],
                selectedHosts.map(item => ({ id: item })),
                !selectedHosts || selectedHosts.length === 0
            ),
            props: { isDisabled: !selectedHosts || selectedHosts.length === 0 }
        }
    ];

    const selectOptions  = useMemo(() => selectAllCheckbox({
        selectedItems: selectedHosts || [],
        selectorHandler: handleSelect,
        items: items.data && items || { data: [], meta: { total_items: 0 } },
        fetchResource: ops => fetchAffectedSystemsByCVE(props.cve, { ...parameters, ...ops })
    }), [items, selectedHosts, props.cve, parameters]);

    return (
        <React.Fragment>
            <TextContent>
                <Text component={TextVariants.h2}>
                    {props.intl.formatMessage(messages.systemsExposedTableHeader)}
                </Text>
            </TextContent>
            <InventoryTable
                items={items.data}
                key={'inventory'}
                ref={inventory}
                expandable='true'
                onRefresh={handleRefresh}
                page={parameters.page}
                total={metadata.total_items}
                isLoaded = {!isLoading}
                perPage={parameters.page_size }
                hasCheckbox={items && items.length !== 0}
                showActions={items && items.length !== 0}
                exportConfig={exportConfig({ downloadReport })}
                onExpandClick={(_e, _i, isOpen, { id }) => dispatch(expandRow(id, isOpen))}
                actions={systemExposedTableRowActions(showStatusModal, props.cveStatusDetails, selectedHosts)}
                actionsConfig={{
                    actions: kebabOptions,
                    kebabToggleProps: { isDisabled: !selectedHosts || selectedHosts.length === 0 },
                    dropdownProps: { className: 'custom-class' }
                }}
                activeFiltersConfig={{
                    filters: buildActiveFilters({ ...parameters,
                        security_rule: parameters.security_rule !== '0' && parameters.security_rule || undefined }),
                    onDelete: (e, i) => removeFilters(i, handleRefresh)
                }}
                bulkSelect ={ selectOptions && {
                    count: selectedHosts && selectedHosts.length,
                    items: selectOptions.items,
                    isDisabled: items.meta.total_items === 0,
                    checked: Boolean(selectedHosts && selectedHosts.length),
                    onSelect: () => selectOptions.handleOnCheckboxChange()
                }}
                filterConfig={{
                    items: [
                        searchFilter(
                            messages.systemsSearchName, messages.searchFilterByName,
                            parameters.filter, handleRefresh
                        ),
                        securityRuleFilter(handleRefresh, parameters, props.filterRuleValues),
                        statusFilter(handleRefresh, parameters)
                    ]
                }}

            >
                {StatusModal && <StatusModal />}
            </InventoryTable>
        </React.Fragment>
    );
};

SystemsExposedTable.propTypes = {
    intl: propTypes.object,
    cve: propTypes.string,
    cveStatusDetails: propTypes.object,
    location: propTypes.object,
    history: propTypes.object,
    filterRuleValues: propTypes.array
};

export default injectIntl(
    withRouter(
        SystemsExposedTable
    )
);
