import React, { Fragment } from 'react';
import PropTypes from 'prop-types';

import {
    Section,
    Column,
    Chart,
    Table,
    Panel,
    PanelItem
} from '@redhat-cloud-services/frontend-components-pdf-generator';
import { Text  } from '@react-pdf/renderer';
import { truncate } from 'lodash';

import styles from '../Common/styles';
import CVElabels from '../Common/CVElabels';
import messages from '../../../../Messages';

const SecondPage = ({ data, intl }) => {
    const cveDesc = (description) => <Text style={styles.mb8}> {truncate(description, { length: 400 })}</Text>;

    const {
        recentCvesData,
        CVSSChart,
        CVSSData,
        CVSSHeader,
        topCves
    } = data;

    const [legendHeader, ...restCVSSHeader] = CVSSHeader;

    return (
        <Fragment key="first-section">
            <Text style={styles.header}>{intl.formatMessage(messages.cvesHeader)}</Text>
            <Section
                titleProps={{ style: styles.sectionTitle }}
                title={intl.formatMessage(messages.executiveReportCvesByCVSS)}
            >
                <Column>
                    <Chart
                        chartType="pie"
                        subTitle="Cves"
                        title="100"
                        data={CVSSChart}
                        colorSchema="orange"
                        legendHeader={legendHeader}
                    />
                </Column>
                <Column>
                    <Table
                        withHeader
                        rows={[restCVSSHeader, ...CVSSData]}
                    />
                </Column>
            </Section>
            <Section
                titleProps={{ style: styles.sectionTitle }}
                title={intl.formatMessage(messages.executiveReportRecentlyPublishedCves)}
            >
                <Panel style={{ flex: 1 }}>
                    {
                        recentCvesData.map(([label, value])=> (
                            <Fragment key={label}>
                                <PanelItem style={{ flex: 1 }} title={label}>
                                    {value}
                                </PanelItem>
                            </Fragment>
                        ))
                    }
                </Panel>
            </Section>
            <Section
                titleProps={{ style: styles.sectionTitle }}
                title={intl.formatMessage(messages.executiveReportTop3)}
                withColumn={false}
            >
                {
                    topCves.map(({
                        synopsis,
                        known_exploit: hasExploit,
                        security_rule: hasRule,
                        description,
                        cvss3_score: cvss3,
                        systems_affected: systemsAffected
                    }) => (
                        <Panel
                            key={synopsis}
                            title={synopsis}
                            description={cveDesc(description)}
                            labels={<CVElabels hasExploit={hasExploit} hasRule={hasRule} intl={intl} />}
                        >
                            <PanelItem title={intl.formatMessage(messages.executiveReportPanelTitle)}>
                                {Number.parseFloat(cvss3).toFixed(1)}
                            </PanelItem>
                            <PanelItem title={intl.formatMessage(messages.systemsExposed)}>
                                {systemsAffected.toString()}
                            </PanelItem>
                        </Panel>
                    ))

                }
            </Section>
        </Fragment>
    );
};

SecondPage.propTypes = {
    data: PropTypes.exact({
        recentCvesData: PropTypes.array,
        CVSSChart: PropTypes.array,
        CVSSData: PropTypes.array,
        CVSSHeader: PropTypes.array,
        topCves: PropTypes.array
    }),
    intl: PropTypes.any
};

export default SecondPage;
