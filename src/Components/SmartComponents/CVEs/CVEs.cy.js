import React from 'react';
import { mount } from '@cypress/react';
import { BrowserRouter as Router } from 'react-router-dom';
import { Provider } from 'react-redux';

import CVEs from './CVEs';
import ReducerRegistry from '../../../Utilities/ReducerRegistry';

import cvesResponse from '../../../../cypress/fixtures/cves.json';
import { IntlProvider } from '@redhat-cloud-services/frontend-components-translations';
import messages from '../../../../locales/en.json';
import { DEFAULT_PAGE_SIZE } from '../../../Helpers/constants';

beforeEach(() => {
    cy.intercept('GET', '**/api/vulnerability/v1/vulnerabilities/cves**', cvesResponse);

    mount(
        <IntlProvider locale="en" messages={messages}>
            <Provider store={ReducerRegistry.getStore()}>
                <Router>
                    <CVEs />
                </Router>
            </Provider>
        </IntlProvider>
    );
});

describe('CVE list table', () => {
    it.only('exists', () => {
        cy.get('[data-ouia-component-id="cves-table"]');

        cy.get('body').matchImage({
            maxDiffThreshold: 0.1
        });
    });

    it('has data', () => {
        cy.get('[data-ouia-component-id="cves-table"] tbody [data-label="CVE ID"]').should('have.length', DEFAULT_PAGE_SIZE);
    });
});

describe('CVE list table rows', () => {
    it('should have all rows collapsed by default', () => {
        cy.get('.pf-c-table__expandable-row:visible').should('have.length', 0);
    });

    it('should be expandable and collapsable', () => {
        cy.get('.pf-c-table__toggle').each((item) => cy.wrap(item).click());
        cy.get('.pf-c-table__expandable-row:visible').should('have.length', DEFAULT_PAGE_SIZE);

        cy.get('.pf-c-table__toggle').each((item) => cy.wrap(item).click());
        cy.get('.pf-c-table__expandable-row:visible').should('have.length', 0);
    });
});

describe('CVEs list table expand all button', () => {
    it('should expand and collapse all rows', () => {
        cy.get('[data-ouia-component-id=ExpandCollapseAll]').should('have.attr', 'aria-label', 'Expand all');
        cy.get('[data-ouia-component-id=ExpandCollapseAll]').click();
        cy.get('.pf-c-table__expandable-row:visible').should('have.length', DEFAULT_PAGE_SIZE);
        cy.get('[data-ouia-component-id=ExpandCollapseAll]').should('have.attr', 'aria-label', 'Collapse all');

        cy.get('[data-ouia-component-id=ExpandCollapseAll]').click();
        cy.get('.pf-c-table__expandable-row:visible').should('have.length', 0);
        cy.get('[data-ouia-component-id=ExpandCollapseAll]').should('have.attr', 'aria-label', 'Expand all');
    });
});
