import React,  { useState } from 'react';
import { Grid, GridItem, Card, CardTitle, CardBody, CardFooter } from '@patternfly/react-core';
import { Main } from '@redhat-cloud-services/frontend-components';
import { FileAltIcon } from '@patternfly/react-icons';
import DownloadExecutive from './DownloadExecutive';
import ReportConfigModal from '../Modals/ReportConfigModal';
import messages from '../../../Messages';
import { intl } from '../../../Utilities/IntlProvider';
import { ChartPieSolid } from '../../PresentationalComponents/CustomIcons/CustomIcons';
import Header from '../../PresentationalComponents/Header/Header';
import DownloadCVEsReport from '../Reports/DownloadCVEsReport';
import { constructFilterParameters, buildFilters } from '../Reports/ReportsHelper';
import { CVE_REPORT_FILTERS, DEFAULT_FILTER_DATA } from '../../../Helpers/constants';
import styles from './Common/styles';

const ReportsPage = () => {
    console.log('testing');
    const [isModalOpen, setModalOpen] = useState(false);
    const [downloadCVEReport, setDownloadCVEReport] = useState(false);
    const [reportTitle, setReportTitle] = useState(intl.formatMessage(messages.customReportDefaultTitle));
    const [userNotes, setUserNotes] = useState('');
    const [columnsToInclude, setColumnsToInclude] = useState(Object.keys(CVE_REPORT_FILTERS));
    const [filterData, setFilterData] = useState(DEFAULT_FILTER_DATA);

    const handleModalClose = () => {
        setReportTitle(intl.formatMessage(messages.customReportDefaultTitle));
        setUserNotes('');
        setColumnsToInclude(Object.keys(CVE_REPORT_FILTERS));
        setFilterData(DEFAULT_FILTER_DATA);
        setDownloadCVEReport(false);
        setModalOpen(false);
    };

    const handleDownloadButton = () => {
        setDownloadCVEReport(true);
        setModalOpen(false);
    };

    return (
        <React.Fragment>
            <Header title={intl.formatMessage(messages.reportsPageTitle)} showBreadcrumb={false}/>
            <Main>
                <Grid hasGutter lg={3} md={4} sm={12}>
                    <GridItem>
                        <Card className="report-card">
                            <CardTitle>
                                <ChartPieSolid style={styles.pieChartIcon}/>
                                <span className="pf-u-ml-sm" style={styles.cardTitle}>
                                    {intl.formatMessage(messages.executiveReportCardTitle)}
                                </span>
                            </CardTitle>
                            <CardBody>
                                {intl.formatMessage(messages.executiveReportCardDescription)}
                            </CardBody>
                            <CardFooter>
                                <DownloadExecutive/>
                            </CardFooter>
                        </Card>
                    </GridItem>
                    <GridItem>
                        <Card className="report-card">
                            <CardTitle>
                                <FileAltIcon size="lg" color="var(--pf-global--link--Color)"/>
                                <span className="pf-u-ml-sm" style={styles.cardTitle}>
                                    {intl.formatMessage(messages.customReportCardTitle)}
                                </span>
                            </CardTitle>
                            <CardBody>
                                {intl.formatMessage(messages.customReportCardDescription)}
                            </CardBody>
                            <CardFooter>
                                <a className="create-report"
                                    onClick={() => setModalOpen(true)}>{intl.formatMessage(messages.customReportCardButton)}
                                </a>
                            </CardFooter>
                        </Card>
                    </GridItem>
                </Grid>
            </Main>
            <ReportConfigModal
                isOpen={isModalOpen}
                columnsToInclude={columnsToInclude}
                setColumnsToInclude={setColumnsToInclude}
                filterData={filterData}
                userNotes={userNotes}
                reportTitle={reportTitle}
                setReportTitle={setReportTitle}
                setUserNotes={setUserNotes}
                setFilterData={setFilterData}
                handleModalClose={(handleModalClose)}
                handleDownloadButton={handleDownloadButton}
            />

            { downloadCVEReport && <DownloadCVEsReport
                type='cves'
                key="download"
                reportData={{
                    header: columnsToInclude,
                    reportTitle,
                    userNotes
                }}
                showButton={false}
                onSuccess={handleModalClose}
                params={constructFilterParameters(filterData)}
                filters={buildFilters(filterData)}
                isReportDynamic
                label={messages.configModalExportReport}
            />}
        </React.Fragment>
    );
};

export default ReportsPage;
