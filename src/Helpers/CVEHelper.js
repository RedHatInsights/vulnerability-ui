import { Tooltip } from '@patternfly/react-core';
import { ExternalLinkAltIcon, ServerAltIcon } from '@patternfly/react-icons';
import { processDate } from '@redhat-cloud-services/frontend-components-utilities/files/helpers';
import React from 'react';
import { businessRiskOptions, STATUS_OPTIONS } from './constants';

export function createExposedSystemsTable(affectedSystems) {
    let isLoading = affectedSystems.isLoading;
    if (!isLoading) {
        let payload = affectedSystems.payload.asMutable();
        let { data, meta } = payload;
        const dataWithStatus = data.map(item => ({
            ...item,
            attributes: {
                ...item.attributes,
                status: (
                    <span>
                        {item.attributes.cve_status_id !== item.attributes.status_id ? (
                            <Tooltip content="Applies only to this system-CVE pair">
                                <ServerAltIcon />
                            </Tooltip>
                        ) : (
                            ''
                        )}{' '}
                        {item.attributes.status_id !== undefined &&
                            STATUS_OPTIONS.find(option => parseInt(option.value) === item.attributes.status_id).label}
                    </span>
                )
            }
        }));
        return { data: dataWithStatus, meta, isLoading };
    }

    return { data: (affectedSystems.payload && affectedSystems.payload.data) || [], meta: {}, isLoading };
}

export function createCveDetailsPage(cves) {
    let isLoading = cves.isLoading;
    let error = cves.error;
    if (!isLoading && !error) {
        let payload = cves.payload.asMutable();
        let { data, meta } = payload;

        data = {
            impact: data.attributes.impact,
            public_date: processDate(data.attributes.public_date),
            description: data.attributes.description,
            synopsis: data.attributes.synopsis,
            rh_link: createRHDBLink(data.attributes.synopsis),
            mitre_link: createMitreLink(data.attributes.synopsis),
            cvss3_score: data.attributes.cvss3_score,
            cvss2_score: data.attributes.cvss2_score,
            cvss2_metrics: data.attributes.cvss2_metrics,
            cvss3_metrics: data.attributes.cvss3_metrics,
            business_risk: businessRiskOptions.find(option => option.value === data.attributes.business_risk_id.toString()).label,
            business_risk_justification: data.attributes.business_risk_text,
            business_risk_id: data.attributes.business_risk_id,
            status: data.attributes.status,
            status_id: data.attributes.status_id,
            status_justification: data.attributes.status_text,
            systems_status_detail: data.attributes.systems_status_detail,
            systems_status_divergent: data.attributes.systems_status_divergent
        };

        return { data, meta, isLoading };
    }

    return { data: [], meta: {}, isLoading, error };
}

export function createRHDBLink(item) {
    return (
        <a target="_blank" rel="noopener noreferrer" href={'https://access.redhat.com/security/cve/' + item}>
            View in Red Hat CVE database <ExternalLinkAltIcon />
        </a>
    );
}

export function createMitreLink(item) {
    return (
        <a target="_blank" rel="noopener noreferrer" href={'https://cve.mitre.org/cgi-bin/cvename.cgi?name=' + item}>
            MITRE Database <ExternalLinkAltIcon />
        </a>
    );
}

export const cveTableRowActions = methods => [
    {
        title: 'Edit business risk',
        onClick: (event, rowId, rowData) =>
            methods.showBusinessRiskModal([
                {
                    id: rowData.id,
                    business_risk_id: rowData.business_risk_id,
                    justification: rowData.business_risk_justification
                }
            ])
    },
    {
        title: 'Edit status',
        onClick: (event, rowId, rowData) =>
            methods.showStatusModal([
                {
                    id: rowData.id,
                    status_id: rowData.status_id,
                    justification: rowData.status_justification
                }
            ])
    }
];

export const systemCveTableRowActions = methods => [
    {
        title: 'Edit status',
        onClick: (event, rowId, rowData) =>
            methods.showStatusModal([
                {
                    id: rowData.id,
                    status_id: rowData.status_id,
                    justification: rowData.status_justification
                }
            ])
    }
];
