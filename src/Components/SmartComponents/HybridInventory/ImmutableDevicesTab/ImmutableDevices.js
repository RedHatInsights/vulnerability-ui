import React, { useEffect } from 'react';
import propTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import { useUrlParams } from '../../../../Helpers/MiscHelper';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import ReducerRegistry from '../../../../Utilities/ReducerRegistry';
import { createExposedDevicesRows } from '../../../../Helpers/CVEHelper';
import { inventoryEntitiesReducer } from '../../../../Store/Reducers/InventoryEntitiesReducer';
import {
    changeExposedDevicesParameters
} from '../../../../Store/Actions/Actions';
import {
    SYSTEMS_EXPOSED_ALLOWED_PARAMS,
    PERMISSIONS,
    DEFAULT_PAGE_SIZE
} from '../../../../Helpers/constants';
import ErrorHandler from '../../../PresentationalComponents/ErrorHandler/ErrorHandler';
import { EmptyStateNoSystems } from '../../../PresentationalComponents/EmptyStates/EmptyStates';
import { useGetEntities, mergeAppColumns } from './helpers.js';
import Spinner from '@redhat-cloud-services/frontend-components/Spinner';
import { buildActiveFilters, removeFilters } from '../../../../Helpers/TableToolbarHelper';
import useSearchFilter from '../../../PresentationalComponents/Filters/PrimaryToolbarFilters/SearchFilter';
import useOsVersionFilter from '../../../PresentationalComponents/Filters/PrimaryToolbarFilters/OsVersionFilter';
import AsynComponent from '@redhat-cloud-services/frontend-components/AsyncComponent';
import { useRbac } from '../../../../Helpers/Hooks';
import messages from '../../../../Messages';

const ImmutableDevices = ({
    cveName,
    intl
}) => {
    const [[canReadHostsInventory], isLoadingInventory] = useRbac([
        PERMISSIONS.readHosts
    ], 'inventory');

    const dispatch = useDispatch();
    const [urlParameters, setUrlParams] = useUrlParams(SYSTEMS_EXPOSED_ALLOWED_PARAMS);

    const totalItems = useSelector(({ entities }) => entities?.total);
    const error = useSelector(({ entities }) => entities?.error || {});

    const parameters = useSelector(
        ({ ImmutableDevicesStore }) => ImmutableDevicesStore.parameters,
        shallowEqual
    );

    const apply = (params) => dispatch(changeExposedDevicesParameters(params));

    useEffect(() => apply(urlParameters), []);

    useEffect(() => setUrlParams({ ...parameters }), [parameters]);

    const getEntities = useGetEntities(
        {
            id: cveName,
            createRows: createExposedDevicesRows
        }
    );

    const searchFilter = useSearchFilter(
        'filter',
        messages.systemsSearchName,
        messages.searchFilterByName,
        parameters.filter,
        apply
    );

    const advisoryNameFilter = useSearchFilter(
        'advisory',
        messages.advisoryName,
        messages.searchFilterByAdvisoryName,
        parameters.advisory,
        apply
    );

    const osVersionFilter = useOsVersionFilter(
        parameters.rhel_version,
        apply
    );

    const activeFilters = {
        filters: buildActiveFilters({ ...parameters }),
        onDelete: (_, chips) => removeFilters(chips, apply),
        deleteTitle: intl.formatMessage(messages.resetFilters)
    };

    return isLoadingInventory ? <Spinner centered /> :
        error?.hasError && !canReadHostsInventory    ? <ErrorHandler code={error?.errorCode} />
            : (<AsynComponent
                appName="inventory"
                module="./ImmutableDevices"
                fallback={<div />}
                store={ReducerRegistry.getStore()}
                onLoad={({ mergeWithEntities }) => {
                    ReducerRegistry.register({
                        ...mergeWithEntities(
                            inventoryEntitiesReducer([]),
                            {
                                page: Number(parameters.page || 1),
                                perPage: DEFAULT_PAGE_SIZE,
                                ...(parameters.sort && {
                                    sortBy: {
                                        key: parameters.sort.replace(/^-/, ''),
                                        direction: parameters.sort.match(/^-/) ? 'desc' : 'asc'
                                    }
                                })
                            }
                        )
                    });
                }}
                key="inventory"
                customFilters={{
                    edgeParams: {
                        ...parameters
                    }
                }}
                getEntities={getEntities}
                showActions={totalItems !== 0}
                hideFilters={{ all: true, hostGroupFilter: false }}
                noSystemsTable={<EmptyStateNoSystems />}
                mergeAppColumns={mergeAppColumns}
                filterConfig={{
                    items: [
                        searchFilter,
                        advisoryNameFilter,
                        ...osVersionFilter
                    ]
                }}
                activeFiltersConfig={activeFilters}
            />
            );
};

ImmutableDevices.propTypes = {
    cveName: propTypes.string,
    intl: propTypes.object
};

export default injectIntl(ImmutableDevices);
