/* eslint-disable react/no-danger */
import React from 'react';
import marked from 'marked';
import PropTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import sanitizeHtml from 'sanitize-html';
import { Truncate } from '@redhat-cloud-services/frontend-components';
import { Stack, StackItem, TextContent } from '@patternfly/react-core';
import { handleCVELink } from '../../../Helpers/VulnerabilityHelper';
import { TRUNCATE_TEXT_THRESHOLD } from '../../../Helpers/constants';
import messages from '../../../Messages';

/**
 * extend marked's renderer in order to open link in new tab
 */
let renderer = new marked.Renderer();
renderer.link = function() {
    let link = marked.Renderer.prototype.link.apply(this, arguments);
    return link.replace('<a', '<a target=\'_blank\'');
};

marked.setOptions({ renderer });

const CSAwRuleSummary = ({ text, truncate, link, intl }) => {
    const dangerousHtml = (text) => ({ __html: sanitizeHtml(text) });

    return (
        <StackItem>
            <TextContent className="rule-description">
                { truncate && text.length > TRUNCATE_TEXT_THRESHOLD
                    ? (
                        <Truncate
                            length={TRUNCATE_TEXT_THRESHOLD}
                            expandText={intl.formatMessage(messages.readMore)}
                            collapseText={intl.formatMessage(messages.readLess)}
                            text={marked(text)}
                            spaceBetween
                        />
                    ) : (
                        <Stack>
                            <StackItem>
                                <span dangerouslySetInnerHTML={dangerousHtml(marked(text))}/>
                            </StackItem>
                            {link && <StackItem className="rule-link pf-u-mt-sm">
                                {handleCVELink(link, intl.formatMessage(messages.readMore))}
                            </StackItem>}
                        </Stack>
                    )
                }
            </TextContent>
        </StackItem>
    );

};

CSAwRuleSummary.defaultProps = {
    truncate: true,
    link: null
};

CSAwRuleSummary.propTypes = {
    intl: PropTypes.oneOfType([
        PropTypes.string,
        PropTypes.object
    ]),
    truncate: PropTypes.bool,
    text: PropTypes.string.isRequired,
    link: PropTypes.string
};

export default injectIntl(CSAwRuleSummary);
