import '@testing-library/jest-dom';
import { render, screen, waitFor } from '@testing-library/react';
import { getAffectedSystemsByCVE } from '../../../Helpers/APIHelper';
import CVEDetailTableTitle from './CVEDetailTableTitle';
import { AccountStatContext } from '../../../Utilities/VulnerabilityRoutes';

jest.mock('@unleash/proxy-client-react', () => ( {
    ...jest.requireActual('@unleash/proxy-client-react'),
    useFlag: () => true, 
    useFlagsStatus: () => ({ flagsReady: true })
}))

jest.mock('../../../Helpers/APIHelper', () => ({
    ...jest.requireActual('../../../Helpers/APIHelper'),
    getAffectedSystemsByCVE: jest.fn()
}));

afterEach(() => {
    jest.resetAllMocks()
});

getAffectedSystemsByCVE.mockImplementation(() => () => Promise.resolve({}))

const accountContextValue = {     
    hasConventionalSystems: true,
    hasEdgeDevices: true
};

const waitComponent = async (contextValue) => {
    render(<AccountStatContext.Provider value={contextValue}>
        <CVEDetailTableTitle cveName={'test-cve'}  />
    </AccountStatContext.Provider>);

    await waitFor(() => {
        expect(screen.getByLabelText('Affected systems table title')).toBeDefined();
    });
}

describe('CVE detail table title:', () => {
    test('Should show total number of affected systems when there is an edge device in an account', async () => {
        getAffectedSystemsByCVE.mockImplementation(() => Promise.resolve({ meta: { total_items: 10 } }));
        await waitComponent(accountContextValue);

        expect(screen.getByLabelText('Affected systems table title')).toHaveTextContent(
            '20 Total systems affected'
        );
    });
    test('Should show only Systems as title when there is no edge device in an account', async () => {
        getAffectedSystemsByCVE.mockImplementation(() => Promise.resolve({ meta: { total_items: 0 } }));

        await waitComponent({...accountContextValue, hasEdgeDevices: false });

        expect(screen.getByLabelText('Affected systems table title')).toHaveTextContent(
            'Systems'
        );
    });
    test('Should show only systems text in singular when there is a single edge device', async () => {
        getAffectedSystemsByCVE.mockReturnValueOnce(Promise.resolve({ meta: { total_items: 1 } }));
        getAffectedSystemsByCVE.mockReturnValueOnce(Promise.resolve({ meta: { total_items: 0 } }));


        await waitComponent(accountContextValue);

        expect(screen.getByLabelText('Affected systems table title')).toHaveTextContent(
            '1 Total system affected'
        );
    });
    test('Should show default label Systems when there is an api error', async () => {
        getAffectedSystemsByCVE.mockImplementation(() => Promise.reject(new Error('API error')));

        await waitComponent({...accountContextValue, hasEdgeDevices: false });

        expect(screen.getByLabelText('Affected systems table title')).toHaveTextContent(
            'System'
        );
    });
});
