import React from 'react';
import propTypes from 'prop-types';
import { addNotification } from '@redhat-cloud-services/frontend-components-notifications/redux';
import RemediationButton from '@redhat-cloud-services/frontend-components-remediations/RemediationButton';
import { AnsibeTowerIcon } from '@patternfly/react-icons';
import routerParams from '@redhat-cloud-services/frontend-components-utilities/RouterParams';
import { connect } from 'react-redux';
import messages from '../../../Messages';
import { FormattedMessage } from 'react-intl';
import { mergeObjectPropertyBy } from '../../../Helpers/MiscHelper';

const Remediation = ({ cves, systems, manyRules, addNotification: dispatchNotification }) => {
    const baseIssueTemplate = (cve, system) => ({
        id: `vulnerabilities:${cve}`,
        description: cve,
        systems: [system]
    });

    const remediationProvider = (cvesProvider = [], systemsProvider = [], manyRules = false) => {
        let cves = [].concat(cvesProvider);
        let systems = [].concat(systemsProvider);
        let issues = [];

        // CVE Details page where cves === 1 and systems > 1...N and cves linked rules > 1...N
        if (manyRules && cves.length === 1) {
            issues = systems.reduce((prev, { id: systemID, cve: cveID, rule }) => {
                let issue = baseIssueTemplate(cveID, systemID);

                if (rule) {
                    issue.id = `${issue.id}:${rule?.rule?.rule_id}`;
                }

                return [...prev, issue];
            }, []);

            issues = mergeObjectPropertyBy(issues, 'systems');
        }

        // System cves where systems === 1 & cves > 1..N and cves linked rules === 1
        if (!manyRules && systems?.length === 1) {
            const [systemID] = systems;

            issues = cves.reduce((acc, { id: cveID, rules }) => {
                let issue = baseIssueTemplate(cveID, systemID);

                if (rules?.rule_id) {
                    issue.id = `${issue.id}:${rules.rule_id}`;
                }

                return [...acc, issue];
            }, []);
        }

        return cves.length && systems.length ? { issues } : false;
    };

    return (
        <div>
            <RemediationButton
                dataProvider={() => remediationProvider(cves, systems, manyRules)}
                isDisabled={cves.length === 0 || systems.length === 0}
                onRemediationCreated={result => dispatchNotification(result.getNotification())}
            >
                <AnsibeTowerIcon size="sm" color={'var(--pf-global--BackgroundColor--100)'} />
                &nbsp;
                <FormattedMessage {...messages.remediateLabel} />
            </RemediationButton>
        </div>
    );
};

Remediation.propTypes = {
    cves: propTypes.oneOfType([
        propTypes.array,
        propTypes.string
    ]),
    systems: propTypes.oneOfType([
        propTypes.array,
        propTypes.string
    ]),
    addNotification: propTypes.func,
    manyRules: propTypes.bool
};

export default connect(
    null,
    dispatch => ({
        addNotification: notification => dispatch(addNotification(notification))
    })
)(routerParams(Remediation));
