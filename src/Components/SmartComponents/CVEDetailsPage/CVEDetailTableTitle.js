import React, { useContext, useEffect, useState } from 'react';
import PropTypes from 'prop-types';
import { Skeleton, Text, TextContent, TextVariants } from '@patternfly/react-core';
import { getAffectedSystemsByCVE } from '../../../Helpers/APIHelper';
import useFeatureFlag from '../../../Utilities/useFeatureFlag';
import { AccountStatContext } from '../../../Utilities/VulnerabilityRoutes';

const CVEDetailTableTitle = ({ cveName }) => {
    const [isLoading, setLoading] = useState(true);
    const [totalSystems, setTotalSystems] = useState(0);
    const isEdgeParityEnabled = useFeatureFlag('vulnerability.edge_parity');
    const { hasEdgeDevices } = useContext(AccountStatContext);

    useEffect(() => {
        getAffectedSystemsByCVE({ id: cveName, host_type: 'edge', limit: 1 }).then(edgeDevice => {
            getAffectedSystemsByCVE({ id: cveName, host_type: 'rpmdnf', limit: 1 }).then(conventional => {
                const totalItems = edgeDevice?.meta?.total_items + conventional?.meta?.total_items;
                setTotalSystems(totalItems || 0);
                setLoading(false);
            });
        }).catch(() => {
            setTotalSystems(0);
            setLoading(false);
        });
    }, []);

    return isLoading
        ?
        <Skeleton width="25%" screenreaderText="Loading contents" />
        : (<TextContent aria-label="Affected systems table title">
            <Text component={TextVariants.h2} id="systems-exposed-table-header">
                {hasEdgeDevices && isEdgeParityEnabled
                    ? `${totalSystems} Total ${totalSystems > 1 ? 'systems' : 'system' } affected`
                    : 'Systems'
                }
            </Text>
        </TextContent>);
};

CVEDetailTableTitle.propTypes = {
    cveName: PropTypes.string.isRequired
};
export default CVEDetailTableTitle;
