
import React, { useState } from 'react';
import { useIntl } from 'react-intl';
import { DownloadButton } from '@redhat-cloud-services/frontend-components-pdf-generator';
import { getExecutiveReport } from '../../../Helpers/APIHelper';
import messages from '../../../Messages';
import buildExecReport from './BuildExecReport';
import { Fragment } from 'react';
import { useDispatch } from 'react-redux';

import { addNotification, clearNotifications } from '@redhat-cloud-services/frontend-components-notifications/cjs/actions';

const DownloadExecutive = () => {
    const intl = useIntl();
    const [isLoading, setLoading] = useState(false);
    const [renderPDF, setRenderPDF] = useState(false);
    const dispatch = useDispatch();

    const dataFetch = async () => {
        setLoading(true);

        dispatch(addNotification({
            dismissable: true,
            variant: 'info',
            title: intl.formatMessage(messages.downloadExecutiveNotification)
        }));

        const data = await getExecutiveReport();
        const report = buildExecReport({ data, intl });

        setLoading(false);
        return [...report];
    };

    const [date] = new Date().toISOString().split('T');

    const handleDownloadButton = () => {
        setRenderPDF(true);
    };

    return (<Fragment>
        <a href onClick={() => handleDownloadButton()}>
            {intl.formatMessage(messages.executiveReportCardButton)}
        </a>
        { renderPDF && <DownloadButton
            showButton={false}
            label={isLoading ? intl.formatMessage(messages.loading) : intl.formatMessage(messages.executiveReportCardButton)}
            asyncFunction={dataFetch}
            buttonProps={{ variant: 'link', isInline: true }}
            type={intl.formatMessage(messages.vulnerabilitiesHeader)}
            fileName={`vulnerability_executive-report--${date}.pdf`}
            allPagesHaveTitle={false}
            onSuccess={() => {
                dispatch(clearNotifications());
                setRenderPDF(false);
            }}
        />
        }
    </Fragment>
    );

};

export default DownloadExecutive;
