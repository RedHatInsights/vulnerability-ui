import React, { Fragment, useState } from 'react';
import PropTypes from 'prop-types';
import { Stack,
    StackItem,
    Text,
    TextContent,
    TextVariants,
    Tooltip,
    SplitItem,
    Split,
    Grid,
    GridItem,
    Card,
    CardBody,
    Button
} from '@patternfly/react-core';
import { useDispatch } from 'react-redux';
import { Link } from 'react-router-dom';
import { InsightsLabel } from '@redhat-cloud-services/frontend-components';
import {
    CheckCircleIcon,
    OutlinedQuestionCircleIcon,
    ExternalLinkAltIcon,
    AnsibeTowerIcon,
    PowerOffIcon
} from '@patternfly/react-icons';
import { injectIntl } from 'react-intl';
import Label from '../Snippets/Label';
import messages from '../../../Messages';
import {
    RISK_OF_CHANGE_TOOLTIP,
    RISK_OF_CHANGE_LABEL,
    RH_KB_URL,
    CVES_PATH,
    impactTextList
} from '../../../Helpers/constants';
import { CSAwIcon } from '../CustomIcons/CustomIcons';
import CSAwRuleSummary from './CSAwRuleSummary';
import './CSAwRuleBox.scss';

const CSAwRuleBox = ({ rules, synopsis, changeExposedSystemsParameters, intl }) => {
    const dispatch = useDispatch();
    const [numberOfCards, setNumberOfCards] = useState(2);

    const sortedRules = [].concat(rules).sort((a, b) => (b.systems_affected - a.systems_affected));

    const ruleCards = sortedRules.length > numberOfCards && sortedRules.slice(0, numberOfCards) || sortedRules;

    const handleExposedSystemFilter = (ruleId) => {
        const params = { rule_key: ruleId, rule_presence: 'true' };
        dispatch(changeExposedSystemsParameters(params));
    };

    return <Fragment>
        {ruleCards && ruleCards.map(rule => (
            <Card className="card-box-shadow" key={rule.rule_id}>
                <CardBody>
                    <Grid hasGutter>
                        <GridItem span={12}>
                            <TextContent className={'icon-with-label'}>
                                <Text component={TextVariants.h3}>
                                    <Tooltip
                                        content={intl.formatMessage(messages.rulesIconTooltip)}
                                    >
                                        <CSAwIcon />
                                    </Tooltip>
                                    {rule.description}
                                </Text>
                            </TextContent>
                        </GridItem>
                        <GridItem span={8}>
                            <Stack hasGutter>
                                <StackItem>
                                    <CSAwRuleSummary text={rule.summary} />
                                </StackItem>

                                <StackItem>
                                    <TextContent>
                                        <Text component={TextVariants.p}
                                            className="pf-u-mb-xs fontsize--lg">
                                            {intl.formatMessage(messages.associatedCves)}
                                        </Text>
                                        <Text component={TextVariants.p}>
                                            {synopsis} ({intl.formatMessage(messages.current)})
                                            {
                                                rule.associated_cves
                                                .filter(cve => cve !== synopsis)
                                                .map((cve, _i) =>
                                                    <a
                                                        className="associated-cve-link"
                                                        key={_i}
                                                        href={`${CVES_PATH}/${cve}`}
                                                    >
                                                        {cve}
                                                    </a>
                                                )
                                                .reduce((prev, curr) => [prev, ', ', curr], [''])
                                            }
                                        </Text>
                                    </TextContent>
                                </StackItem>

                                {
                                    rule.kbase_node_id &&
                                    <StackItem>
                                        <TextContent>
                                            <Text
                                                className={'icon-with-label'}
                                                component={TextVariants.p}
                                            >
                                                <a
                                                    className="kb-link"
                                                    href={`${RH_KB_URL}/${rule.kbase_node_id}`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    {
                                                        intl.formatMessage(messages.knowledgebaseArticle)
                                                    }
                                                    <ExternalLinkAltIcon className="l-sm-spacer"/>
                                                </a>
                                            </Text>
                                        </TextContent>
                                    </StackItem>
                                }

                            </Stack>
                        </GridItem>
                        <GridItem span={4}>
                            <Stack hasGutter>
                                {rule.rule_id &&
                                    <StackItem>
                                        <TextContent>
                                            <Text
                                                className={'filter-affected-systems'}
                                                onClick={() => handleExposedSystemFilter(rule.rule_id)}
                                            >
                                                <Link
                                                    key={rule.rule_id}
                                                    to={`/cves/${synopsis}/?rule_key=${rule.rule_id}`}
                                                >
                                                    {
                                                        intl.formatMessage(
                                                            messages.filterByAffectedSystems,
                                                            {
                                                                count: rule.systems_affected ?? -1
                                                            }
                                                        )
                                                    }
                                                </Link>
                                            </Text>
                                        </TextContent>
                                    </StackItem>
                                }
                                <StackItem>
                                    <TextContent>
                                        {
                                            rule.rule_impact &&
                                            (
                                                <Split hasGutter className="pf-u-mt-sm">
                                                    <SplitItem>
                                                        <Label className="label">
                                                            {intl.formatMessage(messages.impact)}
                                                        </Label>
                                                    </SplitItem>
                                                    <SplitItem isFilled className="icon-with-label">

                                                        <InsightsLabel value={rule.rule_impact}/>

                                                        <Tooltip
                                                            content={Object.values(impactTextList)[rule.rule_impact - 1]}
                                                        >
                                                            <OutlinedQuestionCircleIcon
                                                                className="l-sm-spacer outlinedQuestionCircleIcon"
                                                            />
                                                        </Tooltip>

                                                    </SplitItem>
                                                </Split>
                                            )
                                        }

                                        <Split hasGutter className="pf-u-mt-sm">
                                            <SplitItem>
                                                <Label className="label">
                                                    {intl.formatMessage(messages.riskOfChange)}
                                                </Label>
                                            </SplitItem>
                                            <SplitItem isFilled className="icon-with-label">
                                                { RISK_OF_CHANGE_LABEL[rule.change_risk] }

                                                <Tooltip
                                                    content={RISK_OF_CHANGE_TOOLTIP[rule.change_risk]}
                                                >
                                                    <OutlinedQuestionCircleIcon
                                                        className="l-sm-spacer outlinedQuestionCircleIcon"
                                                    />
                                                </Tooltip>

                                            </SplitItem>
                                        </Split>
                                        <Split hasGutter className="pf-u-mt-sm">
                                            <SplitItem>
                                                <Label className="label">
                                                    <AnsibeTowerIcon
                                                        size="md"
                                                        className="pf-u-mr-xs ansibeTowerIcon"
                                                    />
                                                    {intl.formatMessage(messages.remediationLabel)}
                                                </Label>
                                            </SplitItem>
                                            <SplitItem className="icon-with-label" isFilled>
                                                { !rule.playbook_count
                                                    ? intl.formatMessage(messages.no)
                                                    : (
                                                        <Fragment>
                                                            <CheckCircleIcon
                                                                className="checkCircleIcon"
                                                            />
                                                            {intl.formatMessage(messages.yes)}
                                                            <Tooltip
                                                                content={intl.formatMessage(messages.ansibleRemediationTooltip)}
                                                            >
                                                                <OutlinedQuestionCircleIcon
                                                                    className="l-sm-spacer outlinedQuestionCircleIcon"
                                                                />
                                                            </Tooltip>
                                                        </Fragment>
                                                    )
                                                }
                                                <div className="pf-u-mt-xs">
                                                    { rule.reboot_required &&
                                                        <Text>
                                                            <PowerOffIcon
                                                                className="pf-u-mr-xs powerOffIcon"
                                                            />
                                                            {intl.formatMessage(messages.rebootRequired)}
                                                        </Text>
                                                    }
                                                </div>
                                            </SplitItem>

                                        </Split>
                                    </TextContent>
                                </StackItem>
                            </Stack>
                        </GridItem>
                    </Grid>
                </CardBody>
            </Card>
        ))}
        {
            rules.length > numberOfCards && (
                <Grid>
                    <GridItem>
                        <Button key="viewMoreRules" variant="secondary" onClick={() => setNumberOfCards(rules.length)}>
                            {intl.formatMessage(messages.viewMoreScurityRules, { rules: (rules.length - numberOfCards) })}
                        </Button>
                    </GridItem>
                </Grid>
            )
        }
    </Fragment>;
};

CSAwRuleBox.defaultProps = {
    rules: []
};

CSAwRuleBox.propTypes = {
    intl: PropTypes.any,
    rules: PropTypes.array,
    synopsis: PropTypes.string,
    changeExposedSystemsParameters: PropTypes.func
};

export default injectIntl(CSAwRuleBox);
