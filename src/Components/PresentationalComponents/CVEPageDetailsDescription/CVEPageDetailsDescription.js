import { Stack, StackItem, Text, TextContent, TextVariants, Split, SplitItem } from '@patternfly/react-core';
import { ExclamationTriangleIcon } from '@patternfly/react-icons';
import { StyledText, StyledConstants } from '@patternfly/react-styled-system';
import { Table, TableBody, TableHeader } from '@patternfly/react-table';
import propTypes from 'prop-types';
import React from 'react';
import { STATUS_OPTIONS } from '../../../Helpers/constants';
import './CVEPageDetailsDescription.scss';
import SnippetWithHeaderAndPopover from './SnippetWithHeaderAndTooltip';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';

const CVEPageDetailsDescription = ({ cveAttributes, intl }) => {
    const {
        public_date: publishDate,
        description,
        rh_link: link,
        business_risk: businessRisk,
        business_risk_justification: businessRiskJustification,
        status,
        status_justification: statusJustification,
        systems_status_detail: systemsStatusDetail,
        systems_status_divergent: systemsStatusDivergent
    } = cveAttributes;

    const detailRows =
        systemsStatusDetail &&
        Object.keys(systemsStatusDetail).map(item => [
            STATUS_OPTIONS.find(status => status.value === item.toString()).label,
            systemsStatusDetail[item].toString()
        ]);

    const brPopoverContent = (
        <TextContent>
            <Stack>
                <StackItem>
                    <StyledText
                        fontWeight={StyledConstants.fontWeights.bold}
                        fontSize={StyledConstants.fontSizes.sm}
                        lineHeight={StyledConstants.lineHeights.sm}
                    >
                        {intl.formatMessage(messages.justificationNote)}
                    </StyledText>
                </StackItem>
                <StackItem>{businessRiskJustification || '--'}</StackItem>
            </Stack>
        </TextContent>
    );

    const statusPopoverContent = (
        <Stack>
            <StackItem>
                <StyledText
                    fontWeight={StyledConstants.fontWeights.bold}
                    fontSize={StyledConstants.fontSizes.sm}
                    lineHeight={StyledConstants.lineHeights.sm}
                >
                    {intl.formatMessage(messages.cveStatus)}
                </StyledText>
                {status || '--'}

                <StyledText
                    fontWeight={StyledConstants.fontWeights.bold}
                    fontSize={StyledConstants.fontSizes.sm}
                    lineHeight={StyledConstants.lineHeights.sm}
                    style={{ marginTop: 'var(--pf-global--spacer--sm)' }}
                >
                    {intl.formatMessage(messages.justificationNote)}
                </StyledText>
                {statusJustification || '--'}
            </StackItem>
            {systemsStatusDivergent > 0 && (
                <StackItem>
                    <TextContent>
                        <hr className={'splitter'} />
                    </TextContent>
                    <StyledText fontWeight={StyledConstants.fontWeights.semi_bold} lineHeight={StyledConstants.lineHeights.sm}>
                        {intl.formatMessage(messages.cvePageDetailsSystemsWTCves)}
                    </StyledText>
                    <Table
                        aria-label={'Status details'}
                        borders={false}
                        gridBreakPoint={null}
                        cells={[intl.formatMessage(messages.statusLabel), intl.formatMessage(messages.count)]}
                        rows={detailRows}
                        className={'status-breakdown-table'}
                    >
                        <TableHeader />
                        <TableBody />
                    </Table>
                </StackItem>
            )}
        </Stack>
    );
    return (

        <Stack hasGutter>
            <StackItem />
            <StackItem>
                <Split hasGutter>
                    <SplitItem>
                        <SnippetWithHeaderAndPopover
                            title={intl.formatMessage(messages.businessRiskLabel)}
                            value={businessRisk}
                            content={brPopoverContent}
                        />
                    </SplitItem>
                    <SplitItem>
                        <SnippetWithHeaderAndPopover
                            title={intl.formatMessage(messages.statusLabel)}
                            content={statusPopoverContent}
                            value={
                                <span>
                                    {systemsStatusDivergent > 0 && (
                                        <ExclamationTriangleIcon color={'var(--pf-global--primary-color--100)'} />
                                    )}{' '}
                                    {status}
                                </span>
                            }
                        />
                    </SplitItem>
                </Split>
            </StackItem>
            <StackItem>
                <TextContent>
                    <Text component={TextVariants.p}>{description}</Text>
                </TextContent>
            </StackItem>
            <StackItem>
                <div style={{ marginBottom: 'var(--pf-global--spacer--xs)' }}>
                    {intl.formatMessage(messages.publishDate)}: {publishDate}
                </div>
                <div>{link}</div>
            </StackItem>
        </Stack>

    );
};

CVEPageDetailsDescription.propTypes = {
    cveAttributes: propTypes.any,
    intl: propTypes.any
};

export default injectIntl(CVEPageDetailsDescription);
