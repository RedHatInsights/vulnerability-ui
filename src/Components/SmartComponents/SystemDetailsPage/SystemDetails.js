import React from 'react';
import propTypes from 'prop-types';
import { connect } from 'react-redux';
import { ConnectedSystemCves } from '../SystemCves/SystemCves';
import {
    EmptyStateExcludedSystem,
    NotAuthorized
} from '../../PresentationalComponents/EmptyStates/EmptyStates';
import { Spinner } from '@redhat-cloud-services/frontend-components/Spinner';
import { intl } from '../../../Utilities/IntlProvider';
import messages from '../../../Messages';
import { PERMISSIONS } from '../../../Helpers/constants';
import { useRbac } from '../../../Helpers/Hooks';

const SystemDetails = ({ entity, isOptOut, optOutSystemHandler, loaded }) => {
    const [[
        canExport,
        canReadVulnerabilityResults,
        canEditPairStatus,
        canReadExcluded
    ], isRbacLoading] = useRbac([
        PERMISSIONS.basicReporting,
        PERMISSIONS.readVulnerabilityResults,
        PERMISSIONS.setPairStatus,
        PERMISSIONS.readExcluded]
    );

    if (isRbacLoading) {
        return <Spinner centered />;
    } else if (canReadVulnerabilityResults) {
        if (entity && loaded && isOptOut) {
            if (canReadExcluded) {
                return <EmptyStateExcludedSystem buttonAction={() => optOutSystemHandler(entity.display_name, false)} />;
            } else {
                return <NotAuthorized title={intl.formatMessage(messages.notAuthorizedNoAccessForSystem)} />;
            }
        } else {
            return <ConnectedSystemCves
                entity={{ id: entity?.id, display_name: entity?.display_name }}
                showHeaderLabel
                setPageTitle
                canExport={canExport}
                canEditPairStatus={canEditPairStatus}
            />;
        }
    } else {
        return <NotAuthorized />;
    }
};

SystemDetails.propTypes = {
    entity: propTypes.object,
    isOptOut: propTypes.bool,
    loaded: propTypes.bool,
    optOutSystemHandler: propTypes.func
};

function mapStateToProps({ entityDetails: { entity, opt_out: isOptOut, loaded } }) {
    return {
        entity,
        isOptOut,
        loaded
    };
}

export default connect(
    mapStateToProps,
    null
)(SystemDetails);
