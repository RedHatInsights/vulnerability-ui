import React, { Fragment } from 'react';
import PropTypes from 'prop-types';
import { Stack,
    StackItem,
    Text,
    TextContent,
    TextVariants,
    Tooltip,
    SplitItem,
    Split,
    Grid,
    GridItem,
    Card,
    CardBody
} from '@patternfly/react-core';
import { Link } from 'react-router-dom';
import CheckCircleIcon from '@patternfly/react-icons/dist/js/icons/check-circle-icon';
import OutlinedQuestionCircleIcon from '@patternfly/react-icons/dist/js/icons/outlined-question-circle-icon';
import ExternalLinkAltIcon from '@patternfly/react-icons/dist/js/icons/external-link-alt-icon';
import { Reboot } from '@redhat-cloud-services/frontend-components/components/Reboot';
import { FormattedMessage } from 'react-intl';

import Label from '../Snippets/Label';
import messages from '../../../Messages';
import { RISK_OF_CHANGE_TOOLTIP, RISK_OF_CHANGE_LABEL, RH_KB_URL, CVES_PATH } from '../../../Helpers/constants';
import TruncatedText from '../Snippets/TruncatedText';
import { CSAwIcon } from '../../PresentationalComponents/CSAwIcon/CSAwIcon';
import './CSAwRuleBox.scss';

const CSAwRuleBox = ({ rules, synopsis, fetchAffectedSystems }) => {
    const handleExposedSystemFilter = (ruleId) => {
        const params = { security_rule: ruleId };
        fetchAffectedSystems(synopsis, params);
    };

    return <Fragment>
        {rules && rules.map(rule => (
            <Card className="card-box-shadow" key={rule.rule_id}>
                <CardBody>
                    <Grid gutter="md">
                        <GridItem span={12}>
                            <TextContent className={'icon-with-label'}>
                                <Text component={TextVariants.h3}>
                                    <Tooltip content={<FormattedMessage {...messages.rulesIconTooltip} />}>
                                        <CSAwIcon />
                                    </Tooltip>
                                    {rule.description}
                                </Text>
                            </TextContent>
                        </GridItem>
                        <GridItem span={8}>
                            <Stack gutter="md">
                                <StackItem>
                                    <TextContent>
                                        <TruncatedText content={rule.summary}/>
                                    </TextContent>
                                </StackItem>

                                <StackItem>
                                    <TextContent>
                                        <Text component={TextVariants.h4}> <FormattedMessage {...messages.associatedCves}/></Text>
                                        <Text component={TextVariants.p}>
                                            {synopsis} (<FormattedMessage {...messages.current}/>)
                                            {
                                                rule.associated_cves
                                                .filter(cve => cve !== synopsis)
                                                .map((cve, _i) =>
                                                    <a
                                                        className="associated-cve-link"
                                                        key={_i}
                                                        href={`${CVES_PATH}/${cve}`}
                                                    >
                                                        {cve}
                                                    </a>
                                                )
                                                .reduce((prev, curr) => [prev, ', ', curr], [''])
                                            }
                                        </Text>
                                    </TextContent>
                                </StackItem>

                                {
                                    rule.kbase_node_id &&
                                    <StackItem>
                                        <TextContent>
                                            <Text
                                                className={'icon-with-label'}
                                                component={TextVariants.a}
                                            >
                                                <a
                                                    href={`${RH_KB_URL}/${rule.kbase_node_id}`}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    {
                                                        <FormattedMessage {...messages.knowledgebaseArticle}/>
                                                    }
                                                    <ExternalLinkAltIcon className="l-sm-spacer"/>
                                                </a>
                                            </Text>
                                        </TextContent>
                                    </StackItem>
                                }

                            </Stack>
                        </GridItem>
                        <GridItem span={4}>
                            <Stack gutter="md">
                                {rule.rule_id &&
                                    <StackItem>
                                        <TextContent>
                                            <Text
                                                component={TextVariants.a}
                                                onClick={() => handleExposedSystemFilter(rule.rule_id)}
                                            >
                                                <Link
                                                    key={rule.rule_id}
                                                    to={`/cves/${synopsis}/?security_rule=${rule.rule_id}`}
                                                >
                                                    <FormattedMessage {...messages.filterByAffectedSystems}/>
                                                </Link>

                                            </Text>
                                        </TextContent>
                                    </StackItem>
                                }
                                <StackItem>
                                    <TextContent>
                                        <Text component={TextVariants.h4}>
                                            <FormattedMessage {...messages.remediatioLabel}/>
                                        </Text>
                                        <Split gutter="md">
                                            <SplitItem>
                                                <Label className="label">
                                                    <FormattedMessage {...messages.ansibleRemediation}/>
                                                </Label>
                                            </SplitItem>
                                            <SplitItem className="icon-with-label" isFilled>
                                                { !rule.playbook_count ? <FormattedMessage {...messages.no}/>
                                                    : (
                                                        <Fragment>
                                                            <CheckCircleIcon className="ansible-success" />
                                                            <FormattedMessage {...messages.yes}/>
                                                            <Tooltip
                                                                content={
                                                                    <FormattedMessage {...messages.ansibleRemediationTooltip}/>
                                                                }
                                                            >
                                                                <OutlinedQuestionCircleIcon
                                                                    color={'var(--pf-global--secondary-color--100)'}
                                                                    className="l-sm-spacer"
                                                                />
                                                            </Tooltip>
                                                        </Fragment>
                                                    )

                                                }
                                            </SplitItem>
                                        </Split>
                                        <Split gutter="md">
                                            <SplitItem>
                                                <Label className="label"><FormattedMessage {...messages.riskOfChange}/></Label>
                                            </SplitItem>
                                            <SplitItem isFilled className="icon-with-label">
                                                { RISK_OF_CHANGE_LABEL[rule.change_risk] }

                                                <Tooltip content={RISK_OF_CHANGE_TOOLTIP[rule.change_risk]}>
                                                    <OutlinedQuestionCircleIcon
                                                        color={'var(--pf-global--secondary-color--100)'}
                                                        className="l-sm-spacer"
                                                    />
                                                </Tooltip>

                                                <br/>
                                                {
                                                    rule.reboot_required && <strong><Reboot red /></strong>
                                                }
                                            </SplitItem>
                                        </Split>
                                    </TextContent>
                                </StackItem>
                            </Stack>
                        </GridItem>
                    </Grid>
                </CardBody>
            </Card>
        ))}
    </Fragment>;
};

CSAwRuleBox.defaultProps = {
    rules: []
};

CSAwRuleBox.propTypes = {
    rules: PropTypes.array,
    synopsis: PropTypes.string,
    fetchAffectedSystems: PropTypes.func
};

export default CSAwRuleBox;
