import React, { useMemo, useState, useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { Alert, Stack, StackItem } from '@patternfly/react-core';
import PropTypes from 'prop-types';
import { CVES_ALLOWED_PARAMS, PATCHMAN_ADVISORY_DOCS_PATH, PERMISSIONS, SERVICE_NAME } from '../../../Helpers/constants';
import { createCveListByAccount } from '../../../Helpers/VulnerabilityHelper';
import { constructFilterParameters, updateRef, useUrlParams } from '../../../Helpers/MiscHelper';
import { CveStatusModal } from './components/CveStatusModal';
import { CveBusinessRiskModal } from './components/CveBusinessRiskModal';
import CVEsTable from './CVEsTable';
import CVEsTableToolbar from './CVEsTableToolbar';
import DownloadReport from '../../../Helpers/DownloadReport';
import {
    changeCveListParameters,
    fetchCveListByAccount,
    selectCve,
    expandCve,
    clearCVEsStore,
    changeColumnsCveList
} from '../../../Store/Actions/Actions';
import {
    addNotification,
    clearNotifications
} from '@redhat-cloud-services/frontend-components-notifications/redux';
import ErrorHandler from '../../PresentationalComponents/ErrorHandler/ErrorHandler';
import { Spinner } from '@redhat-cloud-services/frontend-components/Spinner';
import { useColumnManagement, useHybridSystemFilterFlag, useRbac } from '../../../Helpers/Hooks';
import { NotAuthorized } from '../../PresentationalComponents/EmptyStates/EmptyStates';
import { ExternalLinkAltIcon } from '@patternfly/react-icons';
import { getCveDefaultFilters } from './CVEsAssets';

export const CVETableContext = React.createContext({});

export const CVEs = ({ rbac }) => {
    const dispatch = useDispatch();

    // These states will contain data only when the modals are open
    // This is necessary because the showModal functions get these props down in the component tree
    const [cvesList, setCvesList] = useState([]);
    const [goToFirstPage, setGoToFirstPage] = useState(false);

    const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);
    const [isBusinessRiskModalOpen, setIsBusinessRiskModalOpen] = useState(false);

    const closeModalHandler = () => {
        setCvesList([]);
        setGoToFirstPage(false);
    };

    const closeStatusModalHandler = () => {
        closeModalHandler();
        setIsStatusModalOpen(false);
    };

    const closeBusinessRiskModalHandler = () => {
        closeModalHandler();
        setIsBusinessRiskModalOpen(false);
    };

    // useEffect(() => {
    //     closeModalHandler(isStatusModalOpen);
    // }, [isStatusModalOpen]);

    // useEffect(() => {
    //     closeModalHandler(isBusinessRiskModalOpen);
    // }, [isBusinessRiskModalOpen]);

    // This state causes a re-render when updateRef is called in <BusinessRiskModal> and <StatusModal>
    // to fetch the updated status of the CVEs
    const [causeARerender, setCauseARerender] = useState(false);

    const [[
        canEditStatusOrBusinessRisk,
        canEditPairStatus,
        canExport,
        canReadVulnerabilityResults,
        canToggleCvesWithoutErrata
    ], isRbacLoading] = rbac;

    const cveList = useSelector(
        ({ CVEsStore }) => CVEsStore.cveList
    );
    const parameters = useSelector(
        ({ CVEsStore }) => CVEsStore.parameters
    );
    const columns = useSelector(
        ({ CVEsStore }) => CVEsStore.columns
    );
    const selectedCves = useSelector(
        ({ CVEsStore }) => CVEsStore.selectedCves
    );
    const expandedRows = useSelector(
        ({ CVEsStore }) => CVEsStore.expandedRows
    );
    const isAllExpanded = useSelector(
        ({ CVEsStore }) => CVEsStore.isAllExpanded
    );

    const [ColumnManagementModal, setColumnManagementModalOpen]
        = useColumnManagement(columns, newColumns => dispatch(changeColumnsCveList(newColumns)));

    const cves = useMemo(() => createCveListByAccount(cveList, columns, parameters), [cveList, columns, parameters]);
    const shouldUseHybridSystemFilter = useHybridSystemFilterFlag();
    const [urlParameters, setUrlParam] = useUrlParams(['show_irrelevant', ...CVES_ALLOWED_PARAMS], shouldUseHybridSystemFilter);

    const apply = (filterParams = {}) => {
        const params = constructFilterParameters(filterParams);
        dispatch(changeCveListParameters(params));
    };

    useEffect(() => {
        apply({  ...getCveDefaultFilters(shouldUseHybridSystemFilter), ...urlParameters });
    }, [shouldUseHybridSystemFilter]);

    useEffect(() => {
        dispatch(fetchCveListByAccount(parameters, shouldUseHybridSystemFilter));
        setUrlParam({ ...parameters });
    }, [parameters, causeARerender, shouldUseHybridSystemFilter]);

    useEffect(() => {
        return () => {
            dispatch(clearCVEsStore());
            dispatch(clearNotifications());
        };
    }, [dispatch]);

    const handleCveSelect = (isSelected, cveNames) => {
        dispatch(selectCve(cveNames || []));
    };

    const downloadReport = format => {
        DownloadReport.exec(
            fetchCveListByAccount,
            parameters,
            format,
            'cves',
            notification => dispatch(addNotification(notification)),
            () => dispatch(clearNotifications()),
            shouldUseHybridSystemFilter
        );
    };

    // helper function for showBusinessRiskModal and showStatusModal:
    const updateRefFuncBuilder = (goToFirstPage) => {
        const { meta } = cves;

        return (() => {
            setCauseARerender(!causeARerender);
            dispatch(clearCVEsStore());
            updateRef(goToFirstPage ? { ...meta, page: 1 } : meta, parameters, apply);
        });
    };

    const showModal = (setIsModalOpen, cvesList, goToFirstPage) => {
        setCvesList(cvesList);
        setGoToFirstPage(goToFirstPage);
        setIsModalOpen(true);
    };

    const showStatusModal = (cvesList, goToFirstPage) => {
        showModal(setIsStatusModalOpen, cvesList, goToFirstPage);
    };

    const showBusinessRiskModal = (cvesList, goToFirstPage) => {
        showModal(setIsBusinessRiskModalOpen, cvesList, goToFirstPage);
    };

    const openCves = (cves) => {
        dispatch(expandCve(cves));
    };

    if (!cves.errors) {
        return (
            isRbacLoading ? <Spinner centered /> : canReadVulnerabilityResults ?
                (
                    <CVETableContext.Provider
                        value={{
                            cves,
                            params: parameters,
                            selectedCves,
                            expandedRows,
                            isAllExpanded,
                            methods: {
                                apply,
                                downloadReport,
                                selectCves: handleCveSelect,
                                showBusinessRiskModal,
                                showStatusModal,
                                openCves,
                                setColumnManagementModalOpen
                            }
                        }}
                    >
                        { isBusinessRiskModalOpen &&
                        <CveBusinessRiskModal
                            cves={cvesList}
                            updateRef={updateRefFuncBuilder(goToFirstPage)}
                            closeModalHandler={() => closeBusinessRiskModalHandler()}
                        />}

                        { isStatusModalOpen &&
                        <CveStatusModal
                            cves={cvesList}
                            canEditPairStatus={canEditPairStatus}
                            updateRef={updateRefFuncBuilder(goToFirstPage)}
                            closeModalHandler={() => closeStatusModalHandler()}
                        />}

                        {ColumnManagementModal}

                        <Stack>
                            <StackItem>
                                {cves.meta.cves_without_errata && cves.meta.advisory_available !== 'True' &&
                                    <Alert
                                        variant="info"
                                        isInline
                                        title="CVEs with and without an established Advisory"
                                    >
                                        Red Hat&apos;s policy requires displaying all high priority, critical,
                                        and important CVEs regardless of Advisory status.
                                        <a
                                            href={PATCHMAN_ADVISORY_DOCS_PATH}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="pf-v5-u-ml-xs"
                                        >
                                            Learn more about errata advisories
                                            <ExternalLinkAltIcon className="pf-v5-u-ml-xs" />
                                        </a>
                                    </Alert>
                                }
                                <CVEsTableToolbar
                                    aria-label="CVEs table toolbar"
                                    canEditStatusOrBusinessRisk={canEditStatusOrBusinessRisk}
                                    canExport={canExport}
                                    canToggleCvesWithoutErrata={canToggleCvesWithoutErrata}
                                />
                            </StackItem>
                            <StackItem>
                                <CVEsTable
                                    header={columns.filter(column => column.isShown ?? column.isShownByDefault)}
                                    canEditStatusOrBusinessRisk={canEditStatusOrBusinessRisk}
                                />
                            </StackItem>
                        </Stack>
                    </CVETableContext.Provider>
                ) : <NotAuthorized serviceName={SERVICE_NAME} />
        );
    } else {
        return <ErrorHandler code={cves.errors.status} />;
    }
};

CVEs.propTypes = {
    rbac: PropTypes.array.isRequired
};

const CVEsWithRbac = () => {
    const rbac = useRbac([
        PERMISSIONS.setCveStatusAndBusinessRisk,
        PERMISSIONS.setPairStatus,
        PERMISSIONS.basicReporting,
        PERMISSIONS.readVulnerabilityResults,
        PERMISSIONS.toggleCvesWithoutErrata
    ]);

    return <CVEs rbac={rbac} />;
};

export default CVEsWithRbac;
