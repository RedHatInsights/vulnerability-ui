import { Main } from '@redhat-cloud-services/frontend-components/Main';
import { addNotification, clearNotifications } from '@redhat-cloud-services/frontend-components-notifications/redux';
import React, { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useRouteMatch } from 'react-router-dom';
import { fetchSystemDetails, optOutSystemsAction } from '../../../Store/Actions/Actions';
import { systemDetailsPageStore } from '../../../Store/Reducers/SystemDetailsPageStore';
import ReducerRegistry from '../../../Utilities/ReducerRegistry';
import Header from '../../PresentationalComponents/Header/Header';
import { useIntl } from 'react-intl';
import {
    NotAuthorizedNotification,
    PATHS,
    PERMISSIONS,
    ReadOnlyNotification
} from '../../../Helpers/constants';
import messages from '../../../Messages';

import { AppInfo, DetailWrapper, InventoryDetailHead } from '@redhat-cloud-services/frontend-components/Inventory';
import { useRbac } from '../../../Helpers/Hooks';

const InventoryDetail = () => {
    const dispatch = useDispatch();
    const match = useRouteMatch();
    const intl = useIntl();

    const { entity, loaded, opt_out: isOptOut } = useSelector(state => state.entityDetails) ?? {};
    const errors = useSelector(({ SystemCvesStore }) => SystemCvesStore.cveList.payload.errors);

    const [[canSetExcludedIncluded]] = useRbac([PERMISSIONS.setExcludedIncluded]);

    const inventoryId = match.params.inventoryId;

    useEffect(() => {
        dispatch(fetchSystemDetails(inventoryId));
    }, [dispatch, inventoryId]);

    useEffect(() => {
        return () => {
            dispatch(clearNotifications());
        };
    }, [dispatch]);

    const notifications = systemName => ({
        exclude: {
            success: {
                variant: 'success',
                title: intl.formatMessage(messages.notificationExcludeSuccess, { count: 1, systemName })
            },
            failure: {
                variant: 'danger',
                autoDismiss: false,
                title: intl.formatMessage(messages.notificationExcludeFailureTitle, { count: 1, systemName }),
                description: intl.formatMessage(messages.notificationDetailExcludeFailureBody, { count: 1 })
            }
        },
        include: {
            success: {
                variant: 'success',
                title: intl.formatMessage(messages.notificationIncludeSuccessTitle, { count: 1, systemName }),
                description: intl.formatMessage(messages.notificationIncludeSuccessBody, { count: 1 })
            },
            failure: {
                variant: 'danger',
                autoDismiss: false,
                title: intl.formatMessage(messages.notificationIncludeFailureTitle, { count: 1, systemName }),
                description: intl.formatMessage(messages.notificationDetailIncludeFailureBody, { count: 1 })
            }
        }
    });

    const handleOptOutSystem = (systemName, toExclude) => {
        dispatch(optOutSystemsAction([inventoryId], toExclude)).then(() => {
            dispatch(fetchSystemDetails(inventoryId));
            dispatch(addNotification(toExclude
                ? notifications(systemName).exclude.success
                : notifications(systemName).include.success));
        }).catch(error => {
            dispatch(addNotification(
                error.status === '503' ? ReadOnlyNotification :
                    error.status === '403' ? NotAuthorizedNotification :
                        toExclude
                            ? notifications(systemName).exclude.failure
                            : notifications(systemName).include.failure));
        });
    };

    return (
        <DetailWrapper>
            <section className="inventory">
                <Header
                    title=""
                    breadcrumbs={[
                        {
                            title: PATHS.systemsPage.title,
                            to: PATHS.systemsPage.to,
                            loaded: true
                        },
                        {
                            title: entity?.display_name || intl.formatMessage(messages.invalidSystem),
                            isActive: true,
                            loaded
                        }
                    ]}
                >
                    {!errors && (
                        <InventoryDetailHead
                            onLoad={({ mergeWithEntities, mergeWithDetail, INVENTORY_ACTION_TYPES }) => {
                                ReducerRegistry.register({
                                    ...mergeWithEntities(),
                                    ...mergeWithDetail(systemDetailsPageStore(
                                        INVENTORY_ACTION_TYPES, handleOptOutSystem
                                    ))
                                });
                            }}
                            hideBack
                            actions={
                                entity && canSetExcludedIncluded && [
                                    isOptOut
                                        ? {
                                            title: intl.formatMessage(messages.inventoryKebabOptionsResume),
                                            onClick: () => handleOptOutSystem(entity?.display_name, false)
                                        }
                                        : {
                                            title: intl.formatMessage(messages.inventoryKebabOptionsExclude),
                                            onClick: () => handleOptOutSystem(entity?.display_name, true)
                                        }
                                ]
                            }
                        />
                    )}
                </Header>
            </section>
            <Main>
                <AppInfo optOutSystemHandler={handleOptOutSystem} />
            </Main>
        </DetailWrapper>
    );
};

export default InventoryDetail;
