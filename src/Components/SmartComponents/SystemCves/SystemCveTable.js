import React, { Component, Fragment } from 'react';
import propTypes from 'prop-types';
import { Table, TableBody, TableHeader } from '@patternfly/react-table';
import { SkeletonTable, TableToolbar } from '@redhat-cloud-services/frontend-components';

import { systemCveTableRowActions } from '../../../Helpers/CVEHelper';
import { createSortBy, handleSortColumn } from '../../../Helpers/MiscHelper';
import PaginationWrapper from '../../PresentationalComponents/PaginationWrapper/PaginationWrapper';
import {
    FilterNotFoundForSystem,
    EmptyCVEListForSystem,
    EmptyCVEList
} from '../../PresentationalComponents/EmptyStates/EmptyStates';
import { CVETableContext } from './SystemCves';

class SystemCvesTableWithContext extends Component {
    static propTypes = {
        context: propTypes.any,
        header: propTypes.array,
        entity: propTypes.object
    };

    noCves = () => {
        const { entity, context } = this.props;
        const { cves } = context;
        const filterFields = ['filter', 'cvss_from', 'cvss_to', 'public_from', 'public_to', 'impact', 'status_id'].filter(
            item => Object.prototype.hasOwnProperty.call(cves.meta, item) && cves.meta[item]
        );
        let emptyComponent = filterFields.length !== 0
            ? FilterNotFoundForSystem
            : entity
                ? EmptyCVEListForSystem
                : cves.data.length === 0
                    ? EmptyCVEList
                    : undefined;

        return ([{
            heightAuto: true,
            cells: [
                {
                    props: { colSpan: 8 },
                    title: (
                        emptyComponent
                    )
                }
            ]
        }]);

    };

    handleOnCollapse(event, rowKey, isOpen) {
        const { context } = this.props;
        const { cves, methods, params } = context;
        const { expandCveDescription } = params;
        const cveName = cves.data[rowKey] && cves.data[rowKey].id;
        methods.openCves(isOpen, cveName, expandCveDescription);
    }

    handleOnSelect = (event, isSelected, rowId) => {
        const { context } = this.props;
        const { cves, methods } = context;
        const cveName = cves.data[rowId] && cves.data[rowId].id;
        methods.selectCves(isSelected, cveName);
    };

    render() {
        const { context, header } = this.props;
        const { params, cves, methods } = context;
        const { selectedCves, openedCves } = params;
        const rows = cves.data
        .map(cve => (selectedCves.has(cve.id) && { ...cve, selected: true }) || cve)
        .map(cve => (openedCves.has(cve.id) && { ...cve, isOpen: true }) || cve);

        return (
            <Fragment>
                {!cves.isLoading ? (
                    <Fragment>
                        <Table
                            aria-label={'Vulnerability CVE table'}
                            cells={header}
                            rows  ={(cves.data.length === 0)  ? this.noCves() : rows}
                            onSelect ={!(cves.data.length === 0) ? this.handleOnSelect : undefined}
                            actions ={!(cves.data.length === 0) ? systemCveTableRowActions(methods) : undefined}
                            sortBy ={!(cves.data.length === 0) ?
                                createSortBy([{ key: 'collapse' }, { key: 'checkbox' }, ...header], cves.meta.sort) : undefined}
                            onCollapse={!(cves.data.length === 0) ?
                                (event, rowKey, isOpen) => this.handleOnCollapse(event, rowKey, isOpen) : undefined}
                            onSort={!(cves.data.length === 0) ?
                                (event, key, direction) =>
                                    handleSortColumn(
                                        key,
                                        direction,
                                        [{ key: 'collapse' }, { key: 'checkbox' }, ...header],
                                        cves.meta.sort,
                                        methods.apply
                                    ) : undefined
                            }
                            gridBreakPoint={'grid-lg'}
                        >
                            <Fragment>
                                <TableHeader />
                                <TableBody />
                            </Fragment>
                        </Table>
                        <TableToolbar>
                            <PaginationWrapper variant="bottom" meta={cves.meta} apply={methods.apply} />
                        </TableToolbar>
                    </Fragment>
                ) : (
                    <SkeletonTable colSize={2} rowSize={20} />
                )}
            </Fragment>
        );
    }
}

const SystemCvesTable = props => (
    <CVETableContext.Consumer>{context => <SystemCvesTableWithContext context={context} {...props} />}</CVETableContext.Consumer>
);
export default SystemCvesTable;
