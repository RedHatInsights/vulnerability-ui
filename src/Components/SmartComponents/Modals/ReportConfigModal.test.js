import toJson from 'enzyme-to-json';
import { mountWithIntl } from '../../../Helpers/MiscHelper';
import { BrowserRouter as Router } from 'react-router-dom';
import configureStore from 'redux-mock-store';
import { Provider } from "react-redux";
import { useSelector } from 'react-redux';
import ReportConfigModal from './ReportConfigModal';
import { act } from 'react-dom/test-utils';
import { getCveReportFilters, CUSTOM_REPORT_DEFAULT_SORT } from '../../../Helpers/constants';
import { getDefaultFilterData } from '../../../Helpers/ReportsHelper';

jest.mock("react-redux", () => ({
    ...jest.requireActual("react-redux"),
    useSelector: jest.fn()
}));

jest.mock("../../../Helpers/APIHelper.js", () => ({
    ...jest.requireActual("../../../Helpers/APIHelper.js"),
    getOperatingSystems: () => ({})
}));

const customMiddleWare = store => next => action => {
    useSelector.mockImplementation(callback => {
        return callback({ });
    });
    next(action);
}

jest.mock('../../../Helpers/Hooks', () => ({
    ...jest.requireActual('../../../Helpers/Hooks'),
    useFeatureFlag: () => false,
    useHybridSystemFilterFlag: () => false 
}));

const mockStore = configureStore([customMiddleWare]);
const store = mockStore({});
const CVE_REPORT_FILTERS = getCveReportFilters(true);

let wrapper;
beforeEach(() => {
    let columnsToInclude = getDefaultFilterData(true);
    const setColumnsToInclude = (newColumns) => columnsToInclude = newColumns;

    wrapper = mountWithIntl(
        <Provider store={store}>
            <Router>
                <ReportConfigModal
                    isOpen
                    onClose={jest.fn()}
                    filterData={columnsToInclude}
                    sorterData={CUSTOM_REPORT_DEFAULT_SORT}
                    setColumnsToInclude={setColumnsToInclude}
                    columnsToInclude={Object.keys(CVE_REPORT_FILTERS)}
                    userNotes=""
                    globalFilterTags={[]}
                    setFilterData={jest.fn()}
                />
            </Router>
        </Provider>
    );
});

describe('Report config modal component', () => {
    it('Should match snapshots', () => {
        expect(toJson(wrapper)).toMatchSnapshot();
    });

    it('Should pass correct selected columns array according to checkboxes', () => {
        const customColumns = wrapper.find('ToggleGroupItem').at(1).find('button').simulate('click');
        const publishDateColumnCheckbox = wrapper.find('Checkbox').at(2).prop('onChange');
        const columnsToInclude = wrapper.find(ReportConfigModal).prop('columnsToInclude');

        expect(columnsToInclude).toEqual(Object.keys(CVE_REPORT_FILTERS));

        act(() => {
            publishDateColumnCheckbox(false);
            wrapper.update();
        });

        // when publish date is unchecked, it is expected that header contains all columns except publish date
        expect(columnsToInclude).toEqual(Object.keys(CVE_REPORT_FILTERS).splice("publish_date"));

        act(() => {
            publishDateColumnCheckbox(true);
            wrapper.update();
        });

        // check publish date, header should now contain all columns
        expect(columnsToInclude).toEqual(Object.keys(CVE_REPORT_FILTERS));
    });

    it('Should clear state on close', () => {
        const customColumns = wrapper.find('ToggleGroupItem').at(1).find('button').simulate('click');
        const publishDateColumnCheckbox = wrapper.find('Checkbox').at(1).prop('onChange');
        const columnsToInclude = wrapper.find(ReportConfigModal).prop('columnsToInclude');

        act(() => {
            publishDateColumnCheckbox(false);
            wrapper.update();
        });

        expect(columnsToInclude).toEqual(Object.keys(CVE_REPORT_FILTERS).splice("publish_date"));

        act(() =>Â {
            wrapper.find(ReportConfigModal).invoke('onClose')();
        })

        expect(columnsToInclude).toEqual(Object.keys(CVE_REPORT_FILTERS));
    })
});
