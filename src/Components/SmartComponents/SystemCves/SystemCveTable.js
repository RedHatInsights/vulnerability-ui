import React, { Fragment } from 'react';
import propTypes from 'prop-types';
import { Table, TableBody, TableHeader, TableVariant } from '@patternfly/react-table';
import { SkeletonTable } from '@redhat-cloud-services/frontend-components/SkeletonTable';
import { systemCveTableRowActions } from '../../../Helpers/CVEHelper';
import { createSortBy, handleSortColumn } from '../../../Helpers/MiscHelper';
import PaginationWrapper from '../../PresentationalComponents/PaginationWrapper/PaginationWrapper';
import { EmptyStateNoCVEs } from '../../PresentationalComponents/EmptyStates/EmptyStates';
import { CVETableContext } from './SystemCves';
import messages from '../../../Messages';
import { DEFAULT_PAGE_SIZE } from '../../../Helpers/constants';

const SystemCvesTableWithContext = ({ context, header, entity, canSelect }) => {
    const { cves, methods, selectedCves, expandedRows, canEditPairStatus, parameters } = context;

    const noCves = () => {
        return ([{
            heightAuto: true,
            cells: [
                {
                    props: { colSpan: 8 },
                    title: (
                        <EmptyStateNoCVEs secondParagraph={messages.emptyStateThisSystemShouldHaveCVEs} />
                    )
                }
            ]
        }]);
    };

    const handleOnCollapse = (event, rowKey, isOpen) => {
        const { cves, methods, isAllExpanded } = context;
        const cveName = cves.data[rowKey] && cves.data[rowKey].id;
        methods.openCves(isOpen, [cveName], isAllExpanded);
    };

    const handleOnSelect = (event, isSelected, rowId) => {
        const { systemCVEs, methods } = context;
        const cve = systemCVEs.payload.data[rowId / 2];
        methods.selectCves(isSelected, cve);
    };

    const isEmpty = !cves.data || cves.data.length === 0;

    const rows = !isEmpty ? cves.data
        .map(cve => (selectedCves.find(selectedCve => selectedCve.id === cve.id) && { ...cve, selected: true }) || cve)
        .map((cve, index) => {
            const current = index % 2 === 0 ? expandedRows.find(opened => opened.id === cve.id) || false : { isOpen: undefined };
            return ({ ...cve, isOpen: current && current.isOpen });
        }) : [];

    const sortingHeader = [{ key: 'collapse' }, ...canSelect ? [{ key: 'checkbox' }] : [], ...header];

    const onCollapseAll = () => {
        const { cves, methods, isAllExpanded } = context;
        const isOpen = !isAllExpanded;
        const expandedRows = !isAllExpanded ? cves.data.filter(cve => cve.id).map(cve => cve.id) : [];
        methods.openCves(isOpen, expandedRows, !isAllExpanded);
    };

    const onCollapse = (e, rowIndex, isOpen) => {
        const collapseAll = rowIndex === undefined;

        collapseAll
            ? onCollapseAll()
            : handleOnCollapse(e, rowIndex, isOpen);
    };

    return (
        !cves.isLoading ? (
            <Fragment>
                <Table
                    isStickyHeader
                    canCollapseAll
                    canSelectAll={false}
                    aria-label="Vulnerability CVE table"
                    cells={header}
                    rows={isEmpty ? noCves() : rows}
                    onSelect={(canSelect && !isEmpty) ? handleOnSelect : undefined}
                    actionResolver={(!isEmpty && canEditPairStatus) &&
                        ((rowData, rowIndex) => systemCveTableRowActions(methods, entity, rowIndex.rowIndex))}
                    sortBy={isEmpty ? undefined : createSortBy(sortingHeader, parameters.sort)}
                    onCollapse={isEmpty ? undefined : onCollapse}
                    isExpandable
                    onSort={!isEmpty ?
                        (event, key, direction) =>
                            handleSortColumn(
                                key,
                                direction,
                                sortingHeader,
                                parameters.sort,
                                methods.apply
                            ) : undefined
                    }
                    gridBreakPoint="grid-lg"
                    ouiaId="cves-table"
                    variant={TableVariant.compact}
                >
                    <Fragment>
                        <TableHeader />
                        <TableBody />
                    </Fragment>
                </Table>
                <PaginationWrapper meta={cves.meta} apply={methods.apply} />
            </Fragment>
        ) : (
            <SkeletonTable
                columns={header}
                rowSize={DEFAULT_PAGE_SIZE}
                variant={TableVariant.compact}
                sortBy={createSortBy([...canSelect ? [{ key: 'checkbox' }] : [], ...header], parameters.sort)}
                isSelectable={canSelect}
            />
        )
    );
};

SystemCvesTableWithContext.propTypes = {
    context: propTypes.any,
    header: propTypes.array,
    entity: propTypes.string,
    canSelect: propTypes.bool
};

const SystemCvesTable = props => (
    <CVETableContext.Consumer>{context => <SystemCvesTableWithContext context={context} {...props} />}</CVETableContext.Consumer>
);
export default SystemCvesTable;
