import SystemsTableToolbar from './SystemsTableToolbar';
import toJson from 'enzyme-to-json';
import { mountWithIntl } from '../../../Helpers/MiscHelper';
import { BrowserRouter as Router } from 'react-router-dom';
import configureStore from 'redux-mock-store';
import { Provider } from 'react-redux';
import { intl } from '../../../Utilities/IntlProvider';

const mockStore = configureStore([store => next => action => { }]);
let store = mockStore({});

const applyMock = jest.fn();
const handleSelectMock = jest.fn();
const doOptOutMock = jest.fn();

window.insights = {};

const systems = {
    "data": [
        {
            "attributes": {
                "culled_timestamp": "2021-08-03T11:30:29.213465+00:00",
                "cve_count": 1,
                "display_name": "hypervisor.beav",
                "insights_id": "59b3f21a-161e-4037-8c08-86cad1dee1af",
                "inventory_id": "ece17ad9-97db-4480-a486-3eb4edd6c330",
                "last_evaluation": "2021-07-12T17:48:56.770640+00:00",
                "last_upload": "2021-07-19T06:30:29.437396+00:00",
                "opt_out": false,
                "os": "RHEL 8.4",
                "rules_evaluation": "2021-07-19T06:30:31.226597+00:00",
                "stale_timestamp": "2021-07-20T11:30:29.213465+00:00",
                "stale_warning_timestamp": "2021-07-27T11:30:29.213465+00:00",
                "tags": [],
                "updated": "2021-07-19T06:30:29.309802+00:00"
            },
            "id": "ece17ad9-97db-4480-a486-3eb4edd6c330",
            "type": "system",
            "culled_timestamp": "2021-08-03T11:30:29.213465+00:00",
            "cve_count": 1,
            "display_name": "hypervisor.beav",
            "insights_id": "59b3f21a-161e-4037-8c08-86cad1dee1af",
            "inventory_id": "ece17ad9-97db-4480-a486-3eb4edd6c330",
            "last_evaluation": "2021-07-12T17:48:56.770640+00:00",
            "last_upload": "2021-07-19T06:30:29.437396+00:00",
            "opt_out": false,
            "os": "RHEL 8.4",
            "rules_evaluation": "2021-07-19T06:30:31.226597+00:00",
            "stale_timestamp": "2021-07-20T11:30:29.213465+00:00",
            "stale_warning_timestamp": "2021-07-27T11:30:29.213465+00:00",
            "tags": [],
            "updated": "2021-07-19T06:30:29.309802+00:00",
            "selected": false
        },
        {
            "attributes": {
                "culled_timestamp": "2021-08-03T08:47:57.589677+00:00",
                "cve_count": 312,
                "display_name": "client01.apex.example.com",
                "insights_id": "d0828ef3-54b2-4f96-b2fa-0b8b207f59be",
                "inventory_id": "84b763c8-9611-4bf0-9fb8-4f737253b994",
                "last_evaluation": "2021-07-15T13:21:03.229677+00:00",
                "last_upload": "2021-07-19T03:47:57.944472+00:00",
                "opt_out": true,
                "os": "RHEL 7.7",
                "rules_evaluation": "2021-07-19T03:48:02.730175+00:00",
                "stale_timestamp": "2021-07-20T08:47:57.589677+00:00",
                "stale_warning_timestamp": "2021-07-27T08:47:57.589677+00:00",
                "tags": [],
                "updated": "2021-07-19T03:47:57.719803+00:00"
            },
            "id": "84b763c8-9611-4bf0-9fb8-4f737253b994",
            "type": "system",
            "culled_timestamp": "2021-08-03T08:47:57.589677+00:00",
            "cve_count": 312,
            "display_name": "client01.apex.example.com",
            "insights_id": "d0828ef3-54b2-4f96-b2fa-0b8b207f59be",
            "inventory_id": "84b763c8-9611-4bf0-9fb8-4f737253b994",
            "last_evaluation": "2021-07-15T13:21:03.229677+00:00",
            "last_upload": "2021-07-19T03:47:57.944472+00:00",
            "opt_out": true,
            "os": "RHEL 7.7",
            "rules_evaluation": "2021-07-19T03:48:02.730175+00:00",
            "stale_timestamp": "2021-07-20T08:47:57.589677+00:00",
            "stale_warning_timestamp": "2021-07-27T08:47:57.589677+00:00",
            "tags": [],
            "updated": "2021-07-19T03:47:57.719803+00:00",
            "selected": false
        },
        {
            "attributes": {
                "culled_timestamp": "2021-07-28T19:54:01.447925+00:00",
                "cve_count": 26,
                "display_name": "edge-host-1",
                "insights_id": "1681bf3f-aed5-43e7-af58-323fc1c823ec",
                "inventory_id": "9ad25b17-b805-437b-8fc3-074559c453b8",
                "last_evaluation": "2021-07-13T14:50:39.561196+00:00",
                "last_upload": "2021-07-13T14:54:01.669222+00:00",
                "opt_out": false,
                "os": "RHEL 8.4",
                "rules_evaluation": null,
                "stale_timestamp": "2021-07-14T19:54:01.447925+00:00",
                "stale_warning_timestamp": "2021-07-21T19:54:01.447925+00:00",
                "tags": [],
                "updated": "2021-07-19T00:16:35.573546+00:00"
            },
            "id": "9ad25b17-b805-437b-8fc3-074559c453b8",
            "type": "system",
            "culled_timestamp": "2021-07-28T19:54:01.447925+00:00",
            "cve_count": 26,
            "display_name": "edge-host-1",
            "insights_id": "1681bf3f-aed5-43e7-af58-323fc1c823ec",
            "inventory_id": "9ad25b17-b805-437b-8fc3-074559c453b8",
            "last_evaluation": "2021-07-13T14:50:39.561196+00:00",
            "last_upload": "2021-07-13T14:54:01.669222+00:00",
            "opt_out": false,
            "os": "RHEL 8.4",
            "rules_evaluation": null,
            "stale_timestamp": "2021-07-14T19:54:01.447925+00:00",
            "stale_warning_timestamp": "2021-07-21T19:54:01.447925+00:00",
            "tags": [],
            "updated": "2021-07-19T00:16:35.573546+00:00",
            "selected": false
        },
        {
            "attributes": {
                "culled_timestamp": "2021-07-29T22:11:39.837980+00:00",
                "cve_count": 75,
                "display_name": "rhel7-insights-client-prod.virbr0.akofink-laptop",
                "insights_id": "256c458f-bdc0-4603-95a3-4031bced2309",
                "inventory_id": "ae7a9d76-ccc8-44d8-b8f0-692199199f10",
                "last_evaluation": "2021-07-15T13:22:48.155894+00:00",
                "last_upload": "2021-07-14T17:11:40.174162+00:00",
                "opt_out": false,
                "os": "RHEL 7.9",
                "rules_evaluation": "2021-07-14T17:11:42.407959+00:00",
                "stale_timestamp": "2021-07-15T22:11:39.837980+00:00",
                "stale_warning_timestamp": "2021-07-22T22:11:39.837980+00:00",
                "tags": [],
                "updated": "2021-07-17T00:27:34.357294+00:00"
            },
            "id": "ae7a9d76-ccc8-44d8-b8f0-692199199f10",
            "type": "system",
            "culled_timestamp": "2021-07-29T22:11:39.837980+00:00",
            "cve_count": 75,
            "display_name": "rhel7-insights-client-prod.virbr0.akofink-laptop",
            "insights_id": "256c458f-bdc0-4603-95a3-4031bced2309",
            "inventory_id": "ae7a9d76-ccc8-44d8-b8f0-692199199f10",
            "last_evaluation": "2021-07-15T13:22:48.155894+00:00",
            "last_upload": "2021-07-14T17:11:40.174162+00:00",
            "opt_out": false,
            "os": "RHEL 7.9",
            "rules_evaluation": "2021-07-14T17:11:42.407959+00:00",
            "stale_timestamp": "2021-07-15T22:11:39.837980+00:00",
            "stale_warning_timestamp": "2021-07-22T22:11:39.837980+00:00",
            "tags": [],
            "updated": "2021-07-17T00:27:34.357294+00:00",
            "selected": false
        },
        {
            "attributes": {
                "culled_timestamp": "2021-07-30T11:36:36.331980+00:00",
                "cve_count": 230,
                "display_name": "vm-9-105.lab.eng.tlv2.redhat.com",
                "insights_id": "2f6e5414-514d-4641-a075-1a5eb1effcf9",
                "inventory_id": "721d9b9f-0db5-46f4-ba71-5611d6c12887",
                "last_evaluation": "2021-07-15T13:25:27.030126+00:00",
                "last_upload": "2021-07-15T06:36:36.414039+00:00",
                "opt_out": false,
                "os": "RHEL 7.2",
                "rules_evaluation": "2021-07-15T06:36:45.513187+00:00",
                "stale_timestamp": "2021-07-16T11:36:36.331980+00:00",
                "stale_warning_timestamp": "2021-07-23T11:36:36.331980+00:00",
                "tags": [
                    {
                        "key": "location",
                        "namespace": "satellite",
                        "value": "Default Location"
                    },
                    {
                        "key": "content_view",
                        "namespace": "satellite",
                        "value": "Default Organization View"
                    },
                    {
                        "key": "organization",
                        "namespace": "satellite",
                        "value": "Default Organization"
                    },
                    {
                        "key": "activation_key",
                        "namespace": "satellite",
                        "value": "ak1"
                    },
                    {
                        "key": "organization_id",
                        "namespace": "satellite",
                        "value": "1"
                    },
                    {
                        "key": "lifecycle_environment",
                        "namespace": "satellite",
                        "value": "Library"
                    },
                    {
                        "key": "satellite_instance_id",
                        "namespace": "satellite",
                        "value": "7f4a0df3-7bba-4d5c-ad19-78c08fb0feea"
                    }
                ],
                "updated": "2021-07-15T06:36:36.369265+00:00"
            },
            "id": "721d9b9f-0db5-46f4-ba71-5611d6c12887",
            "type": "system",
            "culled_timestamp": "2021-07-30T11:36:36.331980+00:00",
            "cve_count": 230,
            "display_name": "vm-9-105.lab.eng.tlv2.redhat.com",
            "insights_id": "2f6e5414-514d-4641-a075-1a5eb1effcf9",
            "inventory_id": "721d9b9f-0db5-46f4-ba71-5611d6c12887",
            "last_evaluation": "2021-07-15T13:25:27.030126+00:00",
            "last_upload": "2021-07-15T06:36:36.414039+00:00",
            "opt_out": false,
            "os": "RHEL 7.2",
            "rules_evaluation": "2021-07-15T06:36:45.513187+00:00",
            "stale_timestamp": "2021-07-16T11:36:36.331980+00:00",
            "stale_warning_timestamp": "2021-07-23T11:36:36.331980+00:00",
            "tags": [
                {
                    "key": "location",
                    "namespace": "satellite",
                    "value": "Default Location"
                },
                {
                    "key": "content_view",
                    "namespace": "satellite",
                    "value": "Default Organization View"
                },
                {
                    "key": "organization",
                    "namespace": "satellite",
                    "value": "Default Organization"
                },
                {
                    "key": "activation_key",
                    "namespace": "satellite",
                    "value": "ak1"
                },
                {
                    "key": "organization_id",
                    "namespace": "satellite",
                    "value": "1"
                },
                {
                    "key": "lifecycle_environment",
                    "namespace": "satellite",
                    "value": "Library"
                },
                {
                    "key": "satellite_instance_id",
                    "namespace": "satellite",
                    "value": "7f4a0df3-7bba-4d5c-ad19-78c08fb0feea"
                }
            ],
            "updated": "2021-07-15T06:36:36.369265+00:00",
            "selected": false
        },
        {
            "attributes": {
                "culled_timestamp": "2021-07-30T10:43:32.150325+00:00",
                "cve_count": 7,
                "display_name": "dhcp-2-44.vms.sat.rdu2.redhat.com",
                "insights_id": "8e7e7f2d-5976-4ee6-8980-93a9be31fd23",
                "inventory_id": "57c715fd-c49c-4c0d-81bc-f95599cd28f8",
                "last_evaluation": "2021-07-15T13:26:41.499289+00:00",
                "last_upload": "2021-07-15T05:43:32.222723+00:00",
                "opt_out": false,
                "os": "RHEL 7.9",
                "rules_evaluation": "2021-07-15T05:43:33.156583+00:00",
                "stale_timestamp": "2021-07-16T10:43:32.150325+00:00",
                "stale_warning_timestamp": "2021-07-23T10:43:32.150325+00:00",
                "tags": [
                    {
                        "key": "location",
                        "namespace": "satellite",
                        "value": "Default Location"
                    },
                    {
                        "key": "content_view",
                        "namespace": "satellite",
                        "value": "Default Organization View"
                    },
                    {
                        "key": "organization",
                        "namespace": "satellite",
                        "value": "Default Organization"
                    },
                    {
                        "key": "activation_key",
                        "namespace": "satellite",
                        "value": "testak"
                    },
                    {
                        "key": "organization_id",
                        "namespace": "satellite",
                        "value": "1"
                    },
                    {
                        "key": "lifecycle_environment",
                        "namespace": "satellite",
                        "value": "Library"
                    },
                    {
                        "key": "satellite_instance_id",
                        "namespace": "satellite",
                        "value": "86a737d0-73d3-5e3a-b43e-b5fa0883ed27"
                    }
                ],
                "updated": "2021-07-15T05:43:32.183233+00:00"
            },
            "id": "57c715fd-c49c-4c0d-81bc-f95599cd28f8",
            "type": "system",
            "culled_timestamp": "2021-07-30T10:43:32.150325+00:00",
            "cve_count": 7,
            "display_name": "dhcp-2-44.vms.sat.rdu2.redhat.com",
            "insights_id": "8e7e7f2d-5976-4ee6-8980-93a9be31fd23",
            "inventory_id": "57c715fd-c49c-4c0d-81bc-f95599cd28f8",
            "last_evaluation": "2021-07-15T13:26:41.499289+00:00",
            "last_upload": "2021-07-15T05:43:32.222723+00:00",
            "opt_out": false,
            "os": "RHEL 7.9",
            "rules_evaluation": "2021-07-15T05:43:33.156583+00:00",
            "stale_timestamp": "2021-07-16T10:43:32.150325+00:00",
            "stale_warning_timestamp": "2021-07-23T10:43:32.150325+00:00",
            "tags": [
                {
                    "key": "location",
                    "namespace": "satellite",
                    "value": "Default Location"
                },
                {
                    "key": "content_view",
                    "namespace": "satellite",
                    "value": "Default Organization View"
                },
                {
                    "key": "organization",
                    "namespace": "satellite",
                    "value": "Default Organization"
                },
                {
                    "key": "activation_key",
                    "namespace": "satellite",
                    "value": "testak"
                },
                {
                    "key": "organization_id",
                    "namespace": "satellite",
                    "value": "1"
                },
                {
                    "key": "lifecycle_environment",
                    "namespace": "satellite",
                    "value": "Library"
                },
                {
                    "key": "satellite_instance_id",
                    "namespace": "satellite",
                    "value": "86a737d0-73d3-5e3a-b43e-b5fa0883ed27"
                }
            ],
            "updated": "2021-07-15T05:43:32.183233+00:00",
            "selected": false
        }
    ],
    "meta": {
        "total_items": 2
    }
}

let wrapper;

beforeEach(() => {
    wrapper = mountWithIntl(
        <Provider store={store}>
            <Router>
                <SystemsTableToolbar
                    intl={intl}
                    methods={{
                        apply: applyMock,
                        handleSelect: handleSelectMock,
                        doOptOut: doOptOutMock
                    }}
                    selectedRows={[]}
                    selectedRowsRawData={[]}
                    parameters={{
                        excluded: "false",
                        page: 1,
                        page_size: 20,
                        sort: "-updated"
                    }}
                    items={{ data: systems.data, meta: { totalItems: 10 } }}
                />
            </Router>
        </Provider>
    );
});

describe('SystemsTableToolbar component', () => {
    it('Should match snapshot', () => {
        expect(toJson(wrapper)).toMatchSnapshot();
    });

    it('Select all systems', () => {
        const selectAllToggle = wrapper.find('DropdownToggle button').first();
        selectAllToggle.simulate('click');

        wrapper.find('Dropdown').first().find("button").at(2).simulate('click');

        expect(handleSelectMock).toHaveBeenCalledWith(
            [
                { id: "ece17ad9-97db-4480-a486-3eb4edd6c330", selected: true },
                { id: "84b763c8-9611-4bf0-9fb8-4f737253b994", selected: true },
                { id: "9ad25b17-b805-437b-8fc3-074559c453b8", selected: true },
                { id: "ae7a9d76-ccc8-44d8-b8f0-692199199f10", selected: true },
                { id: "721d9b9f-0db5-46f4-ba71-5611d6c12887", selected: true },
                { id: "57c715fd-c49c-4c0d-81bc-f95599cd28f8", selected: true }
            ]
        );

    });

    it('Should exclude the selected system', () => {
        wrapper = mountWithIntl(
            <Provider store={store}>
                <Router>
                    <SystemsTableToolbar
                        intl={intl}
                        methods={{
                            apply: applyMock,
                            handleSelect: handleSelectMock,
                            doOptOut: doOptOutMock
                        }}
                        selectedRows={{ "ece17ad9-97db-4480-a486-3eb4edd6c330": true }}
                        selectedRowsCount={1}
                        selectedRowsRawData={[{ id: 'ece17ad9-97db-4480-a486-3eb4edd6c330', opt_out: false }]}
                        totalSelectedRows={1}
                        parameters={{
                            excluded: "false",
                            page: 1,
                            page_size: 20,
                            sort: "-updated"
                        }}
                        items={{ data: systems.data, meta: { totalItems: 10 } }}
                    />
                </Router>
            </Provider>
        );

        const actionsToggle = wrapper.find('KebabToggle button');
        actionsToggle.simulate('click');

        const exclude = wrapper.find('Dropdown').at(3).find("DropdownItem button").at(0)
        const include = wrapper.find('Dropdown').at(3).find("DropdownItem button").at(1);

        exclude.simulate('click');

        expect(include.props('disabled')).toBeTruthy();
        expect(exclude.text()).toBe('Exclude system from vulnerability analysis');
        expect(doOptOutMock).toHaveBeenCalled();
    })

    it('Should include the excluded selected system', () => {
        wrapper = mountWithIntl(
            <Provider store={store}>
                <Router>
                    <SystemsTableToolbar
                        intl={intl}
                        methods={{
                            apply: applyMock,
                            handleSelect: handleSelectMock,
                            doOptOut: doOptOutMock
                        }}
                        selectedRows={{ "84b763c8-9611-4bf0-9fb8-4f737253b994": true }}
                        selectedRowsCount={1}
                        selectedRowsRawData={[{ id: '84b763c8-9611-4bf0-9fb8-4f737253b994', opt_out: false }]}
                        parameters={{
                            excluded: "false",
                            page: 1,
                            page_size: 20,
                            sort: "-updated"
                        }}
                        items={{ data: systems.data, meta: { totalItems: 10 } }}
                    />
                </Router>
            </Provider>
        );

        const actionsToggle = wrapper.find('KebabToggle button');
        actionsToggle.simulate('click');


        const exclude = wrapper.find('Dropdown').at(3).find("DropdownItem button").at(0)
        const include = wrapper.find('Dropdown').at(3).find("DropdownItem button").at(1);

        include.simulate('click');

        expect(exclude.props('disabled')).toBeTruthy();
        expect(include.text()).toBe('Include system in vulnerability analysis');
        expect(doOptOutMock).toHaveBeenCalled();
    })

});
