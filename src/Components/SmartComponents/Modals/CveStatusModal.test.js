import React from 'react';
import { Provider } from 'react-redux';
import * as deps from '../../../Helpers/APIHelper';
import { updateRef } from '../../../Helpers/MiscHelper';
import CVEStatusModal from './CveStatusModal';
import ReducerRegistry from '../../../Utilities/ReducerRegistry';
import { fireEvent, render, screen, waitFor } from '@testing-library/react';
import TestWrapper from '../../../Utilities/TestWrapper';
import { CVETableContext } from '../CVEs/CVEs';

const MockStore = ({ children }) => <Provider store={ReducerRegistry.getStore()}>{children}</Provider>;
jest.mock('../../../Helpers/MiscHelper', () => ({
    ...jest.requireActual('../../../Helpers/MiscHelper'),
    updateRef: jest.fn()
}));

const mockContext = {
    cves: {
        isLoading: false,
        meta: {
            page: 1
        },
    },
    params: {
        advisory_available: 'true',
        affecting: 'system1',
        sort: '-public_date'
    },
    methods: {
        apply: jest.fn()
    }
};

describe('CveStatusModal component', () => {
    it('should render with one CVE selected', () => {
        const setCveStatusMock = jest.fn(parameters => new Promise(resolve => resolve(parameters)));
        const setSystemCveStatusMock = jest.fn(parameters => new Promise(resolve => resolve(parameters)));

        deps.setCveStatus = setCveStatusMock; // CVE status
        deps.setSystemCveStatus = setSystemCveStatusMock; // CVE-system pair status, only call when checkbox is unchecked

        const cveList = [{
            id: "CVE-2020-0001",
            status_id: "3",
            justification: "old justification"
        }];

        render(
            <MockStore>
                <TestWrapper>
                    <CVEStatusModal open cves={cveList} canEditPairStatus={true} />
                </TestWrapper>
            </MockStore>
        );

        const statusDropdown              = screen.getByRole('combobox', { name: /select input/i });
        const justificationNote           = screen.getByRole('textbox', { name: /justification note/i });
        const saveButton                  = screen.getByRole('button', { name: /save/i });

        fireEvent.click(statusDropdown);
        screen.getByRole('option', { name: 'No action - risk accepted' });
        fireEvent.change(justificationNote, { target: { value: 'new justification' } });
        fireEvent.click(saveButton);

        expect(setCveStatusMock).toBeCalledWith({
            cve: ['CVE-2020-0001'],
            status_id: 3,
            status_text: 'new justification'
        });
    });

    it('should render with multiple CVEs selected', async () => {
        const setCveStatusMock = jest.fn(parameters => new Promise(resolve => resolve(parameters)));
        const setSystemCveStatusMock = jest.fn(parameters => new Promise(resolve => resolve(parameters)));

        deps.setCveStatus = setCveStatusMock; // CVE status
        deps.setSystemCveStatus = setSystemCveStatusMock; // CVE-system pair status, only call when checkbox is unchecked

        const testContext = { ...mockContext, cves: { meta: { page: 2 }}};
        const cveList2 = [
            {
                id: "CVE-2020-0001",
                status_id: "3",
                justification: "test"
            },
            {
                id: "CVE-2020-0002",
                status_id: "4",
                justification: "test2"
            }
        ];

        render(
            <MockStore>
                <TestWrapper>
                    <CVETableContext.Provider value={testContext}>
                        <CVEStatusModal open cves={cveList2} canEditPairStatus={true} />
                    </CVETableContext.Provider>
                </TestWrapper>
            </MockStore>
        );

        const statusDropdown              = screen.getByRole('combobox', { name: /select input/i });
        const justificationNote           = screen.getByRole('textbox', { name: /justification note/i });
        const saveButton                  = screen.getByRole('button', { name: /save/i });

        fireEvent.click(statusDropdown);
        screen.getByRole('option', { name: 'On-hold' });
        fireEvent.change(justificationNote, { target: { value: 'new justification' } });
        fireEvent.click(saveButton);

        expect(setCveStatusMock).toBeCalledWith({
            cve: ['CVE-2020-0001', 'CVE-2020-0002'],
            status_id: 0,
            status_text: 'new justification'
        });

        await waitFor(() => expect(updateRef).toHaveBeenCalledWith({ page: 2 }, mockContext.params, mockContext.methods.apply));
    });
    it('should call updateRef with goToFirstPage', async () => {
        const setCveStatusMock = jest.fn(parameters => new Promise(resolve => resolve(parameters)));
        const setSystemCveStatusMock = jest.fn(parameters => new Promise(resolve => resolve(parameters)));

        deps.setCveStatus = setCveStatusMock; // CVE status
        deps.setSystemCveStatus = setSystemCveStatusMock; // CVE-system pair status, only call when checkbox is unchecked

        const testContext = { ...mockContext, cves: { meta: { page: 2 }}};
        const cveList2 = [
            {
                id: "CVE-2020-0001",
                status_id: "3",
                justification: "test"
            },
            {
                id: "CVE-2020-0002",
                status_id: "4",
                justification: "test2"
            }
        ];

        render(
            <MockStore>
                <TestWrapper>
                    <CVETableContext.Provider value={testContext}>
                        <CVEStatusModal open cves={cveList2} goToFirstPage={true} canEditPairStatus={true} />
                    </CVETableContext.Provider>
                </TestWrapper>
            </MockStore>
        );

        const statusDropdown              = screen.getByRole('combobox', { name: /select input/i });
        const justificationNote           = screen.getByRole('textbox', { name: /justification note/i });
        const saveButton                  = screen.getByRole('button', { name: /save/i });

        fireEvent.click(statusDropdown);
        screen.getByRole('option', { name: 'On-hold' });
        fireEvent.change(justificationNote, { target: { value: 'new justification' } });
        fireEvent.click(saveButton);

        await waitFor(() => expect(updateRef).toHaveBeenCalledWith({ page: 1 }, mockContext.params, mockContext.methods.apply));
    });
});
