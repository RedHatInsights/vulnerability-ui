import toJson from 'enzyme-to-json';
import { mountWithIntl } from '../../../Helpers/MiscHelper';
import { BrowserRouter as Router } from 'react-router-dom';
import configureStore from 'redux-mock-store';
import { Provider } from "react-redux";
import ReportsPage from './ReportsPage';
import { useSelector } from 'react-redux';
import { render, screen, waitFor } from '@testing-library/react';
import { useFeatureFlag } from '../../../Helpers/Hooks';
import { ComponentWithContext } from '../../../Utilities/TestingUtilities';

/* Mock function returning permissions */
jest.mock('../../../Helpers/Hooks', () => ({
    ...jest.requireActual('../../../Helpers/Hooks'),
    useRbac: () => [[true, true, true], false],
    useFeatureFlag: jest.fn(() => false)
}));

jest.mock("react-redux", () => ({
    ...jest.requireActual("react-redux"),
    useSelector: jest.fn()
}));

jest.mock("../../../Helpers/APIHelper.js", () => ({
    ...jest.requireActual("../../../Helpers/APIHelper.js"),
    getOperatingSystems: () => ({}),
    getCveListByAccount: () => new Promise(() => {}, () => {})
}));

const state = {
    parameters: {}
}

const customMiddleWare = store => next => action => {
    useSelector.mockImplementation(callback => {
        return callback({ ReportsPageStore: state });
    });
    next(action);
}

const mockStore = configureStore([customMiddleWare]);

const store = mockStore(state);

let wrapper;
beforeEach(() => {
    store.clearActions();
    useSelector.mockImplementation(callback => {
        return callback({ ReportsPageStore: state });
    });

    wrapper = mountWithIntl(
        <Provider store={store}>
            <Router>
                <ReportsPage />
            </Router>
        </Provider>
    );
});

describe('Reports page component', () => {
    it('Should match snapshots', () => {
        expect(toJson(wrapper)).toMatchSnapshot();
    });

    it('Should open configuration modal upon clicking button in the second card and close upon clicking cancel.', () => {
        wrapper.find('.create-report').simulate('click');
        expect(wrapper.find('ReportConfigModal').props().isOpen).toBeTruthy();

        wrapper.find('ReportConfigModal').find('button').last().simulate('click')
        expect(wrapper.find('ReportConfigModal').props().isOpen).toBeFalsy();
    });

    it('Should open configuration modal upon clicking button in the second card and close and start download upon clicking export.', () => {
        expect(wrapper.find('DownloadCVEsReport')).toHaveLength(0);

        wrapper.find('.create-report').simulate('click');
        expect(wrapper.find('ReportConfigModal').props().isOpen).toBeTruthy();

        const buttons = wrapper.find('ReportConfigModal').find('button');
        buttons.at(buttons.length - 1).simulate('click');

        expect(wrapper.find('ReportConfigModal').props().isOpen).toBeFalsy();
    });

    it('Should pass enabled feature flag to DownloadCvesReport.', async () => {
        useFeatureFlag.mockReturnValue(true);

        render(<ComponentWithContext Component={ReportsPage}/>)
        await screen.findByLabelText('Custom report button').click();
        await waitFor(() => {
            screen.findByLabelText('Handle download button')
        });
        
        screen.findByLabelText('Handle download button').click();

        await waitFor(() => {
            screen.findByLabelText('Download CVEs Report');

        });

       expect(screen.findByLabelText('Download CVEs Report')).toHaveBeenCalledWith({});
    });
});
