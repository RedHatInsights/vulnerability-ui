import { ExternalLinkAltIcon } from '@patternfly/react-icons';
import { StatusDropdown } from '@red-hat-insights/insights-frontend-components';
import { processDate } from '@red-hat-insights/insights-frontend-components/Utilities/helpers';
import React from 'react';
import { createApiCall } from './APIHelper';

export function getCveDetails(synopsis) {
    let endpoint = '/cves/' + synopsis + '/details/';
    let result = createApiCall(endpoint, 'get');
    return result;
}

export function getAffectedSystemsByCVE(synopsis) {
    let endpoint = '/cves/' + synopsis + '/affectedsystems/';
    let result = createApiCall(endpoint, 'get');
    return result;
}

export function createExposedSystemsTable(affectedSystems) {
    let isLoading = affectedSystems.isLoading;
    if (!isLoading) {
        let payload = affectedSystems.payload.asMutable();
        let { data, meta } = payload;
        const dataWithStatus = data.map(item => ({
            ...item,
            attributes: {
                ...item.attributes,
                status: (
                    <span>
                        <StatusDropdown
                            currentStatusName={item.attributes.status_name}
                            currentStatusId={item.attributes.status_id}
                            systemId={item.id}
                            cveName={affectedSystems.cve}
                        />
                    </span>
                )
            }
        }));
        return { data: dataWithStatus, meta, isLoading };
    }

    return { data: (affectedSystems.payload && affectedSystems.payload.data) || [], meta: {}, isLoading };
}

export function createCveDetailsPage(cves) {
    let isLoading = cves.isLoading;
    if (!isLoading) {
        let payload = cves.payload.asMutable();
        let { data, meta } = payload;

        data = {
            impact: data.attributes.impact,
            public_date: processDate(data.attributes.public_date),
            description: data.attributes.description,
            synopsis: data.attributes.synopsis,
            package_list: data.attributes.package_list.map(item => <li key={item}>{item}</li>),
            rh_link: createRHDBLink(data.attributes.synopsis),
            mitre_link: createMitreLink(data.attributes.synopsis),
            cvss3_score: data.attributes.cvss3_score,
            cvss2_score: data.attributes.cvss2_score
        };
        return { data, meta, isLoading };
    }

    return { data: [], meta: {}, isLoading };
}

export function createRHDBLink(item) {
    return (
        <a target="_blank" rel="noopener noreferrer" href={'https://access.redhat.com/security/cve/' + item}>
            View in Red Hat CVE database <ExternalLinkAltIcon />
        </a>
    );
}

export function createMitreLink(item) {
    return (
        <a target="_blank" rel="noopener noreferrer" href={'https://cve.mitre.org/cgi-bin/cvename.cgi?name=' + item}>
            View in MITRE Database <ExternalLinkAltIcon />
        </a>
    );
}
