import { Checkbox, Form, FormGroup, Stack, StackItem, Alert, Split, Tooltip, SplitItem } from '@patternfly/react-core';
import { OutlinedQuestionCircleIcon } from '@patternfly/react-icons';
import propTypes from 'prop-types';
import React, { useState, useEffect } from 'react';
import { setSystemCveStatus } from '../../../Helpers/APIHelper';
import BaseModal, { useJustificationInput, useStatusSelect } from './BaseModal';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';

export const CvePairStatusModal = ({ cves, updateRef, inventories, hasDifferentStatus = false, intl, type }) => {
    const [cveList] = useState(cves);
    const [inventoryList] = useState(inventories);
    const {
        JustificationInput,
        justification,
        setJustification,
        setProps: setJustificationProps
    } = useJustificationInput(getDefaultLabel());
    const [checkboxState, setCheckboxState] = useState(getDefaultCheckboxState());
    const { StatusSelect, statusId, setStatusId, setProps: setSelectProps } = useStatusSelect(getDefaultStatus());
    const inventoryIds = inventoryList.map(item => item.id);
    const inventoryNames = inventoryList.map(item => item.display_name);

    useEffect(() => {
        setSelectProps({ isDisabled: checkboxState });
        setJustificationProps({ disabled: checkboxState });
        setStatusId(getCveStatus());
        setJustification(getCveJustification());
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [checkboxState, setSelectProps, setJustificationProps]);

    useEffect(() => {
        setStatusId(getCveStatus());
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [checkboxState, setStatusId]);

    const handleSave = () => {
        const cveIds = cveList.map(item => item.id);
        const setStatusParams = !checkboxState
            ? {
                status_id: parseInt(statusId),
                cve: cveIds,
                status_text: justification,
                inventory_id: inventoryIds
            }
            : { cve: cveIds, inventory_id: inventoryIds };
        return setSystemCveStatus(setStatusParams).then(updateRef);
    };

    function getDefaultStatus() {
        // system has different status
        if (inventoryList && inventoryList.length > 0 && inventoryList[0].status_id) {
            return getSystemsStatus();
        }

        if (cveList && cveList.length > 0) {
            return getCveStatus();
        }

    }

    function getDefaultLabel() {
        if (inventoryList && inventoryList.length === 1 && inventoryList[0].justification) {
            return getSystemsJustification();
        }

        if (cveList && cveList.length === 1) {
            return getCveJustification();
        }
    }

    function getDefaultCheckboxState() {

        const haveSameStatuses = cveList.every(
            (val, i, arr) => (val.status_id === arr[0].status_id) && (val.cve_status_id === arr[0].cve_status_id)
        );

        const differFromOverall = cveList.some(item => item.status_id !== item.cve_status_id);
        if (differFromOverall) { return false; }

        // system has the same status as cve
        if (inventoryList && inventoryList.length === 1 && inventoryList[0].status_id) {
            let [inventory] = inventoryList;
            return cveList.some(cve => (cve.status_id === inventory.status_id));
        }

        if (cveList && cveList.length === 1 || haveSameStatuses) {
            return true;
        }

        return false;
    }

    function getSystemsStatus() {
        return (inventoryList && inventoryList[0].status_id.toString()) || '0';
    }

    function getSystemsJustification() {
        return (inventoryList && inventoryList.length === 1 && inventoryList[0].justification) || '';
    }

    function getCveStatus() {
        switch (type) {
            case 'systemsExposed' : {
                return (cveList && cveList.length === 1 && cveList[0].status_id.toString()) || '0';
            }

            case 'systemDetail': {
                if (cveList) {
                    if (checkboxState) { // use overall (CVE) status
                        return hasDifferentStatus ? '0' : cveList[0].cve_status_id || '0';
                    }
                    else { // use system pair status
                        return hasDifferentStatus ? '0' : cveList[0].status_id || '0';
                    }
                }
                else {
                    return '0';
                }
            }

            default: {
                return '0';
            }
        }

    }

    function getCveJustification() {
        switch (type) {
            case 'systemsExposed' : {
                return (cveList && cveList.length === 1 && cveList[0].justification) || '';
            }

            case 'systemDetail': {
                if (checkboxState) { // use overall (CVE) justification
                    return (cveList && cveList.length === 1 && cveList[0].cve_justification) || '';
                }
                else { // use system pair justification; in case all notes are same display it
                    return (cveList && cveList.length > 0
                        && cveList.every(value => value.justification === cveList[0].justification)
                        && cveList[0].justification) || '';
                }
            }

            default: {
                return '';
            }
        }
    }

    const successNotification = {
        variant: 'success',
        title: intl.formatMessage(messages.cvePairStatusModalUpdateSuccessful)
    };

    const modalTitle = intl.formatMessage(messages.cvePairStatusModalTitle, { count: inventoryIds.length * cves.length });

    return (
        <BaseModal items={cveList} onSave={handleSave} onSuccessNotification={successNotification} title={modalTitle}>
            <Stack hasGutter>
                {hasDifferentStatus &&
                    <StackItem>
                        <Alert
                            variant="warning"
                            isInline
                            title={intl.formatMessage(messages.cvePairStatusModalAlert)}
                        />
                    </StackItem>
                }
                <StackItem>
                    {intl.formatMessage(
                        messages.cvePairStatusModalSelected,
                        {
                            cveCount: cveList.length || 0,
                            cveId: cveList[0].id, // only used when length is 1
                            systemCount: inventoryList.length || 0,
                            systemName: inventoryNames[0], // only used when length is 1
                            b: (...chunks) => <b>{chunks}</b> // explicitly specifying what is wrapped <b> should be bold
                        }
                    )}
                </StackItem>
                <StackItem>
                    <Form key="key">
                        <FormGroup fieldId={'overall'}>
                            <Split>
                                <SplitItem>
                                    <Checkbox
                                        label={intl.formatMessage(messages.cvePairStatusModalUseOverallCheckbox)}
                                        id="alt-form-checkbox-1"
                                        name="alt-form-checkbox-1"
                                        isChecked={checkboxState}
                                        onChange={checked => setCheckboxState(checked)}
                                    />
                                </SplitItem>
                                <SplitItem>
                                    <Tooltip
                                        trigger='mouseenter focus click'
                                        content={intl.formatMessage(messages.cvePairStatusModalUseOverallTooltip)}
                                    >
                                        <OutlinedQuestionCircleIcon
                                            className="pf-u-ml-xs"
                                            color="var(--pf-global--Color--200)"
                                            style={{ verticalAlign: '0' }}
                                        />
                                    </Tooltip>
                                </SplitItem>
                            </Split>
                        </FormGroup>
                        {StatusSelect}
                        {JustificationInput}
                    </Form>
                </StackItem>
            </Stack>
        </BaseModal>
    );
};

CvePairStatusModal.propTypes = {
    cves: propTypes.array,
    updateRef: propTypes.func,
    inventories: propTypes.array,
    hasDifferentStatus: propTypes.bool,
    intl: propTypes.any,
    type: propTypes.string
};

export default injectIntl(CvePairStatusModal);
