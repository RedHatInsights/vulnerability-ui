import React from 'react';
import propTypes from 'prop-types';
import { useSelector } from 'react-redux';
import { ConnectedSystemCves } from '../SystemCves/SystemCves';
import {
    EmptyStateExcludedSystem,
    NotAuthorized
} from '../../PresentationalComponents/EmptyStates/EmptyStates';
import { intl } from '../../../Utilities/IntlProvider';
import messages from '../../../Messages';
import { PERMISSIONS, SERVICE_NAME } from '../../../Helpers/constants';
import { useRbac } from '../../../Helpers/Hooks';
import PageLoading from '../../PresentationalComponents/Snippets/PageLoading';

const SystemDetails = ({ optOutSystemHandler }) => {
    const { loaded, opt_out: isOptOut } = useSelector(({ SystemDetailsPageStore }) => SystemDetailsPageStore) ?? {};
    const { entity } = useSelector(state => state.entityDetails) ?? {};

    const [[
        canExport,
        canReadVulnerabilityResults,
        canEditPairStatus,
        canReadExcluded
    ], isRbacLoading] = useRbac([
        PERMISSIONS.basicReporting,
        PERMISSIONS.readVulnerabilityResults,
        PERMISSIONS.setPairStatus,
        PERMISSIONS.readExcluded]
    );

    if (isRbacLoading) {
        return <PageLoading />;
    } else if (canReadVulnerabilityResults) {
        if (entity && loaded && isOptOut) {
            if (canReadExcluded) {
                return <EmptyStateExcludedSystem buttonAction={() => optOutSystemHandler(entity.display_name, false)} />;
            } else {
                return <NotAuthorized title={intl.formatMessage(messages.notAuthorizedNoAccessForSystem)} />;
            }
        } else if (entity) {
            return <ConnectedSystemCves
                entity={{ id: entity?.id, display_name: entity?.display_name, insights_id: entity?.insights_id }}
                showHeaderLabel
                setPageTitle
                canExport={canExport}
                canEditPairStatus={canEditPairStatus}
            />;
        } else {
            return loaded ? null : <PageLoading />;
        }
    } else {
        return <NotAuthorized serviceName={SERVICE_NAME} />;
    }
};

SystemDetails.propTypes = {
    optOutSystemHandler: propTypes.func
};

export default SystemDetails;
