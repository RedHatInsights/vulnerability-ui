import React, { useMemo } from 'react';
import propTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';
import { CVETableContext } from './SystemCves';
import Remediation from '../Remediation/Remediation';
import selectAllCheckbox from '../../../Helpers/selectAllCheckboxHelper';
import { PrimaryToolbar } from '@redhat-cloud-services/frontend-components/PrimaryToolbar';
import publishDateFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/PublishDateFilter';
import useCvssBaseScoreFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/CvssBaseScoreFilter';
import impactFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/ImpactFilter';
import useSearchFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SearchFilter';
import securityRuleFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SecurityRuleFilter';
import businessRiskFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/BusinessRiskFilter';
import knownExploitFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/KnownExploitFilter';
import statusFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/StatusFilter';
import remediationFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/RemediationFilter';
import {
    handleChangePage,
    handleSetPageSize,
    exportConfig,
    buildActiveFilters,
    removeFilters,
    isFilterInDefaultState
} from '../../../Helpers/TableToolbarHelper';
import {
    ANSIBLE_REMEDIATION,
    ONLY_NON_VULNERABLE_SYSTEMS,
    RULE_PRESENCE_OPTIONS,
    SYSTEM_DETAILS_FILTER_PARAMS
} from '../../../Helpers/constants';
import advisoryAvailabilityFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/AdvisoryAvailabilityFilter';

const SystemCveToolbarWithContext = ({
    entity,
    intl,
    context,
    canExport,
    customAction,
    canSelect,
    canManageColumns,
    filters,
    showingCvesWithoutErrata
}) => {
    const { cves, systemCVEs, parameters, methods, selectedCves, canEditPairStatus } = context;
    const { filter, advisory } = parameters;
    const selectedCvesCount = selectedCves?.length ?? 0;
    const remediableCves = selectedCves.filter(cves => cves.remediation === ANSIBLE_REMEDIATION);

    const selectOptions = useMemo(() => selectAllCheckbox({
        selectedItems: selectedCves,
        selectorHandler: methods.selectCves,
        items: cves,
        rawItems: systemCVEs,
        fetchResource: ops => methods.bulkFetchResource({ ...parameters, ...ops }),
        multiRow: true
    }), [selectedCves, cves, systemCVEs, parameters, methods]);

    const actions = ['',
        ...canEditPairStatus ?
            [{
                label: intl.formatMessage(messages.editStatus),
                onClick: () => methods.showStatusModal(selectedCves, true),
                props: { isDisabled: !selectedCvesCount }
            }] : [],
        ...canManageColumns ?
            [{
                label: intl.formatMessage(messages.columnManagementModalTitle),
                onClick: () => methods.setColumnManagementModalOpen(true)
            }] : []
    ];

    const allFilters = [
        useSearchFilter('filter', messages.cve, messages.searchFilterByCveID, filter, methods.apply),
        securityRuleFilter(methods.apply, parameters, [],
            {
                isDynamic: false,
                dropdownItems: RULE_PRESENCE_OPTIONS.filter(item => item.value !== ONLY_NON_VULNERABLE_SYSTEMS)
            }),
        knownExploitFilter(methods.apply, parameters),
        impactFilter(methods.apply, parameters),
        useCvssBaseScoreFilter(methods.apply, parameters),
        businessRiskFilter(methods.apply, parameters),
        publishDateFilter(methods.apply, parameters),
        statusFilter(methods.apply, parameters),
        ...showingCvesWithoutErrata ? [advisoryAvailabilityFilter(methods.apply, parameters)] : [],
        useSearchFilter('advisory', messages.advisoryName, messages.searchFilterByAdvisoryName, advisory, methods.apply),
        remediationFilter(methods.apply, parameters)
    ];

    const defaultFilters = {
        ...(showingCvesWithoutErrata)
            ? { advisory_available: 'true' }
            : {}
    };

    return (
        <PrimaryToolbar
            pagination={{
                isDisabled: cves.meta.total_items === 0,
                itemCount: cves.meta.total_items || 0,
                page: cves.meta.page || 1,
                perPage: cves.meta.page_size || 1,
                ouiaId: 'pagination-top',
                onSetPage: (_event, page) => handleChangePage(_event, page, methods.apply),
                onPerPageSelect: (_event, perPage) => handleSetPageSize(_event, perPage, methods.apply)
            }}
            dedicatedAction={customAction ? (typeof customAction === 'function' ? customAction(cves) : customAction) : (entity &&
                <Remediation
                    isDisabled={selectedCves.length === 0}
                    systems={entity}
                    cves={remediableCves}
                />)}
            actionsConfig={{
                actions,
                dropdownProps: { ouiaId: 'toolbar-actions' }
            }}
            bulkSelect={canSelect && {
                count: selectedCvesCount,
                items: selectOptions.items,
                isDisabled: cves.meta.total_items === 0 && selectedCvesCount === 0,
                checked: Boolean(selectedCvesCount),
                ouiaId: 'bulk-select',
                onSelect: () => selectOptions.handleOnCheckboxChange()
            }}
            filterConfig={{
                items: filters ? allFilters.filter(filter => filters.includes(filter.key)) : allFilters
            }}
            activeFiltersConfig={{
                filters: buildActiveFilters(parameters),
                onDelete: (_, chips, reset) => removeFilters(chips, methods.apply, reset, defaultFilters),
                deleteTitle: intl.formatMessage(messages.resetFilters),
                showDeleteButton: !isFilterInDefaultState(parameters, defaultFilters, SYSTEM_DETAILS_FILTER_PARAMS)
            }}
            exportConfig={canExport && {
                isDisabled: cves.meta.total_items === 0,
                ouiaId: 'export',
                ...exportConfig(methods)
            }}
        />
    );
};

SystemCveToolbarWithContext.propTypes = {
    entity: propTypes.string,
    context: propTypes.object,
    intl: propTypes.any,
    canExport: propTypes.bool,
    customAction: propTypes.oneOf([propTypes.node, propTypes.func]),
    canSelect: propTypes.bool,
    canManageColumns: propTypes.bool,
    filters: propTypes.arrayOf(propTypes.string),
    showingCvesWithoutErrata: propTypes.bool
};

const SystemCveToolbar = props => (
    <CVETableContext.Consumer>{context => <SystemCveToolbarWithContext context={context} {...props} />}</CVETableContext.Consumer>
);

export default injectIntl(SystemCveToolbar);
