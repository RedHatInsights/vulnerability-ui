import CSAwRuleBox from './CSAwRuleBox'
import { BrowserRouter as Router } from 'react-router-dom';
import configureStore from 'redux-mock-store';
import { Provider } from 'react-redux';
import { initialState } from '../../../Store/Reducers/CVEDetailsPageStore';
import { render, screen } from '@testing-library/react';
import { IntlProvider } from '@redhat-cloud-services/frontend-components-translations';
import userEvent from '@testing-library/user-event';
import TestWrapper from '../../../Utilities/TestWrapper';

jest.mock('../../../Store/Actions/Actions', () => ({
    ...jest.requireActual('../../../Store/Actions/Actions'),
    changeExposedDevicesParameters: jest.fn(),
    changeExposedSystemsParameters: jest.fn()
}));

const mockStore = configureStore([store => next => action => {}]);
let store = mockStore(initialState);

beforeEach(() => {
    store.clearActions();
});

const rules = [
    {
        "associated_cves": [
            "CVE-2019-11135"
        ],
        "change_risk": 3,
        "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
        "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
        "kbase_node_id": 4572391,
        "playbook_count": 1,
        "reboot_required": false,
        "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
        "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n",
        "rule_impact": 2
    }
]
const synopsis = 'CVE-2019-11135';
const setHeaderFilters = jest.fn();

describe('CSAW Rule Box', () => {
    it('Should render with rules', () => {
        const { asFragment } = render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(asFragment()).toMatchSnapshot();
    });

    it('Should render without reboot warning', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": 4572391,
                "playbook_count": 1,
                "reboot_required": false,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ]

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.queryByTestId('power-off-icon')).toBeNull();
    });

    it('Should render with reboot warning', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": 4572391,
                "playbook_count": 1,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ];
        
        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.getByTestId('power-off-icon')).not.toBeNull();
    });

    it('Should render assosiated cve links', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135",
                    "CVE-2019-11132",
                    "CVE-2019-11133"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": 4572391,
                "playbook_count": 1,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ]

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.getAllByTestId('associated-cve-link')).toHaveLength(2);
    });

    it('Should render with playbook', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135",
                    "CVE-2019-11132",
                    "CVE-2019-11133"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": 4572391,
                "playbook_count": 1,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ];

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.getAllByTestId('check-circle-icon')).toHaveLength(1);
    });

    it('Should render without playbook', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135",
                    "CVE-2019-11132",
                    "CVE-2019-11133"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": 4572391,
                "playbook_count": 0,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ];

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.queryByTestId('check-circle-icon')).toBeNull();
    });

    it('Should render with knowledge base link', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135",
                    "CVE-2019-11132",
                    "CVE-2019-11133"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": 4572391,
                "playbook_count": 0,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ];

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.getAllByTestId('kb-link')).toHaveLength(1);
    });

    it('Should render without knowledge base link', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135",
                    "CVE-2019-11132",
                    "CVE-2019-11133"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": null,
                "playbook_count": 0,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ];

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        expect(screen.queryByTestId('kb-link')).toBeNull();
    });

    it('Should filter based on the error key', () => {
        const rules = [
            {
                "associated_cves": [
                    "CVE-2019-11135",
                    "CVE-2019-11132",
                    "CVE-2019-11133"
                ],
                "change_risk": 3,
                "description": "CVE-2019-11135: \"TAA\" kernel side-channel",
                "generic": "An implementation issue similar to MDS was found in many x86 microprocessors.\n\nAn unprivileged attacker can use this flaw to bypass memory restrictions in order to read cached data from the processor and sibling logical processors. This allows malicious users to access information from the local system, and allows malicious virtual machines or users thereof to access information from other guests or the host system.\n",
                "kbase_node_id": null,
                "playbook_count": 0,
                "reboot_required": true,
                "rule_id": "CVE_2019_11135_cpu_taa|CVE_2019_11135_CPU_TAA_KERNEL",
                "summary": "An issue was found in the manner in which certain x86 microprocessors manage thread memory access synchronization. It has been assigned [CVE-2019-11135](https://access.redhat.com/security/cve/CVE-2019-11135). Complete mitigations for this issue require microcode and kernel updates, and disabling hyperthreading where applicable.\n\nAn unprivileged user can use this flaw to gain read access to privileged memory that would otherwise be inacessible, including from other virtual machines on the same host system.\n"
            }
        ];

        render(
            <TestWrapper store={ store }>
                <CSAwRuleBox rules={rules} synopsis={synopsis} setHeaderFilters={setHeaderFilters}/>
            </TestWrapper>
        );

        userEvent.click(screen.getByTestId('filter-affected-systems'));

        expect(setHeaderFilters).toBeCalledTimes(1)
        expect(setHeaderFilters).toHaveBeenCalledWith({ rule: rules[0].rule_id })

    });
});
