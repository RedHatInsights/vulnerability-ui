import React from 'react';
import propTypes from 'prop-types';
import { STATUS_OPTIONS } from '../../../Helpers/constants';
import SnippetWithHeaderAndPopover from './SnippetWithHeaderAndTooltip';
import { Flex, FlexItem } from '@patternfly/react-core/dist/js/layouts/Flex/';
import { Stack } from '@patternfly/react-core/dist/js/layouts/Stack/Stack';
import { StackItem } from '@patternfly/react-core/dist/js/layouts/Stack/StackItem';
import { Table, TableBody, TableHeader } from '@patternfly/react-table/dist/js/components/Table';
import { Text, TextContent, TextVariants  } from '@patternfly/react-core/dist/js/components/Text/';
import ExclamationTriangleIcon from '@patternfly/react-icons/dist/js/icons/exclamation-triangle-icon';
import { PatternFlyThemeProvider, StyledBox, StyledText, StyledConstants } from '@patternfly/react-styled-system';
import './CVEPageDetailsDescription.scss';

const CVEPageDetailsDescription = ({ cveAttributes }) => {
    const {
        public_date: publishDate,
        description,
        rh_link: link,
        business_risk: businessRisk,
        business_risk_justification: businessRiskJustification,
        status,
        status_justification: statusJustification,
        systems_status_detail: systemsStatusDetail,
        systems_status_divergent: systemsStatusDivergent
    } = cveAttributes;

    const detailRows =
        systemsStatusDetail &&
        Object.keys(systemsStatusDetail).map(item => [
            STATUS_OPTIONS.find(status => status.value === item.toString()).label,
            systemsStatusDetail[item].toString()
        ]);

    const brPopoverContent = (
        <TextContent>
            <Stack>
                <StackItem>
                    <StyledText
                        fontWeight={StyledConstants.fontWeights.bold}
                        fontSize={StyledConstants.fontSizes.sm}
                        lineHeight={StyledConstants.lineHeights.sm}
                    >
                        Justification note
                    </StyledText>
                </StackItem>
                <StackItem>{businessRiskJustification || '--'}</StackItem>
            </Stack>
        </TextContent>
    );

    const statusPopoverContent = (
        <Stack>
            <StackItem>
                <StyledText
                    fontWeight={StyledConstants.fontWeights.bold}
                    fontSize={StyledConstants.fontSizes.sm}
                    lineHeight={StyledConstants.lineHeights.sm}
                >
                    CVE Status
                </StyledText>
                {status || '--'}

                <StyledText
                    fontWeight={StyledConstants.fontWeights.bold}
                    fontSize={StyledConstants.fontSizes.sm}
                    lineHeight={StyledConstants.lineHeights.sm}
                    style={{ marginTop: 'var(--pf-global--spacer--sm)' }}
                >
                    Justification note
                </StyledText>
                {statusJustification || '--'}
            </StackItem>
            {systemsStatusDivergent > 0 && (
                <StackItem>
                    <TextContent>
                        <hr className={'splitter'} />
                    </TextContent>
                    <StyledText fontWeight={StyledConstants.fontWeights.semi_bold} lineHeight={StyledConstants.lineHeights.sm}>
                        Systems with this CVE
                    </StyledText>
                    <Table
                        aria-label={'Status details'}
                        borders={false}
                        gridBreakPoint={null}
                        cells={['Status', 'Count']}
                        rows={detailRows}
                        className={'status-breakdown-table'}
                    >
                        <TableHeader />
                        <TableBody />
                    </Table>
                </StackItem>
            )}
        </Stack>
    );
    return (
        <PatternFlyThemeProvider>
            <Stack gutter="sm">
                <StackItem />
                <StackItem>
                    <Flex>
                        <FlexItem breakpointMods={[{ modifier: 'spacer-xl' }]}>
                            <SnippetWithHeaderAndPopover
                                title={'Business risk'}
                                value={businessRisk}
                                content={brPopoverContent}
                            />
                        </FlexItem>
                        <FlexItem breakpointMods={[{ modifier: 'spacer-xl' }]}>
                            <SnippetWithHeaderAndPopover
                                title={'Status'}
                                content={statusPopoverContent}
                                value={
                                    <span>
                                        {systemsStatusDivergent > 0 && (
                                            <ExclamationTriangleIcon color={'var(--pf-global--warning-color--100)'} />
                                        )}{' '}
                                        {status}
                                    </span>
                                }
                            />
                        </FlexItem>
                    </Flex>
                </StackItem>
                <StackItem>
                    <TextContent>
                        <Text component={TextVariants.p}>{description}</Text>
                    </TextContent>
                </StackItem>
                <StackItem>
                    <StyledBox style={{ marginBottom: 'var(--pf-global--spacer--xs)' }}>Publish date: {publishDate}</StyledBox>
                    <StyledBox>{link}</StyledBox>
                </StackItem>
            </Stack>
        </PatternFlyThemeProvider>
    );
};

CVEPageDetailsDescription.propTypes = {
    cveAttributes: propTypes.any
};

export default CVEPageDetailsDescription;
