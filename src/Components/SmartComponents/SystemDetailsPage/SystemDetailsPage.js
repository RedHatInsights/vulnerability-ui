import { Main } from '@redhat-cloud-services/frontend-components/Main';
import { addNotification, clearNotifications } from '@redhat-cloud-services/frontend-components-notifications/redux';
import propTypes from 'prop-types';
import React, { useEffect } from 'react';
import { connect, useDispatch } from 'react-redux';
import { useRouteMatch } from 'react-router-dom';
import { fetchSystemDetails, optOutSystemsAction } from '../../../Store/Actions/Actions';
import { systemDetailsPageStore } from '../../../Store/Reducers/SystemDetailsPageStore';
import ReducerRegistry from '../../../Utilities/ReducerRegistry';
import Header from '../../PresentationalComponents/Header/Header';
import { injectIntl } from 'react-intl';
import {
    NotAuthorizedNotification,
    PATHS,
    PERMISSIONS,
    ReadOnlyNotification
} from '../../../Helpers/constants';
import messages from '../../../Messages';

import { AppInfo, DetailWrapper, InventoryDetailHead } from '@redhat-cloud-services/frontend-components/Inventory';
import { useRbac } from '../../../Helpers/Hooks';

const InventoryDetail = ({ systemDetails = {}, intl, errors }) => {
    const dispatch = useDispatch();
    const match = useRouteMatch();
    const [[
        canSetExcludedIncluded,
        canExport,
        canReadVulnerabilityResults,
        canEditPairStatus,
        canReadExcluded
    ], isRbacLoading] = useRbac([
        PERMISSIONS.setExcludedIncluded,
        PERMISSIONS.basicReporting,
        PERMISSIONS.readVulnerabilityResults,
        PERMISSIONS.setPairStatus,
        PERMISSIONS.readExcluded]
    );

    const rbacPermissions = {
        canExport,
        canReadVulnerabilityResults,
        canEditPairStatus,
        canReadExcluded
    };
    const inventoryId = match.params.inventoryId;

    useEffect(() => {
        dispatch(fetchSystemDetails(inventoryId));
    }, [dispatch, inventoryId]);

    useEffect(() => {
        return () => {
            dispatch(clearNotifications());
        };
    }, [dispatch]);

    const notifications = systemName => ({
        exclude: {
            success: {
                variant: 'success',
                title: intl.formatMessage(messages.notificationExcludeSuccess, { count: 1, systemName })
            },
            failure: {
                variant: 'danger',
                autoDismiss: false,
                title: intl.formatMessage(messages.notificationExcludeFailureTitle, { count: 1, systemName }),
                description: intl.formatMessage(messages.notificationDetailExcludeFailureBody, { count: 1 })
            }
        },
        include: {
            success: {
                variant: 'success',
                title: intl.formatMessage(messages.notificationIncludeSuccessTitle, { count: 1, systemName }),
                description: intl.formatMessage(messages.notificationIncludeSuccessBody, { count: 1 })
            },
            failure: {
                variant: 'danger',
                autoDismiss: false,
                title: intl.formatMessage(messages.notificationIncludeFailureTitle, { count: 1, systemName }),
                description: intl.formatMessage(messages.notificationDetailIncludeFailureBody, { count: 1 })
            }
        }
    });

    const handleOptOutSystem = (systemName, toExclude) => {
        dispatch(optOutSystemsAction([inventoryId], toExclude)).then(() => {
            dispatch(fetchSystemDetails(inventoryId));
            dispatch(addNotification(toExclude
                ? notifications(systemName).exclude.success
                : notifications(systemName).include.success));
        }).catch(error => {
            dispatch(addNotification(
                error.status === '503' ? ReadOnlyNotification :
                    error.status === '403' ? NotAuthorizedNotification :
                        toExclude
                            ? notifications(systemName).exclude.failure
                            : notifications(systemName).include.failure));
        });
    };

    const { opt_out: isOptOut = false, entity, loaded } = systemDetails;

    return (
        <DetailWrapper>
            <section className="inventory">
                <Header
                    title=""
                    breadcrumbs={[
                        {
                            title: PATHS.systemsPage.title,
                            to: PATHS.systemsPage.to,
                            loaded: true
                        },
                        {
                            title: entity?.display_name || intl.formatMessage(messages.invalidSystem),
                            isActive: true,
                            loaded
                        }
                    ]}
                >
                    {!errors && (
                        <InventoryDetailHead
                            onLoad={({ mergeWithEntities, mergeWithDetail, INVENTORY_ACTION_TYPES }) => {
                                ReducerRegistry.register({
                                    ...mergeWithEntities(),
                                    ...mergeWithDetail(systemDetailsPageStore(
                                        INVENTORY_ACTION_TYPES, handleOptOutSystem, rbacPermissions, isRbacLoading
                                    ))
                                });
                            }}
                            hideBack
                            actions={
                                entity && canSetExcludedIncluded && [
                                    isOptOut
                                        ? {
                                            title: intl.formatMessage(messages.inventoryKebabOptionsResume),
                                            onClick: () => handleOptOutSystem(systemDetails.entity.display_name, false)
                                        }
                                        : {
                                            title: intl.formatMessage(messages.inventoryKebabOptionsExclude),
                                            onClick: () => handleOptOutSystem(systemDetails.entity.display_name, true)
                                        }
                                ]
                            }
                        />
                    )}
                </Header>
            </section>
            <Main>
                <AppInfo
                    optOutSystemHandler={handleOptOutSystem}
                    rbacPermissions={rbacPermissions}
                    isRbacLoading={isRbacLoading}/>
            </Main>
        </DetailWrapper>
    );
};

InventoryDetail.propTypes = {
    systemDetails: propTypes.object,
    intl: propTypes.any,
    errors: propTypes.object
};

function mapStateToProps(state) {
    return {
        errors: state.SystemCvesStore.cveList.payload.errors,
        systemDetails: state.entityDetails
    };
}

export default injectIntl(
    connect(
        mapStateToProps,
        null
    )(InventoryDetail)
);
