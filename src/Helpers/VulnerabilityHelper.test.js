import { initialState } from '../Store/Reducers/CVEsStore';
import { 
    createCveListByAccount,
    createCveListBySystem,
    handleCVELink,
    renderSystemCSAwIcon
 } from './VulnerabilityHelper';
 
const { parameters } = initialState;

describe('VulnerabilitiesHelper', () => {
    it('test function createCveListByAccount() with cveList param', () => {
        const cveList = {
            isLoading: false,
            payload: {
                meta: {
                    page: 1,
                    page_size: 20,
                    total_items: 248,
                    pages: 10,
                    sort: '-public_date',
                    filter: '',
                    affecting: 'true,false',
                    cvss_from: '',
                    cvss_to: '',
                    public_from: '',
                    public_to: ''
                },
                data: [
                    {
                        type: 'cve',
                        id: 'CVE-2019-6454',
                        attributes: {
                            systems_affected: 2,
                            synopsis: 'CVE-2019-6454',
                            public_date: '2019-02-18T00:00:00+00:00',
                            impact: 'Important',
                            description: '** RESERVED ** This candidate',
                            cvss2_score: '',
                            cvss3_score: '7.000',
                            business_risk_id: '3',
                            status_id: 2,
                            cve_status_id: 2
                        }
                    },
                    {
                        type: 'cve',
                        id: 'CVE-2019-6116',
                        attributes: {
                            systems_affected: 2,
                            synopsis: 'CVE-2019-6116',
                            public_date: '2019-01-23T00:00:00+00:00',
                            impact: 'Important',
                            description: 'It was found that ghostscript',
                            cvss2_score: '',
                            cvss3_score: '7.300',
                            business_risk_id: '1',
                            status_id: 1,
                            cve_status_id: 2
                        }
                    },
                    {
                        type: 'cve',
                        id: 'CVE-2019-3815',
                        attributes: {
                            systems_affected: 2,
                            synopsis: 'CVE-2019-3815',
                            public_date: '2019-01-14T00:00:00+00:00',
                            impact: 'Low',
                            description: 'A memory leak was discovered',
                            cvss2_score: '',
                            cvss3_score: '3.300',
                            business_risk_id: '2',
                            status_id: 2,
                            cve_status_id: 2
                        }
                    }
                ]
            }
        };
        expect(JSON.stringify(createCveListByAccount(cveList))).toMatchSnapshot();
    });

    it('test function createCveListByAccount() render CSaw icon', () => {
        const cveList = {
            isLoading: false,
            payload: {
                meta: {
                    test: 'test'
                },
                data: [
                    {
                        type: 'cve',
                        id: 'CVE-2019-6454',
                        attributes: {
                            systems_affected: 2,
                            synopsis: 'CVE-2019-6454',
                            public_date: '2019-02-18T00:00:00+00:00',
                            impact: 'Important',
                            description: '** RESERVED ** This candidate',
                            cvss2_score: '',
                            cvss3_score: '7.000',
                            business_risk_id: '3',
                            status_id: 2,
                            cve_status_id: 2,
                            rules: ['testRule']
                        }
                    }
                ]
            }
        };
        const result = createCveListByAccount(cveList);
        expect(result.data[0].cells[0].title.props.children[0]).toEqual(expect.anything());
    });

    it('test function createCveListByAccount() render ExclamationTriangleIcon icon', () => {
        const cveList = {
            isLoading: false,
            payload: {
                meta: {
                    test: 'test'
                },
                data: [
                    {
                        type: 'cve',
                        id: 'CVE-2019-6454',
                        attributes: {
                            systems_affected: 2,
                            synopsis: 'CVE-2019-6454',
                            public_date: '2019-02-18T00:00:00+00:00',
                            impact: 'Important',
                            description: '** RESERVED ** This candidate',
                            cvss2_score: '',
                            cvss3_score: '7.000',
                            business_risk_id: '3',
                            status_id: 2,
                            cve_status_id: 2,
                            systems_status_divergent: 2
                        }
                    }
                ]
            }
        };
        const result = createCveListByAccount(cveList);
        expect(result.data[0].cells[6].title.props.children[0]).toEqual(expect.anything());
    });

    it('VulnerabilitiesHelper - loading', () => {
        const cve_list = createCveListByAccount(
           { isLoading: true, payload: { meta: 'testObject', data: 'testData' }, parameters }
        );
        expect(cve_list).toEqual({ data: [], meta: 'testObject', isLoading: true });
    });

    it('VulnerabilitiesHelper - loading, empty meta', () => {
        const cve_list = createCveListByAccount({ isLoading: true, payload: { data: 'testData' } });
        expect(cve_list).toEqual({ data: [], meta: {}, isLoading: true });
    });

    it('test function createCveListBySystem() with cveList param', () => {
        const cveList = {
            isLoading: false,
            payload: {
                meta: {
                    test: 'test'
                },
                data: [
                    {
                        type: 'cve',
                        id: 'CVE-2019-6116',
                        attributes: {
                            business_risk: "Not Defined",
                            business_risk_id: 0,
                            business_risk_text: null,
                            cve_status_id: 0,
                            cve_status_text: null,
                            cvss2_score: null,
                            cvss3_score: "7.500",
                            description: "A network amplification",
                            impact: "Important",
                            public_date: "2020-05-19T00:00:00+00:00",
                            reporter: 1,
                            rule: null,
                            status: "Scheduled for Patch",
                            status_id: 3,
                            status_text: "pair status different",
                            synopsis: "CVE-2020-12662"
                        }
                    }
                ]
            }
        };
        expect(JSON.stringify(createCveListBySystem(null, cveList))).toMatchSnapshot();
    });

    it('test function createCveListBySystem() render CSaw icon', () => {
        const cveList = {
            isLoading: false,
            payload: {
                meta: {
                    test: 'test'
                },
                data: [
                    {
                        type: 'cve',
                        id: 'CVE-2019-6454',
                        attributes: {
                            business_risk: "Not Defined",
                            business_risk_id: 0,
                            business_risk_text: null,
                            cve_status_id: 2,
                            cve_status_text: "testhello",
                            cvss2_score: null,
                            cvss3_score: "6.500",
                            description: "A new domain bypass",
                            impact: "Moderate",
                            public_date: "2020-06-09T17:00:00+00:00",
                            reporter: 1,
                            rule: null,
                            status: "On-Hold",
                            status_id: 2,
                            status_text: "testhello",
                            synopsis: "CVE-2020-0543",
                            rule: 'testRule'
                        }
                    }
                ]
            }
        };

        const result = createCveListBySystem(null, cveList);
        expect(result.data[0].cells[0].title.props.children).toHaveLength(2);
    });

    it('VulnerabilitiesHelper createCveListBySystem - loading', () => {
        const cve_list = createCveListBySystem( null,
           { isLoading: true, payload: { meta: 'testObject', data: 'testData' }, parameters }
        );
        expect(cve_list).toEqual({ data: [], meta: 'testObject', isLoading: true });
    });

    it('VulnerabilitiesHelper createCveListBySystem - loading, empty meta', () => {
        const cve_list = createCveListBySystem(null, { isLoading: true, payload: { data: 'testData' } }, parameters );
        expect(cve_list).toEqual({ data: [], meta: {}, isLoading: true });
    });

    it('Should handleCVELink return Link component to synopsis', () => {
        const mockLocation = new URL('https://localhost:1337/insights/vulnerability/cves');
        delete window.location;
        window.location = mockLocation;

        const result = handleCVELink('testSynopsis');
        expect(result.props.to).toEqual('/cves/testSynopsis');
    });

    it('Should handleCVELink return JS a href to synopsis', () => {
        const mockLocation = new URL('https://localhost:1337/insights/');
        delete window.location;
        window.location = mockLocation;

        const result = handleCVELink('testSynopsis', 'testBody');
        expect(result.props.href).toEqual('http://localhost/insights/vulnerability/cves/testSynopsis');
    });

    it('Should renderSystemCSAwIcon render CSAwIcon', () => {
        const testRule = { title: 'testTitle' };
        const result = renderSystemCSAwIcon(testRule, true);
        expect(result.props.children).toHaveLength(2);
    });

    it('Should renderSystemCSAwIcon render rule title', () => {
        const testItem = { title: 'testTitle' };
        const result = renderSystemCSAwIcon(testItem, false);
        expect(result.props.children[1].props.children).toEqual('testTitle');
    });
    
}); 
