
import React, { Fragment } from 'react';
import propTypes from 'prop-types';
import { DateFormat } from '@redhat-cloud-services/frontend-components';
import { CVSSHeader, CVSSMapping, recentCvesHeader, recentCvesMapping } from '../../../Helpers/constants';
import {
    DownloadButton,
    Section,
    Column,
    Table,
    Panel,
    PanelItem,
    Chart
} from '@redhat-cloud-services/frontend-components-pdf-generator';

const ExecutiveReport = ({ data, label }) => {

    const {
        cves_by_severity: cvesBySeverity,
        recent_cves: recentCves,
        top_cves: topCves,
        cves_total: cvesTotal,
        system_count: systemTotal
    } = data;

    const mapFields = (fields, data, percentageInfo = false) => {
        let arr = [];

        for (const field in fields) {

            let { [field]: label } = fields;
            let { [field]: fieldData } = data;

            let value = fieldData.count ? fieldData.count : fieldData;

            if (percentageInfo && fieldData.percentage) {
                value = `${value} (${fieldData.percentage}% of total)`;
            }

            arr.push([label, value.toString()]);
        }

        return arr;
    };

    const title = [
        `This is an executive summary of vulnerabilities (CVEs) identified by Red Hat that may impact your
        Red Hat Enterprise Linux (RHEL) servers.

        The vulnerability service analyzed`,
        { title: ` ${systemTotal} RHEL systems `, fontWeight: 700 }, 'and identified ',
        { title: `${cvesTotal} CVEs `, fontWeight: 700 }, `that impact 1 or
        more of these systems.`

    ];

    const recentCvesData = mapFields(
        recentCvesMapping,
        {
            ...recentCves
        }
    );
    const CVSSDataMap = mapFields(
        CVSSMapping,
        {
            ...cvesBySeverity
        }
    );

    const CVSSChart = CVSSDataMap.map((severity) => {
        let [x, y] = severity;
        return { x: `CVSS ${x}`, y: Number(y) };
    });

    const CVSSData = mapFields(
        CVSSMapping,
        {
            ...cvesBySeverity
        },
        true
    );

    // eslint-disable-next-line new-cap
    const date = DateFormat({ date: new Date(), type: 'exact' }).props.children;

    return (
        <DownloadButton
            className="download-executive-report"
            label={label}
            fileName={`Vulnerability-Executive-Report--${date.replace(/ /g, '-')}.pdf`}
            type="Vulnerability"
            title={title}
            size={600}
            pages={[
                <Fragment key="first-section">
                    <Section title="CVEs by severity">
                        <Column>
                            <Table
                                withHeader
                                rows={[CVSSHeader, ...CVSSData]}
                            />
                        </Column>
                        <Column>
                            <Chart
                                chartType="pie"
                                subTitle="Cves"
                                title="100"
                                data={CVSSChart}
                            />
                        </Column>
                    </Section>
                    <Section title="CVEs published by time frame">
                        <Column>
                            <Table
                                withHeader
                                rows={[recentCvesHeader, ...recentCvesData]}
                            />
                        </Column>
                        <Column>
                        </Column>
                    </Section>
                    <Section title="Top 3 CVEs in your infrastructure" withColumn={false}>
                        {topCves.map(cve => (
                            <Panel key={cve.synopsis} title={cve.synopsis} description={cve.description}>
                                <PanelItem title="CVSS score">
                                    {Number.parseFloat(cve.cvss3_score).toFixed(1)}
                                </PanelItem>
                                <PanelItem title="Systems exposed">
                                    {cve.systems_affected.toString()}
                                </PanelItem>
                            </Panel>
                        ))}
                    </Section>
                </Fragment>
            ]} />
    );
};

ExecutiveReport.propTypes = {
    data: propTypes.object,
    label: propTypes.object,
    triggerClick: propTypes.func
};

export default ExecutiveReport;
