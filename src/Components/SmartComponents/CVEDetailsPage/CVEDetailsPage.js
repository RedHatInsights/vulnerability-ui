import { InvalidObject, Main } from '@redhat-cloud-services/frontend-components';
import propTypes from 'prop-types';
import React, { useMemo, useState, useEffect } from 'react';
import { createCveDetailsPage } from '../../../Helpers/CVEHelper';
import { useDispatch, useSelector } from 'react-redux';
import {
    fetchCveDetails,
    changeExposedSystemsParameters,
    fetchAffectedSystemsByCVE
} from '../../../Store/Actions/Actions';
import { withRouter } from 'react-router-dom';
import { PATHS } from '../../../Helpers/constants';
import CVEPageDetails from '../../PresentationalComponents/CVEPageDetails/CVEPageDetails';
import { kebabItemEditBusinessRisk, kebabItemEditStatus } from '../../PresentationalComponents/DownloadReportKebab/KebabItems';
import BusinessRiskModal from '../Modals/BusinessRiskModal';
import CveStatusModal from '../Modals/CveStatusModal';
import SystemsExposedTable from '../SystemsExposedTable/SystemsExposedTable';
import Header from '../../PresentationalComponents/Header/Header';
import CSAwLabel from '../../PresentationalComponents/Snippets/CSAwLabel';

export const CVEPageContext = React.createContext({ isLoading: true });

const CVEDetailsPage = (props) => {
    const dispatch = useDispatch();
    const [cveName] = useState(props.match.params.cve);
    const [BusinessModal, setBusinessRisk] = useState(() => () => null);
    const [StatusModal, setStatusModal] = useState(() => () => null);

    const details = useSelector(
        ({ CVEDetailsPageStore }) => CVEDetailsPageStore.cveDetails
    );
    const cveDetails = useMemo(() => createCveDetailsPage(details), [details]);

    const exposedSystems = useSelector(
        ({ CVEDetailsPageStore }) => CVEDetailsPageStore.affectedSystemsByCVE
    );

    useEffect(() => {
        dispatch(fetchCveDetails(cveName));
    }, []);

    const showBusinessRiskModal = cves => {
        setBusinessRisk(
            () => () =>
                <BusinessRiskModal open cves={cves} updateRef={() => dispatch(fetchCveDetails(cveName))} />
        );
    };

    const showStatusModal = cves => {
        setStatusModal(
            () => () =>
                <CveStatusModal
                    cves={cves}
                    updateRef={() => {
                        dispatch(fetchCveDetails(cveName));
                        dispatch(fetchAffectedSystemsByCVE(cveName));
                    }}
                />
        );
    };

    const { error, data } = cveDetails;

    const cveStatusDetails = {
        id: cveName,
        status_id: cveDetails.data.status_id,
        justification: cveDetails.data.status_justification,
        exposed_systems_count: exposedSystems?.payload?.meta?.total_items || 0
    };
    const kebabItems = [
        kebabItemEditBusinessRisk(showBusinessRiskModal, [
            {
                business_risk_id: cveDetails.data.business_risk_id,
                id: cveName,
                justification: cveDetails.data.business_risk_justification
            }
        ]),
        kebabItemEditStatus(showStatusModal, [cveStatusDetails])
    ];
    const { rules } = data;
    const filterRuleValues = rules && rules.map(
        ({ rule_id: ruleId, description }) => ({ value: ruleId, label: description })
    );

    if (!error) {
        return (
            <React.Fragment>
                <CVEPageContext.Provider value={cveDetails && { isLoading: cveDetails.isLoading }}>
                    <Header
                        title={cveName}
                        actions={kebabItems}
                        actionsOuiaId={'cve-actions'}
                        breadcrumbs={[
                            {
                                title: PATHS.cvesPage.title,
                                to: PATHS.cvesPage.to,
                                loaded: true
                            },
                            {
                                title: cveName,
                                isActive: true,
                                loaded: true
                            }
                        ]}
                        // you can pass an array here, when implementing exploit label
                        labels={details.payload.data?.attributes.rules.length > 0 && <CSAwLabel />}
                    >
                        <CVEPageDetails changeExposedSystemsParameters={changeExposedSystemsParameters} data={cveDetails} />
                        <StatusModal />
                        <BusinessModal />
                    </Header>
                    <Main>
                        <SystemsExposedTable
                            cve={cveName}
                            filterRuleValues={filterRuleValues}
                            cveStatusDetails={cveStatusDetails}
                            methods={{ showStatusModal }}
                        />
                    </Main>
                </CVEPageContext.Provider>
            </React.Fragment>
        );
    } else {
        return (
            <React.Fragment>
                <Header title={cveName}/>
                <InvalidObject />
            </React.Fragment>
        );
    }
};

CVEDetailsPage.propTypes = {
    match: propTypes.object,
    cveDetails: propTypes.object,
    fetchCveDetails: propTypes.func,
    handleCveDetailsError: propTypes.func
};
export default withRouter(CVEDetailsPage);
