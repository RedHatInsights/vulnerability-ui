
import React, { useState } from 'react';
import { useIntl } from 'react-intl';
import { DownloadButton } from '@redhat-cloud-services/frontend-components-pdf-generator';
import { getExecutiveReport } from '../../../Helpers/APIHelper';
import messages from '../../../Messages';
import buildExecReport from './BuildExecReport';
import { Fragment } from 'react';
import { useNotification } from '../../../Helpers/Hooks';
import FooterPDF from './Common/FooterPDF';
import { NotAuthorizedNotification } from '../../../Helpers/constants';

const DownloadExecutive = () => {
    const intl = useIntl();
    const [isLoading, setLoading] = useState(false);
    const [renderPDF, setRenderPDF] = useState(false);
    const [hasRule, setSecurityRulesPresent] = useState(false);
    const [hasExploit, setExploit] = useState(false);
    const [addNotification, clearNotifications] = useNotification();

    const dataFetch = async () => {
        let data;

        try {
            data = await getExecutiveReport();
        }
        catch (error) {
            clearNotifications();
            addNotification(error.status === '403' ? NotAuthorizedNotification : {
                variant: 'danger',
                autoDismiss: false,
                msg: intl.formatMessage(messages.notificationReportDownloadFailureTitle),
                description: intl.formatMessage(messages.notificationReportDownloadFailureBody)
            });

            setLoading(false);

            return [];
        }

        const report = buildExecReport({ data, intl });
        setSecurityRulesPresent(() => data.top_cves.some(cve => cve.rule_presence === true));
        setExploit(() => data.top_cves.some(cve => cve.known_exploit === true));

        setLoading(false);

        clearNotifications();
        addNotification({ variant: 'success', msg: intl.formatMessage(messages.notificationReportDownloadSuccess) });

        return [...report];
    };

    const [date] = new Date().toISOString().split('T');

    const onDownloadButtonClick = () => {
        setRenderPDF(true);
        setLoading(true);

        addNotification({ msg: intl.formatMessage(messages.notificationReportDownloadStart) });
    };

    return (
        <Fragment>
            <a onClick={() => onDownloadButtonClick()}>
                {isLoading
                    ? intl.formatMessage(messages.loading)
                    : intl.formatMessage(messages.executiveReportCardButton)}
            </a>
            {
                renderPDF && <DownloadButton
                    fallback={<div />}
                    type={intl.formatMessage(messages.vulnerabilitiesHeader)}
                    fileName={`vulnerability_executive-report--${date}.pdf`}
                    buttonProps={{ variant: 'link', isInline: true }}
                    groupName="Red Hat Insights"
                    asyncFunction={dataFetch}
                    allPagesHaveTitle={false}
                    showButton={false}
                    footer={<FooterPDF intl={intl} hasRule={hasRule} hasExploit={hasExploit} />}
                    onSuccess={() => {
                        setRenderPDF(false);
                    }}

                />
            }
        </Fragment>
    );

};

export default DownloadExecutive;
