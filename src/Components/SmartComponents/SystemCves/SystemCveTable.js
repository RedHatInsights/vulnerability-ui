import React, { Fragment } from 'react';
import propTypes from 'prop-types';
import { Table, TableBody, TableHeader } from '@patternfly/react-table';
import { SkeletonTable, TableToolbar } from '@redhat-cloud-services/frontend-components';

import { systemCveTableRowActions } from '../../../Helpers/CVEHelper';
import { createSortBy, handleSortColumn } from '../../../Helpers/MiscHelper';
import PaginationWrapper from '../../PresentationalComponents/PaginationWrapper/PaginationWrapper';
import {
    FilterNotFoundForSystem,
    EmptyCVEListForSystem,
    EmptyCVEList
} from '../../PresentationalComponents/EmptyStates/EmptyStates';
import { CVETableContext } from './SystemCves';

const SystemCvesTableWithContext = ({ context, header, entity }) => {
    const { cves, methods, selectedCves, openedCves, canEditStatus } = context;

    // TODO Material for refatoring when we'll introduce "manage column"
    // eslint-disable-next-line camelcase
    if (!cves?.meta?.patch_access) {
        header = header.filter(item => item.key !== 'advisory');
    }

    const noCves = () => {
        const { cves } = context;
        const filterFields = ['filter', 'cvss_from', 'cvss_to', 'public_from', 'public_to', 'impact', 'status_id'].filter(
            item => Object.prototype.hasOwnProperty.call(cves.meta, item) && cves.meta[item]
        );
        let emptyComponent = filterFields.length !== 0
            ? FilterNotFoundForSystem
            : entity
                ? EmptyCVEListForSystem
                : !cves.data || cves.data.length === 0
                    ? EmptyCVEList
                    : undefined;

        return ([{
            heightAuto: true,
            cells: [
                {
                    props: { colSpan: 8 },
                    title: (
                        emptyComponent
                    )
                }
            ]
        }]);

    };

    const handleOnCollapse = (event, rowKey, isOpen) => {
        const { cves, methods,  expandCveDescription } = context;
        const cveName = cves.data[rowKey] && cves.data[rowKey].id;
        methods.openCves(isOpen, [cveName], expandCveDescription);
    };

    const handleOnSelect = (event, isSelected, rowId) => {
        const { cves, methods } = context;
        const cveName = cves.data[rowId] && cves.data[rowId].id;
        methods.selectCves(isSelected, cveName);
    };

    const isEmpty = !cves.data || cves.data.length === 0;

    const rows = !isEmpty ? cves.data
    .map(cve => (selectedCves.includes(cve.id) && { ...cve, selected: true }) || cve)
    .map((cve, index) => {
        const current = index % 2 === 0 ? openedCves.find(opened => opened.id === cve.id) || false : { isOpen: undefined };
        return ({ ...cve, isOpen: current && current.isOpen });
    }) : [];

    return (
        <Fragment>
            {!cves.isLoading ? (
                <Fragment>
                    <Table
                        isStickyHeader
                        canSelectAll={false}
                        aria-label={'Vulnerability CVE table'}
                        cells={header}
                        rows={isEmpty ? noCves() : rows}
                        onSelect={!isEmpty ? handleOnSelect : undefined}
                        actionResolver={ (!isEmpty && canEditStatus) &&
                            ((rowData, rowIndex) => systemCveTableRowActions(methods, entity, rowIndex.rowIndex))}
                        sortBy={!isEmpty
                            ? createSortBy([{ key: 'collapse' }, { key: 'checkbox' }, ...header], cves.meta.sort) : undefined}
                        onCollapse={!isEmpty ? (event, rowKey, isOpen) => handleOnCollapse(event, rowKey, isOpen) : undefined}
                        onSort={!isEmpty ?
                            (event, key, direction) =>
                                handleSortColumn(
                                    key,
                                    direction,
                                    [{ key: 'collapse' }, { key: 'checkbox' }, ...header],
                                    cves.meta.sort,
                                    methods.apply
                                ) : undefined
                        }
                        gridBreakPoint={'grid-lg'}
                        ouiaId={'cves-table'}
                    >
                        <Fragment>
                            <TableHeader />
                            <TableBody />
                        </Fragment>
                    </Table>
                    <TableToolbar>
                        <PaginationWrapper meta={cves.meta} apply={methods.apply} />
                    </TableToolbar>
                </Fragment>
            ) : (
                <SkeletonTable colSize={6} rowSize={20} />
            )}
        </Fragment>
    );

};

SystemCvesTableWithContext.propTypes = {
    context: propTypes.any,
    header: propTypes.array,
    entity: propTypes.string
};

const SystemCvesTable = props => (
    <CVETableContext.Consumer>{context => <SystemCvesTableWithContext context={context} {...props} />}</CVETableContext.Consumer>
);
export default SystemCvesTable;
