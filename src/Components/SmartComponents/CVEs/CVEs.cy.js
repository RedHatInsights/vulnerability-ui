import { CVEs } from './CVEs';
import cvesResponse from '../../../../cypress/fixtures/cves.json';
import {
    itIsExpandable,
    itIsSortedBy,
    itExportsDataToFile,
    itHasActiveFilter,
    itIsNotSorted,
    itHasTableFunctionsDisabled
} from '../../../../cypress/utils/table';

const mountComponent = (canEditStatusOrBusinessRisk = true) => {
    cy.mountWithContext(
        CVEs, {
            path: '/',
            routerProps: { initialEntries: ['/'] }
        },
        { rbac: [[canEditStatusOrBusinessRisk, true, true, true], false] }
    );
};

describe('CVE list table', () => {
    beforeEach(() => {
        cy.intercept('GET', '**/api/vulnerability/v1/vulnerabilities/cves**', cvesResponse);

        mountComponent();
    });

    it('exists and matches screenshot', () => {
        cy.get('[data-ouia-component-id="cves-table"]');

        cy.get('body').matchImage();
    });

    it('has items', () => {
        cy.get('[data-ouia-component-id="cves-table"] tbody [data-label="CVE ID"]')
            .should('have.length', cvesResponse.data.length);
    });

    it('has "Reset filter" button hidden by default', () => {
        cy.get('body').should('not.contain', 'Reset filter');
    });

    itHasActiveFilter('Systems', '1 or more');
    itIsSortedBy('Publish date');
    itExportsDataToFile(cvesResponse.data, 'vulnerability_cves--');
    itIsExpandable(cvesResponse.data.length);

    it('has expanded row that matches screenshot', () => {
        cy.get('td.pf-v5-c-table__toggle > button').first().click();

        cy.get('thead').invoke('hide');
        cy.get('.pf-v5-c-table__expandable-row-content:visible').matchImage();
        cy.get('thead').invoke('show');

        cy.get('td.pf-v5-c-table__toggle > button').first().click();
    });

    it('shows missing metadata empty state when CVE description is "unknown"', () => {
        cy.get('td.pf-v5-c-table__toggle > button').last().click();

        cy.contains('No description available');
        cy.get('.pf-v5-c-table__expandable-row-content:visible').matchImage();
    });

    it('shows bulk select dropdown', () => {
        cy.get('.pf-v5-c-toolbar__group > :nth-child(1) > .pf-v5-c-menu-toggle').should('exist');
    });

    it('shows select checkboxes for any row', () => {
        cy.get('.pf-v5-c-table__check').should('exist');
    });

    it('shows buttons to edit status or business risk', () => {
        cy.get('.ins-c-primary-toolbar__actions > .pf-v5-c-menu-toggle').click();

        cy.get('[data-ouia-component-id="edit-business-risk"] > .pf-v5-c-menu__item')
            .contains('Edit business risk')
            .should('exist');

        cy.get('[data-ouia-component-id="edit-status"] > .pf-v5-c-menu__item')
            .contains('Edit status')
            .should('exist');
    });

    it('shows row actions', () => {
        cy.get('.pf-v5-c-table__action > .pf-v5-c-menu-toggle')
            .should('exist');
    });

    describe('without items', () => {
        beforeEach(() => {
            cy.intercept('GET', '**/api/vulnerability/v1/vulnerabilities/cves**', {
                data: [],
                meta: {
                    total_items: 0
                }
            });

            mountComponent();
        });

        it('exists and matches screenshot', () => {
            cy.get('[data-ouia-component-id="cves-table"]');

            cy.get('body').matchImage();
        });

        it('has no items', () => {
            cy.get('[data-ouia-component-id="cves-table"] tbody [data-label="CVE ID"]')
                .should('have.length', 0);
        });

        itIsNotSorted();
        itHasTableFunctionsDisabled();

        it('shows correct empty state depending on whether filters are applied or not', () => {
            cy.contains('No matching CVEs found').should('exist');

            cy.get('.ins-c-chip-filters .pf-v5-c-chip button').click();

            cy.contains('No matching CVEs found').should('exist');
            cy.contains('Reset filter').should('exist');
        });
    });

    describe('without canEditStatusOrBusinessRisk permission', () => {
        beforeEach(() => {
            cy.intercept('GET', '**/api/vulnerability/v1/vulnerabilities/cves**', cvesResponse);

            mountComponent(false);
        });

        it('matches screenshot', () => {
            cy.get('[data-ouia-component-id="cves-table"]');
            cy.get('body').matchImage();
        });

        it('does not show bulk select dropdown', () => {
            cy.get('.ins-c-bulk-select').should('not.exist');
        });

        it('does not show select checkboxes for any row', () => {
            cy.get('.pf-v5-c-table__check').should('not.exist');
        });

        it('does not show buttons to edit status or business risk', () => {
            cy.get('.ins-c-primary-toolbar__actions > .pf-v5-c-menu-toggle').click();

            cy.get('.pf-v5-c-menu__item')
                .should('not.contain', 'Edit business risk');

            cy.get('.pf-v5-c-menu__item')
                .should('not.contain', 'Edit status');
        });

        it('does not show row actions', () => {
            cy.get('[data-ouia-component-id="cves-table"] tr .pf-v5-c-dropdown__toggle').should('not.exist');
        });
    });
});
