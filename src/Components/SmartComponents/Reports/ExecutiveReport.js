
import React, { Fragment } from 'react';
import propTypes from 'prop-types';
import { CVSSHeader, CVSSMapping, recentCvesHeader, recentCvesMapping } from '../../../Helpers/constants';
import {
    DownloadButton,
    Section,
    Column,
    Table,
    Panel,
    PanelItem,
    Chart
}  from '@redhat-cloud-services/frontend-components-pdf-generator';

const ExecutiveReport = ({ data, label }) => {

    const {
        cves_by_severity: cvesBySeverity,
        recent_cves: recentCves,
        top_cves: topCves,
        cves_total: cvesTotal,
        system_count: systemTotal
    } = data;

    const percentageInfo = (partialValue, { cvesTotal }) => {
        let percentage = (partialValue * 100) / cvesTotal;
        return `${partialValue} (${Math.ceil(percentage)}% of total)`;
    };

    const  mapFields = (fields, data, extraInfo = false) => {
        let arr = [];
        for (const field in fields) {

            let { [field]: label } = fields;
            let { [field]: value } = data;

            value = extraInfo
                ? percentageInfo(value, data)
                : value.toString();

            arr.push([label, value]);
        }

        return arr;
    };

    const title = [
        ' This report is an executive summary of vulnerabilities that may impact your Red Hat Enterprise Linux servers.',
        'The vulnerability service is analyzing ',
        { title: `${systemTotal} RHEL systems `, fontWeight: 700 }, 'and had identified ',
        { title: `${cvesTotal} CVEs `, fontWeight: 700 }, 'that impact 1 or more of these systems'
    ];

    const recentCvesData = mapFields(
        recentCvesMapping,
        {
            ...recentCves,
            cvesTotal
        }
    );
    const CVSSData = mapFields(
        CVSSMapping,
        {
            ...cvesBySeverity,
            cvesTotal
        },
        true
    );

    const CVSSChart = mapFields(
        CVSSMapping,
        {
            ...cvesBySeverity,
            cvesTotal
        }
    ).map((severity) => {
        let [x, y] = severity;
        return { x: `CVSS ${x}`, y };
    });

    return (
        <DownloadButton
            className="download-executive-report"
            label={label}
            type="Vulnerability"
            title={title}
            pages={[
                <Fragment key="first-section">
                    <Section title="Identified vulnerabilities by severity">
                        <Column>
                            <Table
                                withHeader
                                rows={[CVSSHeader, ...CVSSData]}
                            />
                        </Column>
                        <Column>
                            <Chart
                                chartType="pie"
                                subTitle="Cves"
                                title="100"
                                data={CVSSChart}
                            />
                        </Column>
                    </Section>
                    <Section title="Recently published CVEs identified on systems">
                        <Column>
                            <Table
                                withHeader
                                rows={[recentCvesHeader, ...recentCvesData]}
                            />
                        </Column>
                        <Column>
                        </Column>
                    </Section>
                    <Section title="Top 3 vulnerabilities in your infrastructure"  withColumn={false}>
                        {topCves.map(cve => (
                            <Panel key={cve.synopsis} title={cve.synopsis} description={cve.description}>
                                <PanelItem title="CVSS score">
                                    {Number.parseFloat(cve.cvss3_score).toFixed(1)}
                                </PanelItem>
                                <PanelItem title="Systems exposed">
                                    {cve.systems_affected.toString()}
                                </PanelItem>
                            </Panel>
                        ))}
                    </Section>
                </Fragment>
            ]}/>
    );
};

ExecutiveReport.propTypes = {
    data: propTypes.object,
    label: propTypes.object,
    triggerClick: propTypes.func
};

export default ExecutiveReport;
