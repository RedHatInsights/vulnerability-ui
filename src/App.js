
import React, {
    useEffect,
    useState,
    useMemo,
    Fragment
} from 'react';
import PropTypes from 'prop-types';
import { useDispatch } from 'react-redux';
import routerParams from '@redhat-cloud-services/frontend-components-utilities/RouterParams';
import NotificationPortal from '@redhat-cloud-services/frontend-components-notifications/NotificationPortal';
import { notificationsReducer as notifications } from '@redhat-cloud-services/frontend-components-notifications/redux';
import ReducerRegistry from './Utilities/ReducerRegistry';
import { setGlobalFilter } from './Store/Actions/Actions';
import { Routes } from './Utilities/Routes';
import NoAccessPage from './Components/PresentationalComponents/StaticPages/NoAccessPage';
import './App.scss';

ReducerRegistry.register({ notifications });

const App = ({ history, location }) => {
    const [access, setAccess] = useState(true);
    const baseComponentUrl = location.pathname;

    const dispatch = useDispatch();

    const appNavClick = useMemo(() => ({
        cves(redirect) { insights?.chrome?.appNavClick({ id: 'cves', redirect }); },
        systems(redirect) { insights?.chrome?.appNavClick({ id: 'systems', redirect }); },
        reports(redirect) { insights?.chrome?.appNavClick({ id: 'reports', redirect }); }
    }), []);

    useEffect(() => {
        const permissionList = ['vulnerability:*:*', 'vulnerability:vulnerability:*'];

        insights?.chrome?.init();
        insights?.chrome?.identifyApp('vulnerability');

        (async () => {
            const userPermissions = await insights?.chrome?.getUserPermissions?.('vulnerability');
            setAccess(userPermissions.some(access => permissionList.includes(access.permission)));
        })();

        const unregister = insights?.chrome?.on('APP_NAVIGATION', event => {
            insights?.chrome?.hideGlobalFilter?.(false);
            if (event.domEvent) {
                history.push(`/${event.navId}`);
                appNavClick[event.navId] !== undefined ? appNavClick[event.navId](true) : appNavClick.cves;
            }
        });

        history.listen((location) => {
            const { pathname } = location;

            const navId = pathname.split('/').filter(element => element.length > 0)[0];
            appNavClick[navId] !== undefined ? appNavClick[navId](true) : appNavClick.cves;
        });

        return () => unregister();

    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    useEffect(() => {
        const unregister = insights?.chrome?.on('GLOBAL_FILTER_UPDATE', ({ data }) => {
            const [workloads, SIDs, tags] = insights?.chrome?.mapGlobalFilter?.(data, true, true);
            dispatch(setGlobalFilter({ workloads, SIDs, tags }));

        });

        return () => unregister();
    }, [appNavClick, baseComponentUrl, dispatch]);

    return (
        access ?
            <Fragment>
                <NotificationPortal />
                <Routes />
            </Fragment>
            : <NoAccessPage/>
    );

};

App.propTypes = {
    location: PropTypes.object,
    history: PropTypes.object
};

export default routerParams(App);
