import React, { Fragment, useState, useMemo } from 'react';
import propTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';
import { withRouter } from 'react-router-dom';
import { dataShape } from '../../../Helpers/MiscHelper';
import { fetchSystems, fetchSystemsIds } from '../../../Store/Actions/Actions';
import { PrimaryToolbar } from '@redhat-cloud-services/frontend-components/PrimaryToolbar';
import useSearchFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SearchFilter';
import { exportConfig, buildActiveFilters, removeFilters, isFilterInDefaultState } from '../../../Helpers/TableToolbarHelper';
import DownloadReport from '../../../Helpers/DownloadReport';
import DownloadSystemsReport from '../Reports/DownloadSystemsReport';
import { kebabItemDownloadPDF } from '../../PresentationalComponents/DownloadReportKebab/KebabItems';
import excludedFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/ExcludedFilter';
import { SYSTEMS_DEFAULT_FILTERS, SYSTEMS_FILTER_PARAMS } from '../../../Helpers/constants';
import { useBulkSelect } from '../../../Helpers/Hooks';

const SystemsTableToolbar = ({
    selectedRows,
    totalSelectedRows,
    intl,
    parameters,
    systems,
    methods
}) => {
    const [exportPDF, setExportPDF] = useState(false);
    const { apply, handleSelect, doOptOut } = methods;

    const downloadReport = format => {
        let params = { ...parameters };
        DownloadReport.exec(fetchSystems, params,  format, 'system-list');
    };

    const kebabProps = useMemo(() => {
        const selectedRowsData = systems?.data.filter(s => selectedRows[s.id] === true);
        return {
            selectedExcluded: selectedRowsData.some(({ opt_out: optOut }) => optOut === true),
            selectedIncluded: selectedRowsData.some(({ opt_out: optOut }) => optOut === false)
        };
    }, [selectedRows, systems]);

    const kebabOptions = [
        '',
        {
            label: intl.formatMessage(messages.systemKebabExcludeAnalysis, { count: totalSelectedRows }),
            onClick: () => doOptOut(null, true),
            props: { isDisabled: !totalSelectedRows || !kebabProps.selectedIncluded }
        },
        {
            label: intl.formatMessage(messages.systemKebabIncludeAnalysis, { count: totalSelectedRows }),
            onClick: () => doOptOut(null, false),
            props: { isDisabled: !totalSelectedRows || !kebabProps.selectedExcluded }
        }
    ];

    const bulkSelectProps = useBulkSelect({
        rawData: systems,
        selectedRows,
        totalSelectedRows,
        handleSelect,
        fetchResource: ops => fetchSystemsIds({ ...parameters, ...ops })
    });

    return <Fragment>
        <PrimaryToolbar
            className="vuln-systems-primary-toolbar"
            bulkSelect={bulkSelectProps}
            actionsConfig={{
                actions: kebabOptions,
                kebabToggleProps: { isDisabled: !totalSelectedRows || systems.meta.total_items === 0 },
                dropdownProps: { ouiaId: 'toolbar-actions' }
            }}
            filterConfig={{
                items: [
                    useSearchFilter(
                        'filter',
                        messages.systemsSearchName,
                        messages.searchFilterByName,
                        parameters.filter,
                        apply
                    ),
                    excludedFilter(apply, parameters)
                ]
            }}
            activeFiltersConfig={{
                filters: buildActiveFilters(parameters),
                onDelete: (_, chips, reset) => removeFilters(chips, methods.apply, reset, SYSTEMS_DEFAULT_FILTERS),
                deleteTitle: intl.formatMessage(messages.resetFilters),
                showDeleteButton: !isFilterInDefaultState(parameters, SYSTEMS_DEFAULT_FILTERS, SYSTEMS_FILTER_PARAMS)
            }}
            exportConfig={{
                isDisabled: systems.meta.total_items === 0,
                extraItems: [kebabItemDownloadPDF(exportPDF, setExportPDF)],
                ouiaId: 'export',
                ...exportConfig({ downloadReport })
            }}
        />

        { exportPDF &&
            <DownloadSystemsReport
                showButton={false}
                params={parameters}
                filters={buildActiveFilters(parameters)}
                onSuccess={() => setExportPDF(false)}
            />
        }

    </Fragment>;

};

SystemsTableToolbar.propTypes = {
    systems: dataShape,
    parameters: propTypes.object,
    selectedRows: propTypes.array,
    totalSelectedRows: propTypes.number,
    methods: propTypes.shape({
        doOptOut: propTypes.func,
        apply: propTypes.func,
        handleSelect: propTypes.func
    }),
    intl: propTypes.any
};

export default withRouter(
    injectIntl(SystemsTableToolbar)
);

