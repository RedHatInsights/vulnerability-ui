import SystemDetailsPage from './SystemDetailsPage';
import toJson from 'enzyme-to-json';
import { mountWithIntl } from '../../../Helpers/MiscHelper';
import { BrowserRouter as Router } from 'react-router-dom';
import configureStore from 'redux-mock-store';
import { Provider } from "react-redux";

const customMiddleWare = store => next => action => {
    next(action);
  }
const mockStore = configureStore([customMiddleWare]);
let storeObj = { 
    SystemCvesStore: {
        cveList: {
            payload: {
                errors: undefined
            }
        }
    },
    entityDetails: {
        entity: 'testEntity',
        opt_out: false
    }
};

const props = {
    optOutSystem: jest.fn(() => Promise.resolve('hello world')),
    fetchSystemDetails: jest.fn(),
    addNotification: jest.fn(),
    match: { params: {inventoryId: 'testCve'} }
};

window.insights = { 
    loadInventory: (args) => new Promise((resolve, reject) => {
        resolve({
            inventoryConnector: (args) => { 
                const InventoryDetailHead = ({ testProp }) => <div>A mock with '{testProp}' passed!</div>;
                const AppInfo = ({ testProp }) => <div>this is inventory body</div>;
                return ({ InventoryDetailHead, AppInfo });
            },
            mergeWithEntities: () => {},
            mergeWithDetail: () => {},
            INVENTORY_ACTION_TYPES: ''
        })
    }) 
};

describe('SystemDetailPage', () => {
    it('Should match the snapshots', async () => {
        const tempStore = mockStore(storeObj);
        const wrapper = mountWithIntl(
            <Provider store={tempStore}>
                <Router>
                    <SystemDetailsPage { ...props } />
                </Router>
            </Provider>);
        await Promise.resolve();
        wrapper.update();
        expect(toJson(wrapper)).toMatchSnapshot();
    });

    it('Should pass valid optOutSystemHandler to AppInfo', async () => {
        let wrapper = shallow(
            <SystemDetailsPage.WrappedComponent {...props}/>);
        await Promise.resolve();
        wrapper.update();
        const optOut = wrapper.find('AppInfo').props().optOutSystemHandler;
        optOut('testParam');
        expect(props.optOutSystem).toHaveBeenCalledWith('testCve', 'testParam'); 
        expect(props.fetchSystemDetails).toHaveBeenCalledWith('testCve');
    });

    it('Should call optOutSystem with true when entity exists and isOptOut is true', async () => {
        const tempStore = mockStore(storeObj);
        let wrapper = mountWithIntl(
            <Provider store={tempStore}>
                <Router>
                    <SystemDetailsPage.WrappedComponent {...props} systemDetails = {{opt_out: true, entity: true}} intl = {{ formatMessage: jest.fn()}}/>);
                </Router>
            </Provider>);
        await Promise.resolve();
        wrapper.update();
        wrapper.find('InventoryDetailHead').props().actions[0].onClick();
        expect(props.optOutSystem).toHaveBeenCalledWith('testCve', false);
        expect(props.fetchSystemDetails).toHaveBeenCalledWith('testCve');
    });

    it('Should call optOutSystem with false when entity exists and isOptOut is false', async () => {
        const tempStore = mockStore(storeObj);
        let wrapper = mountWithIntl(
            <Provider store={tempStore}>
                <Router>
                    <SystemDetailsPage.WrappedComponent {...props} systemDetails = {{opt_out: false, entity: true}} intl = {{ formatMessage: jest.fn()}}/>);
                </Router>
            </Provider>);
        await Promise.resolve();
        wrapper.update();
        wrapper.find('InventoryDetailHead').props().actions[0].onClick();
        expect(props.optOutSystem).toHaveBeenCalledWith('testCve', true);
        expect(props.fetchSystemDetails).toHaveBeenCalledWith('testCve');
    });
});