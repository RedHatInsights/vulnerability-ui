import Immutable from 'seamless-immutable';
import * as ActionTypes from '../ActionTypes';
import { applyGlobalFilter } from './reducersHelper';
import { DEFAULT_PAGE_SIZE, SYSTEMS_EXPOSED_HEADER } from '../../Helpers/constants';

export const initialState = Immutable({
    parameters: {
        page: 1,
        page_size: DEFAULT_PAGE_SIZE,
        selectedHosts: [],
        status_id: undefined,
        sort: '-updated'
    },
    cveDetails: {
        isLoading: true,
        payload: {},
        error: {
            hasError: false
        }
    },
    columns: SYSTEMS_EXPOSED_HEADER
});

export const CVEDetailsPageStore = (state = initialState, action) => {
    let newState;

    switch (action.type) {
        case ActionTypes.FETCH_CVE_DETAILS + '_REJECTED':
            newState = state.setIn(['cveDetails', 'error'], { hasError: true, errorCode: action.payload.status });
            newState = newState.setIn(['cveDetails', 'isLoading'], false);
            return newState;
        case ActionTypes.FETCH_CVE_DETAILS + '_PENDING':
            newState = state.setIn(['cveDetails', 'isLoading'], true);
            return newState;

        case ActionTypes.FETCH_CVE_DETAILS + '_FULFILLED':
            newState = state.setIn(['cveDetails', 'payload'], action.payload);
            newState = newState.setIn(['cveDetails', 'isLoading'], false);
            return newState;

        case ActionTypes.CHANGE_EXPOSED_SYSTEMS_PARAMETERS: {
            const { reset, ...params } = action.payload;

            newState = state.setIn(['parameters'], {
                ...!reset ? state.parameters : {},
                ...params,
                page_size: action.payload.page_size || state.parameters.page_size
            });
            return newState;
        }

        case ActionTypes.CHANGE_COLUMNS_CVE_DETAIL:
            newState = state.setIn(['columns'], action.payload);
            return newState;
        case ActionTypes.SET_GLOBAL_FILTER:
            newState = state.setIn(['parameters'], {
                ...applyGlobalFilter(state.parameters, action.payload)
            });
            return newState;
        case ActionTypes.CLEAR_CVE_STORE:
            return Immutable({
                ...initialState,
                columns: state.columns
            });
        default:
            return state;
    }
};

