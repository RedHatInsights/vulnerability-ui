import React, {
    useEffect,
    useState,
    useMemo,
    Fragment
} from 'react';
import { useDispatch } from 'react-redux';
import NotificationPortal from '@redhat-cloud-services/frontend-components-notifications/NotificationPortal';
import { notificationsReducer as notifications } from '@redhat-cloud-services/frontend-components-notifications/redux';
import ReducerRegistry from './Utilities/ReducerRegistry';
import { setGlobalFilter } from './Store/Actions/Actions';
import { Routes } from './Utilities/Routes';
import { useHistory, useLocation } from 'react-router-dom';
import NoAccessPage from './Components/PresentationalComponents/StaticPages/NoAccessPage';
import './App.scss';
import ReadOnlyBanner from './Components/PresentationalComponents/ReadOnlyBanner/ReadOnlyBanner';
import { useRbac } from './Helpers/Hooks';
import { PERMISSIONS } from './Helpers/constants';
import Spinner from '@redhat-cloud-services/frontend-components/Spinner';
import { useChrome } from '@redhat-cloud-services/frontend-components/useChrome';

ReducerRegistry.register({ notifications });

const App = () => {
    const { push } = useHistory();
    const { pathname } = useLocation();
    const chrome = useChrome();
    const [[isUserAuthorized], isLoading] = useRbac([PERMISSIONS.accessApplication]);
    const [isReadOnlyBannerVisible, setReadOnlyBannerVisible] = useState(false);

    const dispatch = useDispatch();

    const appNavClick = useMemo(() => ({
        cves(redirect) { chrome.appNavClick({ id: 'cves', redirect }); },
        systems(redirect) { chrome.appNavClick({ id: 'systems', redirect }); },
        reports(redirect) { chrome.appNavClick({ id: 'reports', redirect }); }
    }), []);

    useEffect(() => {
        const unregister = chrome.on('APP_NAVIGATION', event => {
            chrome.hideGlobalFilter(false);
            if (event.domEvent) {
                push(`/${event.navId}`);
                appNavClick[event.navId] !== undefined ? appNavClick[event.navId](true) : appNavClick.cves(true);
            }
        });

        return () => unregister();

        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    useEffect(() => {
        const baseComponentUrl = pathname.split('/')[1];
        chrome &&
            baseComponentUrl &&
            appNavClick[baseComponentUrl] !== undefined &&
            appNavClick[baseComponentUrl](false);

        const unregister = chrome.on('GLOBAL_FILTER_UPDATE', ({ data }) => {
            const [workloads, SIDs, tags] = chrome.mapGlobalFilter(data, true, true) ?? [null, null, null];
            dispatch(setGlobalFilter({ workloads, SIDs, tags }));
        });

        return () => unregister();
    }, [appNavClick, pathname, dispatch]);

    window.setReadOnlyBannerVisible = setVisible => setReadOnlyBannerVisible(setVisible);

    return (
        isLoading ? <Spinner centered /> : isUserAuthorized ?
            <Fragment>
                <NotificationPortal />
                {isReadOnlyBannerVisible && <ReadOnlyBanner />}
                <Routes />
            </Fragment>
            : <NoAccessPage />
    );
};

export default App;
