import { Stack, StackItem } from '@patternfly/react-core';
import { InfoCircleIcon } from '@patternfly/react-icons';
import { routerParams } from '@red-hat-insights/insights-frontend-components';
import { some } from 'lodash';
import propTypes from 'prop-types';
import React from 'react';
import { connect } from 'react-redux';
import { getReportFromList } from '../../../Helpers/APIHelper';
import { dispatchAction } from '../../../Helpers/Dispatcher';
import { dataShape, triggerFileDownload } from '../../../Helpers/MiscHelper';
import { emptyCveList, fetchCveListByAccount } from '../../../Store/Actions/Actions';
import { sCveTableByAccount } from '../../../Store/Selectors/VulnerabilitiesSelectors';
import VulnerabilitiesCveTable from '../VulnerabilitiesCveTable/VulnerabilitiesCveTable';
import VulnerabilitiesCveTableToolbar from '../VulnerabilitiesCveTable/VulnerabilitiesCveTableToolbar';

class VulnerabilitiesCves extends React.Component {
    constructor(props) {
        super(props);
        this.apply = this.apply.bind(this);
        this.sendRequest = this.sendRequest.bind(this);
        this.downloadReport = this.downloadReport.bind(this);
    }

    componentDidMount() {
        this.sendRequest();
    }

    componentWillUnmount() {
        this.props.emptyStore();
    }
    apply(config) {
        const toBeReset = ['filter', 'page_size', 'show_all'];
        if (some(toBeReset.map(item => config.hasOwnProperty(item)), item => item === true)) {
            config.page = 1;
        }

        this.setState({ ...this.state, ...config }, this.sendRequest);
    }

    async downloadReport() {
        let reportData = await getReportFromList(this.props.fetchResource, this.state, 'csv');
        triggerFileDownload(reportData);
    }

    sendRequest() {
        this.props.fetchData(() => this.props.fetchResource(this.state));
    }

    render() {
        const cves = this.props.dataSelector(this.props.CVETable);
        return (
            <React.Fragment>
                <Stack gutter="lg">
                    <StackItem>
                        <VulnerabilitiesCveTableToolbar
                            apply={this.apply}
                            showAllCheckbox={this.props.showAllCheckbox}
                            totalNumber={cves.meta.total_items}
                            downloadReport={this.downloadReport}
                        />
                    </StackItem>
                    <StackItem>
                        <VulnerabilitiesCveTable header={this.props.header} cves={cves} apply={this.apply} />
                    </StackItem>
                </Stack>
            </React.Fragment>
        );
    }
}

function mapStateToProps(state) {
    return {
        CVETable: state
    };
}

const mapDispatchToProps = () => {
    return {
        fetchData: action => dispatchAction(action()),
        emptyStore: () => dispatchAction(emptyCveList())
    };
};

VulnerabilitiesCves.defaultProps = {
    header: [
        { title: ' ', key: 'impact', width: 3 },
        { title: 'Name', key: 'synopsis', width: 10 },
        { title: 'Description', key: 'description', hasSort: false },
        {
            title: (
                <React.Fragment>
                    {'CVSS Base Score'} <InfoCircleIcon />
                </React.Fragment>
            ),
            key: 'cvss_score',
            width: 10
        },
        { title: 'Systems Exposed', key: 'systems_affected', width: 3 },
        { title: 'Publish date', key: 'public_date', width: 10 }
    ],
    fetchResource: fetchCveListByAccount,
    dataSelector: sCveTableByAccount,
    showAllCheckbox: true
};

VulnerabilitiesCves.propTypes = {
    CVETable: dataShape,
    fetchData: propTypes.func,
    fetchResource: propTypes.func,
    header: propTypes.array,
    dataSelector: propTypes.func,
    showAllCheckbox: propTypes.bool,
    emptyStore: propTypes.func
};

export default routerParams(
    connect(
        mapStateToProps,
        mapDispatchToProps
    )(VulnerabilitiesCves)
);
