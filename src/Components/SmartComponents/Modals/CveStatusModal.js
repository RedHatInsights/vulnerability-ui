import { Checkbox } from '@patternfly/react-core/dist/js/components/Checkbox/Checkbox';
import { Form, FormGroup } from '@patternfly/react-core/dist/js/components/Form/';
import { Split, SplitItem } from '@patternfly/react-core/dist/js/layouts/Split/';
import { Tooltip } from '@patternfly/react-core/dist/js/components/Tooltip/Tooltip';
import InfoCircleIcon from '@patternfly/react-icons/dist/js/icons/info-circle-icon';
import OutlinedQuestionCircleIcon from '@patternfly/react-icons/dist/js/icons/outlined-question-circle-icon';
import propTypes from 'prop-types';
import React, { useState } from 'react';
import { setCveStatus, setSystemCveStatus } from '../../../Helpers/APIHelper';
import BaseModal, { useJustificationInput, useStatusSelect } from './BaseModal';
import { Stack } from '@patternfly/react-core/dist/js/layouts/Stack/Stack';
import { StackItem } from '@patternfly/react-core/dist/js/layouts/Stack/StackItem';

export const CveStatusModal = ({ cves, updateRef }) => {
    const [cveList] = useState(cves);
    const { StatusSelect, statusId } = useStatusSelect(getDefaultStatus());
    const { JustificationInput, justification } = useJustificationInput(getDefaultLabel());
    const [checkboxState, setCheckboxState] = useState(false);

    const handleSave = () => {
        const cveIds = cveList.map(item => item.id);
        return setCveStatus({
            status_id: parseInt(statusId),
            cve: cveIds,
            status_text: justification
        })
        .then(() => !checkboxState && setSystemCveStatus({ cve: cveIds }))
        .then(updateRef);
    };

    function getDefaultStatus() {
        return (cveList && cveList.length === 1 && cveList[0].status_id.toString()) || '0';
    }

    function getDefaultLabel() {
        return (cveList && cveList.length === 1 && cveList[0].justification) || '';
    }

    const successNotification = {
        variant: 'success',
        title: `Status updated for ${cveList.length} CVEs`
    };
    const title = cveList.length > 1 ? 'Set status for these CVEs and all systems' : 'Set status for this CVE and all systems';
    return (
        <BaseModal items={cveList} onSave={handleSave} onSuccessNotification={successNotification} title={title}>
            <Stack gutter={'md'}>
                <StackItem>
                    <Form key="key">
                        {StatusSelect}
                        {JustificationInput}
                        <FormGroup fieldId={'overwrite'}>
                            <Checkbox
                                label={
                                    <React.Fragment>
                                        Do not overwrite individual system status{' '}
                                        <Tooltip
                                            content="When checked, this setting does not change any pre-existing
                                        statuses set on individual systems for this CVE."
                                        >
                                            <React.Fragment>
                                                <OutlinedQuestionCircleIcon />
                                            </React.Fragment>
                                        </Tooltip>
                                    </React.Fragment>
                                }
                                id="alt-form-checkbox-1"
                                name="alt-form-checkbox-1"
                                isChecked={checkboxState}
                                onChange={checked => setCheckboxState(checked)}
                            />
                        </FormGroup>
                        <FormGroup fieldId={'info'}>
                            <Split>
                                <SplitItem style={{ marginRight: 'var(--pf-global--spacer--xs)' }}>
                                    <InfoCircleIcon size="md" color="var(--pf-global--active-color--400)" />
                                </SplitItem>
                                <SplitItem isFilled>
                                    This status is applied to all existing matching systems. Any new matching systems will have
                                    the status &quot;Not reviewed&quot;{' '}
                                    <Tooltip
                                        content='Example: If a new system is added and matches to this vulnerability,
                                    it will be given a status "Not reviewed"'
                                    >
                                        <React.Fragment>
                                            <OutlinedQuestionCircleIcon />
                                        </React.Fragment>
                                    </Tooltip>
                                </SplitItem>
                            </Split>
                        </FormGroup>
                    </Form>
                </StackItem>
            </Stack>
        </BaseModal>
    );
};

CveStatusModal.propTypes = {
    cves: propTypes.array,
    updateRef: propTypes.func
};

export default CveStatusModal;
