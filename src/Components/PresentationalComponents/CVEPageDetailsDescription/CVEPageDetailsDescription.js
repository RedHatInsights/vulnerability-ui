import { Grid, GridItem, Popover, Stack, StackItem, Text, TextContent, TextVariants } from '@patternfly/react-core';
import { ExclamationTriangleIcon } from '@patternfly/react-icons';
import { Table, TableBody, TableHeader, TableVariant } from '@patternfly/react-table';
import propTypes from 'prop-types';
import React from 'react';
import { STATUS_OPTIONS } from '../../../Helpers/constants';
import './CVEPageDetailsDescription.scss';
import SnippetWithHeaderAndTooltip, { SnippetWithHeaderAndPopover } from './SnippetWithHeaderAndTooltip';

const CVEPageDetailsDescription = ({ cveAttributes }) => {
    const {
        public_date: publishDate,
        description,
        rh_link: link,
        business_risk: businessRisk,
        business_risk_justification: businessRiskJustification,
        status,
        status_justification: statusJustification,
        systems_status_detail: systemsStatusDetail,
        systems_status_divergent: systemsStatusDivergent
    } = cveAttributes;
    const detailRows =
        systemsStatusDetail &&
        Object.keys(systemsStatusDetail).map(item => [
            STATUS_OPTIONS.find(status => status.value === item.toString()).label,
            systemsStatusDetail[item].toString()
        ]);
    const businessRiskTooltip = (
        <p>
            Justification note: <br />
            {businessRiskJustification}
        </p>
    );
    return (
        <React.Fragment>
            <Stack gutter="sm">
                <StackItem></StackItem>
                <StackItem>
                    <Grid gutter="sm">
                        <GridItem span={2}>
                            <SnippetWithHeaderAndTooltip
                                title={'Business risk'}
                                value={businessRisk}
                                tooltipText={businessRiskJustification && businessRiskTooltip}
                            />
                        </GridItem>
                        <GridItem span={2}>
                            <Popover
                                headerContent={''}
                                aria-label={'Status popover'}
                                position="right"
                                bodyContent={
                                    <TextContent>
                                        <Stack>
                                            <StackItem>
                                                CVE status
                                                <Text component={TextVariants.h6}>{status}</Text>
                                            </StackItem>
                                            <StackItem>
                                                Justification note
                                                <Text component={TextVariants.h6}>{statusJustification}</Text>
                                            </StackItem>

                                            <StackItem>
                                                <Text component={TextVariants.h2}>Systems with this CVE</Text>
                                                <Table
                                                    aria-label={'Status details'}
                                                    variant={TableVariant.compact}
                                                    borders={false}
                                                    gridBreakPoint={null}
                                                    cells={['Status', 'Count']}
                                                    rows={detailRows}
                                                >
                                                    <TableHeader />
                                                    <TableBody />
                                                </Table>
                                            </StackItem>
                                        </Stack>
                                    </TextContent>
                                }
                            >
                                <SnippetWithHeaderAndPopover
                                    title={'Status'}
                                    value={
                                        <span>
                                            {systemsStatusDivergent > 0 ? (
                                                <ExclamationTriangleIcon color={'var(--pf-global--warning-color--100)'} />
                                            ) : (
                                                ''
                                            )}{' '}
                                            {status}
                                        </span>
                                    }
                                />
                            </Popover>
                        </GridItem>
                    </Grid>
                </StackItem>
                <StackItem>
                    <TextContent>
                        <Text component={TextVariants.p}>{description}</Text>
                    </TextContent>
                </StackItem>
                <StackItem>
                    <TextContent>
                        <Text component={TextVariants.p}>Publish date: {publishDate}</Text>
                        <Text component={TextVariants.p}>{link}</Text>
                    </TextContent>
                </StackItem>
            </Stack>
        </React.Fragment>
    );
};

CVEPageDetailsDescription.propTypes = {
    cveAttributes: propTypes.any
};

export default CVEPageDetailsDescription;
