import React, { useEffect, useState, lazy, Suspense, Fragment } from 'react';
import PropTypes from 'prop-types';
import { Navigate, Route, Routes, useLocation } from 'react-router-dom';
import { getSystems } from '../Helpers/APIHelper';
import { PATHS } from '../Helpers/constants';
import { intl } from './IntlProvider';
import messages from '../Messages';
import AsyncComponent from '@redhat-cloud-services/frontend-components/AsyncComponent';
import ErrorState from '@redhat-cloud-services/frontend-components/ErrorState';
import { useChrome } from '@redhat-cloud-services/frontend-components/useChrome';

const SystemsPage = lazy(() =>
    import(
        /* webpackChunkName: "Systems" */ '../Components/SmartComponents/SystemsPage/SystemsPage'
    )
);

const LandingPage = lazy(() =>
    import(
        /* webpackChunkName: "LandingPage" */ '../Components/SmartComponents/LandingPage/LandingPage'
    )
);

const Upgrade = lazy(() =>
    import(
        /* webpackChunkName: "Upgrade" */ '../Components/PresentationalComponents/StaticPages/UpgradePage'
    )
);

const CVEDetailsPage = lazy(() =>
    import(
        /* webpackChunkName: "CVEDetailsPage" */ '../Components/SmartComponents/CVEDetailsPage/CVEDetailsPage'
    )
);

const SystemDetailsPage = lazy(() =>
    import(
        /* webpackChunkName: "SystemDetailsPage" */ '../Components/SmartComponents/SystemDetailsPage/SystemDetailsPage'
    )
);
const Reports = lazy(() =>
    import(/* webpackChunkName: "Reports" */ '../Components/SmartComponents/Reports/ReportsPage')
);

const InsightsElement = ({ element: Element, title, globalFilterEnabled, ...elementProps }) => {
    let location = useLocation();
    const [hasSystems, setHasSystems] = useState(true);
    const chrome = useChrome();

    useEffect(() => {
        const fetchData = async () => {
            const result = await getSystems();
            setHasSystems(result?.meta?.total_items > 0);
        };

        fetchData();
    }, []);

    const subPath = location.pathname && location.pathname.split('/')[4];

    useEffect(() => {
        chrome.updateDocumentTitle(`${subPath ? `${subPath} - ` : ''} ${title} -
         ${intl.formatMessage(messages.pageTitleSuffix)}`);
    }, [chrome, intl, subPath]);

    useEffect(() => {
        chrome.hideGlobalFilter(!globalFilterEnabled);
    }, [location.pathname]);

    return (
        !hasSystems ?
            <AsyncComponent
                appId="vulnerability_zero_state"
                appName="dashboard"
                module="./AppZeroState"
                scope="dashboard"
                ErrorComponent={<ErrorState />}
                app="Vulnerability"
            />
            : <Element {...elementProps}/>
    );
};

InsightsElement.propTypes = {
    element: PropTypes.func,
    title: PropTypes.string,
    globalFilterEnabled: PropTypes.bool
};

export const VulnerabilityRoutes = () => {
    return (
        <Suspense fallback={Fragment}>
            <Routes>
                <Route
                    path={PATHS.cveDetailsPage.to}
                    element={
                        <InsightsElement
                            element={CVEDetailsPage}
                            title={intl.formatMessage(messages.cvesHeader)}
                            globalFilterEnabled
                        />
                    }
                />
                <Route
                    path={PATHS.cveDetailsEdgePage.to}
                    element={
                        <InsightsElement
                            element={CVEDetailsPage}
                            title={intl.formatMessage(messages.cvesHeader)}
                            isImmutableTabOpen
                        />
                    }
                />
                <Route
                    path={PATHS.systemDetailsPage.to}
                    element={<SystemDetailsPage />}
                />

                <Route
                    path={PATHS.home.to}
                    element={
                        <InsightsElement
                            element={LandingPage}
                            title={intl.formatMessage(messages.cvesHeader)}
                            globalFilterEnabled
                        />
                    }
                />

                <Route
                    path={PATHS.cvesPage.to}
                    element={
                        <InsightsElement
                            element={LandingPage}
                            title={intl.formatMessage(messages.cvesHeader)}
                            globalFilterEnabled
                        />
                    }
                />

                <Route
                    path={PATHS.systemsPage.to}
                    element={
                        <InsightsElement
                            element={SystemsPage}
                            title={intl.formatMessage(messages.systemsHeader)}
                            globalFilterEnabled
                        />
                    }
                />

                <Route
                    path={PATHS.upgrade.to}
                    element={<InsightsElement element={Upgrade} title={intl.formatMessage(messages.upgradePageTitle)} />}
                />

                <Route
                    path={PATHS.reports.to}
                    element={<InsightsElement element={Reports} title={intl.formatMessage(messages.reportsPageTitle)} />}
                />

                <Route
                    path="*"
                    element={<Navigate to="cves" />}
                />
            </Routes>
        </Suspense>
    );
};
