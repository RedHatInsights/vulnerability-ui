import React, { useMemo } from 'react';
import propTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';
import { CVETableContext } from './SystemCves';
import Remediation from '../Remediation/Remediation';
import selectAllCheckbox from '../../../Helpers/selectAllCheckboxHelper';
import { PrimaryToolbar } from '@redhat-cloud-services/frontend-components/PrimaryToolbar';
import publishDateFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/PublishDateFilter';
import useCvssBaseScoreFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/CvssBaseScoreFilter';
import impactFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/ImpactFilter';
import useSearchFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SearchFilter';
import securityRuleFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/SecurityRuleFilter';
import businessRiskFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/BusinessRiskFilter';
import knownExploitFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/KnownExploitFilter';
import statusFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/StatusFilter';
import remediationFilter from '../../PresentationalComponents/Filters/PrimaryToolbarFilters/RemediationFilter';
import {
    handleChangePage,
    handleSetPageSize,
    exportConfig,
    buildActiveFilters,
    removeFilters
} from '../../../Helpers/TableToolbarHelper';

const SystemCveToolbarWithContext = ({ entity, intl, context }) => {

    const onExpandAllClick = () => {
        const { cves, methods, isAllExpanded } = context;
        const isOpen = !isAllExpanded;
        const expandedRows = !isAllExpanded ? cves.data.filter(cve => cve.id).map(cve => cve.id) : [];
        methods.openCves(isOpen, expandedRows, !isAllExpanded);
    };

    const { cves, parameters, methods, selectedCves, selectedRowsRawData, isAllExpanded, canEditStatus, canRemediate } = context;
    const { filter, advisory } = parameters;
    const selectedCvesCount = canRemediate && ((selectedCves && selectedCves.length) || 0);

    const selectOptions = useMemo(() => selectAllCheckbox({
        selectedItems: selectedCves,
        selectorHandler: methods.selectCves,
        items: cves,
        fetchResource: ops => methods.fetchResource({ ...parameters, ...ops }),
        multiRow: true
    }), [selectedCves, cves, parameters, methods]);

    const actions = ['',
        ...(canEditStatus ?
            [({
                label: intl.formatMessage(messages.editStatus),
                onClick: () => methods.showStatusModal(selectedRowsRawData, true),
                props: { isDisabled: !selectedCvesCount }
            })] : []),
        {
            label: intl.formatMessage(messages.columnManagementModalTitle),
            onClick: () => methods.setColumnModalOpen(true)
        }
    ];

    return (
        <PrimaryToolbar
            pagination={{
                itemCount: cves.meta.total_items || 0,
                page: cves.meta.page || 1,
                perPage: cves.meta.page_size || 1,
                ouiaId: 'pagination-top',
                onSetPage: (_event, page) => handleChangePage(_event, page, methods.apply),
                onPerPageSelect: (_event, perPage) => handleSetPageSize(_event, perPage, methods.apply)
            }}
            dedicatedAction={(canRemediate && entity &&
                <Remediation
                    systems={entity}
                    cves={selectedRowsRawData}
                />)}
            actionsConfig={{
                actions,
                dropdownProps: { ouiaId: 'toolbar-actions' }
            }}
            bulkSelect={{
                count: selectedCvesCount,
                items: selectOptions.items,
                isDisabled: cves.meta.total_items === 0 && selectedCvesCount === 0,
                checked: Boolean(selectedCvesCount),
                ouiaId: 'bulk-select',
                onSelect: () => selectOptions.handleOnCheckboxChange()
            }}
            filterConfig={{
                items: [
                    useSearchFilter('filter', messages.cve, messages.searchFilterByCveID, filter, methods.apply),
                    securityRuleFilter(methods.apply, parameters),
                    knownExploitFilter(methods.apply, parameters),
                    impactFilter(methods.apply, parameters),
                    useCvssBaseScoreFilter(methods.apply, parameters),
                    businessRiskFilter(methods.apply, parameters),
                    publishDateFilter(methods.apply, parameters),
                    statusFilter(methods.apply, parameters),
                    useSearchFilter('advisory', messages.advisory, messages.searchFilterByAdvisory, advisory, methods.apply),
                    remediationFilter(methods.apply, parameters)
                ]
            }}
            activeFiltersConfig={{
                filters: buildActiveFilters(parameters),
                onDelete: (_, chips) => removeFilters(chips, methods.apply),
                deleteTitle: intl.formatMessage(messages.resetFilters)
            }}
            exportConfig={{
                isDisabled: cves.meta.total_items === 0,
                ouiaId: 'export',
                ...exportConfig(methods)
            }}
            expandAll={{
                isAllExpanded,
                onClick: onExpandAllClick
            }}
        />
    );
};

SystemCveToolbarWithContext.defaultProps = {
    totalNumber: 0,
    apply: () => undefined,
    downloadReport: () => undefined
};

SystemCveToolbarWithContext.propTypes = {
    entity: propTypes.string,
    context: propTypes.object,
    intl: propTypes.any
};

const SystemCveToolbar = props => (
    <CVETableContext.Consumer>{context => <SystemCveToolbarWithContext context={context} {...props} />}</CVETableContext.Consumer>
);
export default injectIntl(SystemCveToolbar);
