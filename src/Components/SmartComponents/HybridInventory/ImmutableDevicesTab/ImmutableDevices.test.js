import React from 'react';
import '@testing-library/jest-dom';
import { screen, waitFor } from '@testing-library/react';
import { ComponentWithContext } from '../../../../Utilities/TestingUtilities';
import ImmutableDevices from './ImmutableDevices';
import { render } from '@testing-library/react';
import AsynComponent from '@redhat-cloud-services/frontend-components/AsyncComponent';
import { useGetEntities } from './helpers';
import ReducerRegistry from '../../../../Utilities/ReducerRegistry';
import { useRbac } from '../../../../Helpers/Hooks';
import { useSelector } from 'react-redux';

jest.mock('@redhat-cloud-services/frontend-components/AsyncComponent', () => ({
  __esModule: true,
  default: jest.fn((props) => (
    <div {...props} aria-label="immutableDevices-module-mock">
      AsyncComponent
    </div>
  )),
}));

jest.mock('./helpers', () => ({
  ...jest.requireActual('./helpers'),
  useGetEntities: jest.fn(() => {}),
}));

jest.mock('../../../../Helpers/Hooks', () => ({
    ...jest.requireActual('../../../../Helpers/Hooks'),
    useRbac: jest.fn(() => ([ [true], false ] )),
  }));

jest.mock('react-redux', () => ({
    ...jest.requireActual('react-redux'),
    useSelector: jest.fn((state) => state)
}));

const defaultRenderOptions = { store: ReducerRegistry.getStore() };

const waitAsyncComponent = async () => {
    await waitFor(() => {
        expect(
        screen.getByLabelText('immutableDevices-module-mock')
        ).toBeInTheDocument();
    });
};

afterEach(() => {
    jest.clearAllMocks();
});

describe('ImmutableDevices', () => {
  test('renders without issues', async () => {
   render(
      <ComponentWithContext
        renderOptions={defaultRenderOptions}
      >
        <ImmutableDevices />
      </ComponentWithContext>
  );


    await waitAsyncComponent();
  });

  test('renders with correct custom filters', async () => {
    useSelector.mockReturnValue({                
        page: 1, 
        page_size: 20, 
        sort: "-updated" 
    });

    render(
      <ComponentWithContext
        renderOptions={defaultRenderOptions}
      >
        <ImmutableDevices />
      </ComponentWithContext>
    );

    await waitAsyncComponent();
    expect(AsynComponent).toHaveBeenCalledWith(
      expect.objectContaining({
        customFilters: { 
            edgeParams: { 
                host_type: "edge", 
                page: 1, 
                page_size: 20, 
                sort: "-updated" 
            }
        }
      }),
      {}
    );
  });

  test('renders load ImmutableDevices federated module', async () => {
    render(
      <ComponentWithContext
        renderOptions={defaultRenderOptions}
      >
        <ImmutableDevices />
      </ComponentWithContext>
    );

    await waitAsyncComponent();

    expect(AsynComponent).toHaveBeenCalledWith(
      expect.objectContaining({
        appName: 'inventory',
        module: './ImmutableDevices',
      }),
      {}
    );
  });

  test('should display os and group filter from the ImmutableDevices federated module by default', async () => {
    useSelector.mockReturnValue({ enforceEdgeGroups: false })
    render(
      <ComponentWithContext
        renderOptions={defaultRenderOptions}
      >
        <ImmutableDevices />
      </ComponentWithContext>
    );

    await waitAsyncComponent();

    expect(AsynComponent).toHaveBeenCalledWith(
      expect.objectContaining({
        hideFilters: {
          all: true,
          hostGroupFilter: false,
          operatingSystem: false,
        },
      }),
      {}
    );
  });

  test('should hide group filter from the ImmutableDevices federated module when enforce_edge_group is true', async () => {
    useSelector.mockReturnValue({ enforceEdgeGroups: true, total: 10 })
    render(
      <ComponentWithContext
        renderOptions={defaultRenderOptions}
      >
        <ImmutableDevices />
      </ComponentWithContext>
    );

    await waitAsyncComponent();

    expect(AsynComponent).toHaveBeenCalledWith(
      expect.objectContaining({
        hideFilters: {
          all: true,
          hostGroupFilter: true,
          operatingSystem: false,
        },
      }),
      {}
    );
  });

  test('should call getEntities with correct function arguments', async () => {
    render(
      <ComponentWithContext
        renderOptions={defaultRenderOptions}
      >
        <ImmutableDevices cveName='test-cve'/>
      </ComponentWithContext>
    );

    await waitAsyncComponent();

    expect(useGetEntities).toHaveBeenCalledWith({
        createRows: expect.any(Function),
        id:'test-cve',
    });
  });

  test('should display error state when user is not permitted', async () => {
    useSelector.mockReturnValue({ hasError: true, errorCode: 503 });

    render(
      <ComponentWithContext
        renderOptions={{ store: ReducerRegistry.getStore() }}
      >
        <ImmutableDevices cveName='test-cve'/>
      </ComponentWithContext>
    );

    expect(
        screen.getAllByText('This page is temporarily unavailable')
    ).toHaveLength(1);
  });

  test('should display error state when user is not permitted', () => {
    useRbac.mockReturnValue([[false], false]);
    useSelector.mockReturnValue({});

    render(
      <ComponentWithContext
        renderOptions={{ store: ReducerRegistry.getStore() }}
      >
        <ImmutableDevices />
      </ComponentWithContext>
    );

    expect(
        screen.getByText('You do not have permissions to view or manage Vulnerability')
    ).toBeVisible();
  });
});