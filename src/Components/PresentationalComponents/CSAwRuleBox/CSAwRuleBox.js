import React, { Fragment } from 'react';
import PropTypes from 'prop-types';
import {
    Stack,
    StackItem,
    Text,
    TextContent,
    TextVariants,
    Tooltip,
    SplitItem,
    Split,
    Grid,
    GridItem,
    Card,
    CardBody,
    ExpandableSection,
    Button,
    Icon
} from '@patternfly/react-core';
import { InsightsLabel } from '@redhat-cloud-services/frontend-components/InsightsLabel';
import {
    CheckCircleIcon,
    OutlinedQuestionCircleIcon,
    ExternalLinkAltIcon,
    PowerOffIcon
} from '@patternfly/react-icons';
import { injectIntl } from 'react-intl';
import Label from '../Snippets/Label';
import messages from '../../../Messages';
import {
    RISK_OF_CHANGE_TOOLTIP,
    RISK_OF_CHANGE_LABEL,
    RH_KB_URL,
    CVES_PATH,
    impactTextList
} from '../../../Helpers/constants';
import CSAwLabel from '../Snippets/CSAwLabel';
import CSAwRuleSummary from './CSAwRuleSummary';
import './CSAwRuleBox.scss';
import { HashLink } from 'react-router-hash-link';

const CSAwRuleBox = ({ rules, synopsis, intl, setHeaderFilters, headerFilters }) => {
    const sortedRules = [].concat(rules).sort((a, b) => (b.systems_affected - a.systems_affected));
    const handleExposedSystemFilter = (ruleId) => {
        setHeaderFilters(headerFilters?.rule !== ruleId
            ? { rule: ruleId }
            : { rule: undefined }
        );
    };

    /*eslint-disable max-len*/
    return (
        sortedRules && sortedRules.map((rule, index) => (
            rule.summary && (
                <Card className="card-box" key={rule.rule_id} ouiaId={'security-rule-card-' + index}>
                    <ExpandableSection toggleText={
                        <Split isWrappable>
                            <SplitItem className="pf-v5-u-mr-xl">
                                <TextContent>
                                    <Text component={TextVariants.h4}>
                                        <CSAwLabel className="pf-v5-u-mr-sm" />
                                        {rule.description}
                                    </Text>
                                </TextContent>
                            </SplitItem>
                            <SplitItem id="filter-affected-systems-split" className="pf-v5-u-mr-xl">
                                {rule.rule_id &&
                                    <TextContent>
                                        <Button
                                            data-testid="filter-affected-systems"
                                            id="filter-affected-systems"
                                            onClick={event => {
                                                handleExposedSystemFilter(rule.rule_id);
                                                event.stopPropagation();
                                            }}
                                            isActive={headerFilters?.rule === rule?.rule_id}
                                            size="sm"
                                            isInline
                                            variant="secondary"
                                        >
                                            <HashLink
                                                smooth
                                                key={rule.rule_id}
                                                to={
                                                    `/insights/vulnerability/cves/${synopsis}/?rule=${rule.rule_id}#systems-exposed-table-header`
                                                }
                                            >
                                                {
                                                    intl.formatMessage(
                                                        messages.filterByAffectedSystems,
                                                        {
                                                            count: rule.systems_affected ?? -1
                                                        }
                                                    )
                                                }
                                            </HashLink>
                                        </Button>
                                    </TextContent>}
                            </SplitItem>
                        </Split>
                    }>
                        <CardBody className="rule-card-body">
                            <Grid hasGutter>
                                <GridItem md={9} sm={12}>
                                    <Stack hasGutter>
                                        <StackItem>
                                            <CSAwRuleSummary text={rule.summary} />
                                        </StackItem>
                                        <StackItem>
                                            <TextContent>
                                                <Split>
                                                    {rule.rule_impact && (
                                                        <SplitItem>
                                                            <Label className="label pf-v5-u-mb-xs">
                                                                {intl.formatMessage(messages.impact)}
                                                            </Label>
                                                            <Tooltip
                                                                content={Object.values(impactTextList)[rule.rule_impact - 1]}
                                                            >
                                                                <InsightsLabel
                                                                    value={rule.rule_impact}
                                                                    className="severity-label"
                                                                />
                                                            </Tooltip>
                                                        </SplitItem>
                                                    )}
                                                    <SplitItem>
                                                        <Label className="label pf-v5-u-mb-xs">
                                                            {intl.formatMessage(messages.riskOfChange)}
                                                        </Label>
                                                        <Tooltip
                                                            content={RISK_OF_CHANGE_TOOLTIP[rule.change_risk]}
                                                        >
                                                            {RISK_OF_CHANGE_LABEL[rule.change_risk]}
                                                        </Tooltip>
                                                    </SplitItem>
                                                    <SplitItem>
                                                        <Label className="label pf-v5-u-mb-xs">
                                                            {intl.formatMessage(messages.remediationLabel)}
                                                        </Label>
                                                        <Split>
                                                            <SplitItem>
                                                                {!rule.playbook_count
                                                                    ? intl.formatMessage(messages.no)
                                                                    : (
                                                                        <Fragment>
                                                                            <Icon>
                                                                                <CheckCircleIcon
                                                                                    className="checkCircleIcon pf-v5-u-mr-xs"
                                                                                    data-testid="check-circle-icon"
                                                                                />
                                                                            </Icon>
                                                                            {intl.formatMessage(messages.yes)}
                                                                            <Tooltip
                                                                                content={intl.formatMessage(
                                                                                    messages.ansibleRemediationTooltip
                                                                                )}
                                                                            >
                                                                                <Icon>
                                                                                    <OutlinedQuestionCircleIcon
                                                                                        className="l-sm-spacer outlinedQuestionCircleIcon"
                                                                                    />
                                                                                </Icon>
                                                                            </Tooltip>
                                                                        </Fragment>
                                                                    )
                                                                }
                                                            </SplitItem>
                                                            <SplitItem className="pf-v5-u-ml-md">
                                                                {rule.reboot_required &&
                                                                    <Text>
                                                                        <Icon>
                                                                            <PowerOffIcon
                                                                                className="pf-v5-u-mr-xs powerOffIcon"
                                                                                data-testid="power-off-icon"
                                                                            />
                                                                        </Icon>
                                                                        {intl.formatMessage(messages.rebootRequired)}
                                                                    </Text>
                                                                }
                                                            </SplitItem>
                                                        </Split>
                                                    </SplitItem>

                                                </Split>
                                            </TextContent>
                                        </StackItem>

                                        {
                                            rule.kbase_node_id &&
                                            <StackItem>
                                                <TextContent>
                                                    <Text
                                                        className="pf-v5-u-mt-xs"
                                                        component={TextVariants.p}
                                                    >
                                                        <a
                                                            data-testid="kb-link"
                                                            className="kb-link"
                                                            href={`${RH_KB_URL}/${rule.kbase_node_id}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                        >
                                                            {
                                                                intl.formatMessage(messages.knowledgebaseArticle)
                                                            }
                                                            <Icon>
                                                                <ExternalLinkAltIcon
                                                                    className="l-sm-spacer"
                                                                />
                                                            </Icon>
                                                        </a>
                                                    </Text>
                                                </TextContent>
                                            </StackItem>
                                        }

                                    </Stack>
                                </GridItem>
                                <GridItem md={3} sm={12}>
                                    <TextContent>
                                        <Label>
                                            {intl.formatMessage(messages.associatedCves)}
                                        </Label>
                                        <Text component={TextVariants.p} className="pf-v5-u-mt-xs associated-cves">
                                            {synopsis} ({intl.formatMessage(messages.current)})
                                            {
                                                rule.associated_cves
                                                    .filter(cve => cve !== synopsis)
                                                    .map((cve, _i) =>
                                                        <a
                                                            data-testid="associated-cve-link"
                                                            className="associated-cve-link"
                                                            key={_i}
                                                            href={`${CVES_PATH}/${cve}`}
                                                        >
                                                            {cve}
                                                        </a>
                                                    )
                                                    .reduce((prev, curr) => [prev, ', ', curr], [''])
                                            }
                                        </Text>
                                    </TextContent>
                                </GridItem>
                            </Grid>
                        </CardBody>
                    </ExpandableSection>
                </Card>
            )
        ))
    );
};
/*eslint-enable max-len*/

CSAwRuleBox.defaultProps = {
    rules: []
};

CSAwRuleBox.propTypes = {
    intl: PropTypes.any,
    rules: PropTypes.array,
    synopsis: PropTypes.string,
    changeExposedSystemsParameters: PropTypes.func,
    setHeaderFilters: PropTypes.func,
    headerFilters: PropTypes.object
};

export default injectIntl(CSAwRuleBox);
