import propTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import messages from '../../../Messages';
import * as reactRouterDom from 'react-router-dom';
import { useDispatch, useSelector } from 'react-redux';
import * as ReactRedux from 'react-redux';
import { reactCore } from '@redhat-cloud-services/frontend-components-utilities/files/inventoryDependencies';
import {
    Table as PfTable,
    TableBody,
    TableHeader,
    TableGridBreakpoint,
    cellWidth,
    TableVariant,
    sortable,
    expandable,
    SortByDirection
} from '@patternfly/react-table';
import SystemsTableToolbar from './SystemsTableToolbar';
import { SYSTEMS_HEADER, SYSTEMS_ALLOWED_PARAMS, SYSTEMS_SORTING_HEADER } from '../../../Helpers/constants';
import ReducerRegistry from '../../../Utilities/ReducerRegistry';
import { Main } from '@redhat-cloud-services/frontend-components';
import { systemTableRowActions } from '../../../Helpers/CVEHelper';
import React, { useLayoutEffect, useEffect, Fragment, useState, useMemo } from 'react';
import VulnerabilityHeader from '../VulnerabilityHeader/VulnerabilityHeader';
import { fetchSystems, optOutSystemsAction } from '../../../Store/Actions/Actions';
import { addNotification, clearNotifications } from '@redhat-cloud-services/frontend-components-notifications/cjs/actions';
import { inventoryEntitiesReducer } from '../../../Store/Reducers/InventoryEntitiesReducer';
import {
    changeSystemsParams,
    selectMultipleEntities,
    clearSystemStore,
    clearInventoryStore
} from '../../../Store/Actions/Actions';
import { useCreateUrlParams, createSortBy, handleSortColumn } from '../../../Helpers/MiscHelper';
import { GenericError } from '../../PresentationalComponents/EmptyStates/EmptyStates';

const selectHosts = ({ data, meta }, intl) => {
    const items = data && data.map(item => {
        const { cve_count: cveCount, ...rest } = item.attributes;
        return {
            cve_count: (meta.opt_out && intl.formatMessage(messages.systemsTableExcluded)) || cveCount,
            id: item.attributes.inventory_id,
            ...rest
        };
    });
    return items || [];
};

const SystemsPage = ({ intl }) => {
    const [InventoryTable, setInventoryTable] = useState(() => () => <div>Loading...</div>);
    const [createUrlParams, urlParameters] = useCreateUrlParams(SYSTEMS_ALLOWED_PARAMS);
    const [urlParamsAllowed, setUrlParamsAllowed] = useState(false);
    const [isFirstMount, setIsFirstMount] = useState(true);
    const inventory = React.createRef();
    const dispatch = useDispatch();

    const systems = useSelector(({ SystemsPageStore }) => SystemsPageStore.payload);

    const parameters = useSelector(
        ({ SystemsPageStore }) => SystemsPageStore.params
    );

    const metadata = useSelector(
        ({ SystemsPageStore }) => SystemsPageStore.metadata
    );

    const error = useSelector(
        ({ SystemsPageStore }) => SystemsPageStore.error
    );

    const [selectedHosts, setSelectedHosts] = useState(undefined);

    const isLoading =  useSelector(({ SystemsPageStore }) => SystemsPageStore.isLoading);

    const items = useMemo(() => selectHosts(systems, intl), [systems]);

    const loadInventory = async () => {
        const {
            inventoryConnector,
            mergeWithEntities,
            mergeWithDetail
        } = await insights.loadInventory({
            ReactRedux,
            react: React,
            reactRouterDom,
            pfReactTable: {
                Table: PfTable,
                TableBody,
                TableHeader,
                TableGridBreakpoint,
                cellWidth,
                TableVariant,
                sortable,
                expandable,
                SortByDirection
            },
            pfReact: reactCore
        });

        ReducerRegistry.register({
            ...mergeWithEntities(
                inventoryEntitiesReducer(SYSTEMS_HEADER)
            ),
            ...mergeWithDetail()
        });
        const { InventoryTable } = inventoryConnector(ReducerRegistry.getStore());

        setInventoryTable(() => InventoryTable);
    };

    useEffect(() => {

        loadInventory();

        return () => {
            dispatch(clearSystemStore());
            dispatch(clearInventoryStore());
        };
    }, [dispatch]);

    useLayoutEffect(() => {
        insights?.chrome?.hideGlobalFilter?.(false);
    });

    useEffect(()=>{
        if (selectedHosts) {
            dispatch(selectMultipleEntities(selectedHosts));
        }
    }, [selectedHosts, dispatch]);

    const apply = (config) => {
        dispatch(changeSystemsParams(config));
    };

    useEffect(() => {
        dispatch(clearNotifications());
    }, [error, dispatch]);

    //DRY: SystemsExposed page has also the same function
    const inventoryRefresh = ({ page, per_page: pageSize }) => {
        if (metadata.page !== page || metadata.limit !== pageSize) {
            apply({ page, page_size: pageSize });
        }

        if (metadata && metadata.total_items <= pageSize && inventory.current) {
            inventory.current.onRefreshData({ page, page_size: pageSize });
        }
    };

    useEffect(() => {
        if (!inventory.current && isFirstMount) {
            apply(urlParameters);
            setIsFirstMount(false);
        }
        else {
            dispatch(fetchSystems(parameters));
            urlParamsAllowed
                && createUrlParams({ ...parameters })
                || setUrlParamsAllowed(true);
        }
    }, [parameters]);

    const handleSelect = (isChecked, payload) => {
        if (!payload) { payload = []; }

        setSelectedHosts(payload);
    };

    const doOptOut = (systemId = null) => {
        if (selectedHosts && (selectedHosts.length > 0) || systemId) {
            dispatch(optOutSystemsAction(systemId || selectedHosts, !parameters.opt_out)).then(() => {
                dispatch(fetchSystems({ ...parameters, page: 1 }));
                parameters.opt_out === false
                    ? dispatch(addNotification({
                        variant: 'success',
                        title: intl.formatMessage(
                            messages.systemsExcludedNotification,
                            { count: systemId ? 1 : selectedHosts.length || 0 }
                        )
                    }))
                    : dispatch(addNotification({
                        variant: 'success',
                        title: intl.formatMessage(
                            messages.systemsResumedNotificationTitle,
                            { count: systemId ? 1 : selectedHosts.length || 0 }
                        ),
                        description: intl.formatMessage(messages.systemsResumedNotificationBody)
                    }));
                setSelectedHosts([]);
            });
        }
    };

    const sortBy = () =>
        createSortBy(
            SYSTEMS_SORTING_HEADER,
            urlParameters.sort
        );

    const onSort = (event, index, direction) =>
        handleSortColumn(
            index,
            direction,
            SYSTEMS_SORTING_HEADER,
            urlParameters.sort,
            apply
        );

    const processError = () => {
        dispatch(clearNotifications());
        return GenericError;
    };

    return (
        <Fragment>
            <VulnerabilityHeader title={intl.formatMessage(messages.systemsHeader)} showBreadcrumb={false} />
            <Main>
                { InventoryTable && !error && (
                    <InventoryTable
                        tableProps={{
                            isStickyHeader: true,
                            canSelectAll: false,
                            onSort: (items.length > 0) && onSort,
                            sortBy: (items.length > 0) && sortBy()
                        }}
                        showTags
                        isFullView
                        ref={inventory}
                        items={items}
                        page={metadata && metadata.page || 1 }
                        perPage={metadata && metadata.page_size || 20}
                        total={metadata && metadata.total_items || 0}
                        onRefresh={inventoryRefresh}
                        isLoaded = {!isLoading}
                        hasCheckbox={systems.length !== 0}
                        actions={systemTableRowActions(doOptOut, parameters.opt_out)}
                    >
                        {systems.data && (<SystemsTableToolbar
                            parameters = {parameters}
                            systems = {systems}
                            selectedHosts = {selectedHosts || []}
                            methods = {{
                                doOptOut,
                                apply,
                                handleSelect,
                                setSelectedHosts
                            }}
                        />)}
                    </InventoryTable>
                ) || processError() }
            </Main>
        </Fragment>
    );
};

SystemsPage.propTypes  = {
    intl: propTypes.any
};

export default injectIntl(SystemsPage);
