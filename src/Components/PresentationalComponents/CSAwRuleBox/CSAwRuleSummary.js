import React from 'react';
import { marked } from 'marked';
import PropTypes from 'prop-types';
import { injectIntl } from 'react-intl';
import sanitizeHtml from 'sanitize-html';
import { Truncate } from '@redhat-cloud-services/frontend-components/Truncate';
import { StackItem, TextContent } from '@patternfly/react-core';
import { TRUNCATE_TEXT_THRESHOLD } from '../../../Helpers/constants';
import messages from '../../../Messages';

/**
 * extend marked's renderer in order to open link in new tab
 */
let renderer = new marked.Renderer();
renderer.link = function() {
    let link = marked.Renderer.prototype.link.apply(this, arguments);
    return link.replace('<a ', '<a target="_blank" rel="noopener noreferrer" ');
};

marked.setOptions({ renderer });

const CSAwRuleSummary = ({ text, truncate = true, intl, ...props }) => {
    const dangerousHtml = (text) => ({ __html: sanitizeHtml(text) });

    return (text &&
        <StackItem {...props}>
            <TextContent className="rule-description">
                {truncate && text.length > TRUNCATE_TEXT_THRESHOLD
                    ? (
                        <Truncate
                            length={TRUNCATE_TEXT_THRESHOLD}
                            expandText={intl.formatMessage(messages.readMore)}
                            collapseText={intl.formatMessage(messages.readLess)}
                            text={marked(text)}
                            spaceBetween
                        />
                    ) : (
                        <span dangerouslySetInnerHTML={dangerousHtml(marked(text))} />
                    )
                }
            </TextContent>
        </StackItem>
    );
};

CSAwRuleSummary.propTypes = {
    intl: PropTypes.oneOfType([
        PropTypes.string,
        PropTypes.object
    ]),
    truncate: PropTypes.bool,
    text: PropTypes.string.isRequired
};

export default injectIntl(CSAwRuleSummary);
